<!doctype html>
<html lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.2">
<title data-react-helmet="true">1. 导图工具ONNX | 聆思文档中心</title><meta data-react-helmet="true" property="og:url" content="https://github.com/LISTENAI/docs-csk6/AIEcology/Linger/Tools/tool"><meta data-react-helmet="true" name="docusaurus_locale" content="en"><meta data-react-helmet="true" name="docusaurus_version" content="current"><meta data-react-helmet="true" name="docusaurus_tag" content="docs-default-current"><meta data-react-helmet="true" property="og:title" content="1. 导图工具ONNX | 聆思文档中心"><meta data-react-helmet="true" name="description" content="pytorch 动态模型到静态模型"><meta data-react-helmet="true" property="og:description" content="pytorch 动态模型到静态模型"><link data-react-helmet="true" rel="shortcut icon" href="/docs-csk6/img/favicon.ico"><link data-react-helmet="true" rel="canonical" href="https://github.com/LISTENAI/docs-csk6/AIEcology/Linger/Tools/tool"><link data-react-helmet="true" rel="alternate" href="https://github.com/LISTENAI/docs-csk6/AIEcology/Linger/Tools/tool" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://github.com/LISTENAI/docs-csk6/AIEcology/Linger/Tools/tool" hreflang="x-default"><link rel="stylesheet" href="/docs-csk6/assets/css/styles.b048446a.css">
<link rel="preload" href="/docs-csk6/assets/js/runtime~main.2d336c42.js" as="script">
<link rel="preload" href="/docs-csk6/assets/js/main.70a533e0.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div><a href="#main" class="skipToContent_vO2r">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" titleclassname="navbar__title" href="/docs-csk6/"><img src="/docs-csk6/img/logo_light.svg" alt="LSOpen Logo" class="themedImage_K3WP themedImage--light_Fy0T navbar__logo"><img src="/docs-csk6/img/logo_dark.svg" alt="LSOpen Logo" class="themedImage_K3WP themedImage--dark_V9oi navbar__logo"></a><a class="navbar__item navbar__link" href="/docs-csk6/chips/4002/Chip_information_4002">芯片</a><a class="navbar__item navbar__link" href="/docs-csk6/tools/LStudio">工具</a><a class="navbar__item navbar__link" href="/docs-csk6/AIsolution/ESR/Quick_start/Scheme_introduction">AI语音应用方案</a><a class="navbar__item navbar__link" href="/docs-csk6/Industrysolution/Scanning_pen/Scheme_introduction">行业Turnkey解决方案</a></div><div class="navbar__items navbar__items--right"><a class="navbar__item navbar__link" href="/docs-csk6/FAQ/front_page">FAQ</a><a class="navbar__item navbar__link" href="/docs-csk6/school/school">视频课程</a><a class="navbar__item navbar__link" href="/docs-csk6/workorder/workorder">工单</a><div class="react-toggle displayOnlyInLargeViewport_a-w0 react-toggle--disabled"><div class="react-toggle-track" role="button" tabindex="-1"><div class="react-toggle-track-check"><span class="toggle_8pH0"><img src="/docs-csk6/img/light.svg" alt="" class="themedImage_K3WP themedImage--light_Fy0T"><img src="/docs-csk6/img/unlight.svg" alt="" class="themedImage_K3WP themedImage--dark_V9oi"></span></div><div class="react-toggle-track-x"><span class="toggle_8pH0"><img src="/docs-csk6/img/undark.svg" alt="" class="themedImage_K3WP themedImage--light_Fy0T"><img src="/docs-csk6/img/dark.svg" alt="" class="themedImage_K3WP themedImage--dark_V9oi"></span></div></div><input type="checkbox" class="react-toggle-screenreader-only" aria-label="Switch between dark and light mode"></div><div class="navbar__search searchBarContainer_I7kZ"><input placeholder="搜索" aria-label="Search" class="navbar__search-input"><div class="loadingRing_Zg7X searchBarLoadingRing_J5Ez"><div></div><div></div><div></div><div></div></div></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div><div class="navbar-sidebar"><div class="navbar-sidebar__brand"><a class="navbar__brand" titleclassname="navbar__title" href="/docs-csk6/"><img src="/docs-csk6/img/logo_light.svg" alt="LSOpen Logo" class="themedImage_K3WP themedImage--light_Fy0T navbar__logo"><img src="/docs-csk6/img/logo_dark.svg" alt="LSOpen Logo" class="themedImage_K3WP themedImage--dark_V9oi navbar__logo"></a></div><div class="navbar-sidebar__items"><div class="menu"><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" href="/docs-csk6/chips/4002/Chip_information_4002">芯片</a></li><li class="menu__list-item"><a class="menu__link" href="/docs-csk6/tools/LStudio">工具</a></li><li class="menu__list-item"><a class="menu__link" href="/docs-csk6/AIsolution/ESR/Quick_start/Scheme_introduction">AI语音应用方案</a></li><li class="menu__list-item"><a class="menu__link" href="/docs-csk6/Industrysolution/Scanning_pen/Scheme_introduction">行业Turnkey解决方案</a></li><li class="menu__list-item"><a class="menu__link" href="/docs-csk6/FAQ/front_page">FAQ</a></li><li class="menu__list-item"><a class="menu__link" href="/docs-csk6/school/school">视频课程</a></li><li class="menu__list-item"><a class="menu__link" href="/docs-csk6/workorder/workorder">工单</a></li></ul></div></div></div></nav><nav class="navbar subnavbar--fixed-top sub-navbar" style="padding:0"><div class="navbar__inner subnavbar__inner"><div class="navbar__items" style="overflow-x:auto;padding:var(--ifm-navbar-padding-vertical) var(--ifm-navbar-padding-horizontal)"><a class="subnavbar__item subnavbar__link" dirname="/AIEcology" href="/docs-csk6/AIEcology/Intro/intro">总概</a><a aria-current="page" class="subnavbar__item subnavbar__link subnavbar__link--active" dirname="/AIEcology" href="/docs-csk6/AIEcology/Linger/readme">Linger</a><a class="subnavbar__item subnavbar__link" dirname="/AIEcology" href="/docs-csk6/AIEcology/Thinker/readme">Thinker</a></div></div></nav><div class="main-wrapper docs-wrapper doc-page"><div class="docPage_Ol8-"><aside class="docSidebarContainer_UfDv"><div class="sidebar_OMtR"><nav class="menu menu--responsive thin-scrollbar menu_2y2e menuWithAnnouncementBar_Lwkw" aria-label="Sidebar navigation"><button aria-label="Open menu" aria-haspopup="true" class="button button--secondary button--sm menu__button" type="button"><svg class="sidebarMenuIcon_IcOF" width="24" height="24" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><ul class="menu__list"><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--first menu__link--sublist" type="first" href="#!">项目介绍</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs-csk6/AIEcology/Linger/Introduction/intro">功能概述</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs-csk6/AIEcology/Linger/Introduction/quick_start">快速开始</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs-csk6/AIEcology/Linger/Introduction/how_to_use">使用方法</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--first menu__link--sublist" type="first" href="#!">训练框架</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs-csk6/AIEcology/Linger/Training_Framework/compile">编译方法</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs-csk6/AIEcology/Linger/Training_Framework/train_clamp">clamp训练</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs-csk6/AIEcology/Linger/Training_Framework/train_quant">量化训练</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs-csk6/AIEcology/Linger/Training_Framework/operator">算子列表</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs-csk6/AIEcology/Linger/Training_Framework/linger_api">Linger API</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--first menu__link--sublist" type="first" href="#!">功能示例</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs-csk6/AIEcology/Linger/Example/example">功能示例</a></li></ul></li><li class="menu__list-item menu__list-item--current"><a class="menu__link menu__link--first menu__link--sublist menu__link--active" type="first" href="#!">相关工具</a><ul class="menu__list"><li class="menu__list-item"><a aria-current="page" class="menu__link menu__link--active active" tabindex="0" href="/docs-csk6/AIEcology/Linger/Tools/tool">相关工具</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--first menu__link--sublist" type="first" href="#!">贡献内容</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs-csk6/AIEcology/Linger/Contribution/doc">贡献文档说明</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs-csk6/AIEcology/Linger/Contribution/code">贡献代码说明</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--first menu__link--sublist" type="first" href="#!">常见问题</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs-csk6/AIEcology/Linger/FAQ/faq">常见问题</a></li></ul></li><li class="menu__list-item"><a class="menu__link" href="/docs-csk6/AIEcology/Linger/readme">README</a></li></ul></nav></div></aside><main class="docMainContainer_dRYS"><div class="container padding-top--md padding-bottom--lg center-container"><div class="row"><div class="col docItemCol_+xOG"><div class="docItemContainer_c+5G"><article><div class="markdown"><header><h1 class="h1Heading_5RMM">1. 导图工具ONNX</h1></header><p>pytorch 动态模型到静态模型</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_k6ZT" id="11-什么是onnx"></a>1.1 什么是ONNX<a class="hash-link" href="#11-什么是onnx" title="Direct link to heading">#</a></h2><ul><li>Open Neural Network Exchange（ONNX，开放神经网络交换）格式，是一个用于表示深度学习模型的标准，可使模型在不同框架之间进行转移。</li><li>ONNX 为 AI 模型提供开源格式。它定义了可扩展的计算图模型，以及内置运算符和标准数据类型的定义。最初的 ONNX 专注于推理所需的功能 ONNX 解释计算图的可移植，它使用 graph 的序列化格式。它不一定是框架选择在内部使用和操作计算的形式。例如，如果在优化过程中操作更有效，则实现可以在存储器中以不同方式表示模型。</li></ul><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_k6ZT" id="12-如何导出-onnx-模型"></a>1.2 如何导出 ONNX 模型<a class="hash-link" href="#12-如何导出-onnx-模型" title="Direct link to heading">#</a></h2><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_k6ZT" id="121-torch-官方导出-onnx"></a>1.2.1 torch 官方导出 ONNX<a class="hash-link" href="#121-torch-官方导出-onnx" title="Direct link to heading">#</a></h3><p>torch官方提供了从PyTorch导出onnx的接口：</p><div class="codeBlockContainer_9aag"><div class="codeBlockContent_0VPv python"><pre tabindex="0" class="prism-code language-python codeBlock_pSDi thin-scrollbar" style="color:#9CDCFE;background-color:#1E1E1E"><div class="codeBlockLines_sq2l"><span class="token-line" style="color:#9CDCFE"><span class="token plain">torch</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">onnx</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">export</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">model</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> args</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> f</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> export_params</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token boolean">True</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> verbose</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token boolean">False</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> training</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain">TrainingMode</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">EVAL</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> input_names</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token boolean">None</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> output_names</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token boolean">None</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> aten</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token boolean">False</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> export_raw_ir</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token boolean">False</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> operator_export_type</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token boolean">None</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> opset_version</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token boolean">None</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> _retain_param_name</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token boolean">True</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> do_constant_folding</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token boolean">True</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> example_outputs</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token boolean">None</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> strip_doc_string</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token boolean">True</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> dynamic_axes</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token boolean">None</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> keep_initializers_as_inputs</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token boolean">None</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> custom_opsets</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token boolean">None</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> enable_onnx_checker</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token boolean">True</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> use_external_data_format</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token boolean">False</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span></span></div></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Q0gn clean-btn">Copy</button></div></div><p>常用参数：</p><ul><li><code>export_params</code>：该参数默认为True，也就是会导出训练好的权重；若设置为False，则导出的是没有训练过的模型。</li><li><code>verbose</code>：默认为False，若设置为True，则会打印导出onnx时的一些日志，便于分析网络结构。</li><li><code>opset_version</code>：onnx op集合版本号，在linger中通常设置为11或12。</li><li><code>dynamic_axes</code>：可以指定哪些维度是变化的，例如当我们导出模型的时候，输入的第一个维度是batch_size，但是这个维度应该是动态变化的，可以通过该参数指定这个可以动态变化。</li></ul><p>导出的简单示例</p><div class="codeBlockContainer_9aag"><div class="codeBlockContent_0VPv python"><pre tabindex="0" class="prism-code language-python codeBlock_pSDi thin-scrollbar" style="color:#9CDCFE;background-color:#1E1E1E"><div class="codeBlockLines_sq2l"><span class="token-line" style="color:#9CDCFE"><span class="token keyword" style="color:rgb(86, 156, 214)">import</span><span class="token plain"> torch</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">import</span><span class="token plain"> torch</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">onnx</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">torch_model </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> Model</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)"># set the model to inference mode</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">torch_model</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token builtin" style="color:rgb(86, 156, 214)">eval</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">dummy_input </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> torch</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">randn</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token number" style="color:rgb(181, 206, 168)">1</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token number" style="color:rgb(181, 206, 168)">3</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token number" style="color:rgb(181, 206, 168)">244</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token number" style="color:rgb(181, 206, 168)">244</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">torch</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">onnx</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">export</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">torch_model</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain">dummy_input</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;test.onnx&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block">
</span></span></div></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Q0gn clean-btn">Copy</button></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_k6ZT" id="122-使用-linger-导出-onnx"></a>1.2.2 使用 linger 导出 onnx<a class="hash-link" href="#122-使用-linger-导出-onnx" title="Direct link to heading">#</a></h3><p>如果调用<code>linger.init(...)</code>接口后，使用<code>torch.onnx.export</code>会被自动替换为<code>linger.onnx.export</code>进行调用，即<code>torch.onnx.export = linger.onnx.export</code></p><div class="codeBlockContainer_9aag"><div class="codeBlockContent_0VPv python"><pre tabindex="0" class="prism-code language-python codeBlock_pSDi thin-scrollbar" style="color:#9CDCFE;background-color:#1E1E1E"><div class="codeBlockLines_sq2l"><span class="token-line" style="color:#9CDCFE"><span class="token keyword" style="color:rgb(86, 156, 214)">import</span><span class="token plain"> linger</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">linger</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">init</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">torch</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">onnx</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">export</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token comment" style="color:rgb(106, 153, 85)"># 实际上调用的是 linger.onnx.export</span></span></div></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Q0gn clean-btn">Copy</button></div></div><ul><li>导出支持动态输入大小的图</li></ul><div class="codeBlockContainer_9aag"><div class="codeBlockContent_0VPv python"><pre tabindex="0" class="prism-code language-python codeBlock_pSDi thin-scrollbar" style="color:#9CDCFE;background-color:#1E1E1E"><div class="codeBlockLines_sq2l"><span class="token-line" style="color:#9CDCFE"><span class="token plain">torch</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">onnx</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">export</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">torch_model</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain">               </span><span class="token comment" style="color:rgb(106, 153, 85)"># model being run</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                  x</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain">                         </span><span class="token comment" style="color:rgb(106, 153, 85)"># model input (or a tuple for multiple inputs)</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                  </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;super_resolution.onnx&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain">   </span><span class="token comment" style="color:rgb(106, 153, 85)"># where to save the model (can be a file or file-like object)</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                  export_params</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token boolean">True</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain">        </span><span class="token comment" style="color:rgb(106, 153, 85)"># store the trained parameter weights inside the model file</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                  opset_version</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token number" style="color:rgb(181, 206, 168)">12</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain">          </span><span class="token comment" style="color:rgb(106, 153, 85)"># the ONNX version to export the model to</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                  do_constant_folding</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token boolean">True</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain">  </span><span class="token comment" style="color:rgb(106, 153, 85)"># whether to execute constant folding for optimization</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                  input_names </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;input&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain">   </span><span class="token comment" style="color:rgb(106, 153, 85)"># the model&#x27;s input names</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                  output_names </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;output&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token comment" style="color:rgb(106, 153, 85)"># the model&#x27;s output names</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                  dynamic_axes</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;input&#x27;</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token number" style="color:rgb(181, 206, 168)">0</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;batch_size&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain">    </span><span class="token comment" style="color:rgb(106, 153, 85)"># variable lenght axes</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                                </span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;output&#x27;</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token number" style="color:rgb(181, 206, 168)">0</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;batch_size&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span></span></div></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Q0gn clean-btn">Copy</button></div></div><p>其中 dynamic_axes使用有几种形式:</p><ul><li>仅提供索引信息
例如下例子表示 把<code>input_1</code>的<code>0,2,3</code>维作为动态输入，第<code>1</code>仍然保持固定输入，&#x27;input_2&#x27;第<code>0</code>维作为动态输入，<code>output</code>的<code>0,1</code>维作为动态输入，对于动态输入的维度，PyTorch会自动给该维度生成一个名字以替换维度信息</li></ul><div class="codeBlockContainer_9aag"><div class="codeBlockContent_0VPv python"><pre tabindex="0" class="prism-code language-python codeBlock_pSDi thin-scrollbar" style="color:#9CDCFE;background-color:#1E1E1E"><div class="codeBlockLines_sq2l"><span class="token-line" style="color:#9CDCFE"><span class="token plain">dynamic_axes </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;input_1&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token number" style="color:rgb(181, 206, 168)">0</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">2</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">3</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                  </span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;input_2&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token number" style="color:rgb(181, 206, 168)">0</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                  </span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;output&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token number" style="color:rgb(181, 206, 168)">0</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">1</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block">
</span></span></div></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Q0gn clean-btn">Copy</button></div></div><ul><li>对于给定的索引信息，指定名字
对于<code>input_1</code>，指定动态维0、1、2的名字分别为<code>batch</code>、<code>width</code>、<code>height</code>，其他输入同理</li></ul><div class="codeBlockContainer_9aag"><div class="codeBlockContent_0VPv python"><pre tabindex="0" class="prism-code language-python codeBlock_pSDi thin-scrollbar" style="color:#9CDCFE;background-color:#1E1E1E"><div class="codeBlockLines_sq2l"><span class="token-line" style="color:#9CDCFE"><span class="token plain">dynamic_axes </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;input_1&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token number" style="color:rgb(181, 206, 168)">0</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;batch&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                             </span><span class="token number" style="color:rgb(181, 206, 168)">1</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;width&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                             </span><span class="token number" style="color:rgb(181, 206, 168)">2</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;height&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                  </span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;input_2&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token number" style="color:rgb(181, 206, 168)">0</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;batch&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                  </span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;output&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token number" style="color:rgb(181, 206, 168)">0</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;batch&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                            </span><span class="token number" style="color:rgb(181, 206, 168)">1</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;detections&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span></span></div></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Q0gn clean-btn">Copy</button></div></div><ul><li>将上面两者进行混用</li></ul><div class="codeBlockContainer_9aag"><div class="codeBlockContent_0VPv python"><pre tabindex="0" class="prism-code language-python codeBlock_pSDi thin-scrollbar" style="color:#9CDCFE;background-color:#1E1E1E"><div class="codeBlockLines_sq2l"><span class="token-line" style="color:#9CDCFE"><span class="token plain">dynamic_axes </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;input_1&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token number" style="color:rgb(181, 206, 168)">0</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">2</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">3</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                  </span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;input_2&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token number" style="color:rgb(181, 206, 168)">0</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;batch&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                  </span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;output&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token number" style="color:rgb(181, 206, 168)">0</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token number" style="color:rgb(181, 206, 168)">1</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span></span></div></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Q0gn clean-btn">Copy</button></div></div><ul><li>带有可选参数的导出
例如想命名输入输出tensor名字或者比较超前的op可以加上<code>torch.onnx.OperatorExportTypes.ONNX_ATEN_FALLBACK</code></li></ul><div class="codeBlockContainer_9aag"><div class="codeBlockContent_0VPv python"><pre tabindex="0" class="prism-code language-python codeBlock_pSDi thin-scrollbar" style="color:#9CDCFE;background-color:#1E1E1E"><div class="codeBlockLines_sq2l"><span class="token-line" style="color:#9CDCFE"><span class="token keyword" style="color:rgb(86, 156, 214)">import</span><span class="token plain"> torch</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">import</span><span class="token plain"> torch</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">onnx</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">torch_model </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)"># set the model to inference mode</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">torch_model</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token builtin" style="color:rgb(86, 156, 214)">eval</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">dummy_input </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> torch</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">randn</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token number" style="color:rgb(181, 206, 168)">1</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token number" style="color:rgb(181, 206, 168)">3</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token number" style="color:rgb(181, 206, 168)">244</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token number" style="color:rgb(181, 206, 168)">244</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">torch</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">onnx</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">export</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">torch_model</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain">dummy_input</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;test.onnx&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                    opset_version</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token number" style="color:rgb(181, 206, 168)">11</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain">input_names</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;input&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain">output_names</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;output&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain">operator_export_type</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain">torch</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">onnx</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">OperatorExportTypes</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">ONNX_ATEN_FALLBACK</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span></span></div></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Q0gn clean-btn">Copy</button></div></div><ul><li>torch.no_grad()报错
torch 1.6 版本后，需要<code>with torch.no_grad()</code>,即</li></ul><div class="codeBlockContainer_9aag"><div class="codeBlockContent_0VPv python"><pre tabindex="0" class="prism-code language-python codeBlock_pSDi thin-scrollbar" style="color:#9CDCFE;background-color:#1E1E1E"><div class="codeBlockLines_sq2l"><span class="token-line" style="color:#9CDCFE"><span class="token keyword" style="color:rgb(86, 156, 214)">import</span><span class="token plain"> torch</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">import</span><span class="token plain"> torch</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">onnx</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">torch_model </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)"># set the model to inference mode</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">torch_model</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token builtin" style="color:rgb(86, 156, 214)">eval</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">dummy_input </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> torch</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">randn</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token number" style="color:rgb(181, 206, 168)">1</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token number" style="color:rgb(181, 206, 168)">3</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token number" style="color:rgb(181, 206, 168)">244</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token number" style="color:rgb(181, 206, 168)">244</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">with</span><span class="token plain"> torch</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">no_grad</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    torch</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">onnx</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">export</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">torch_model</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain">dummy_input</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;test.onnx&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                        opset_version</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token number" style="color:rgb(181, 206, 168)">11</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain">input_names</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;input&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain">output_names</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;output&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain">operator_export_type</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain">torch</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">onnx</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">OperatorExportTypes</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">ONNX_ATEN_FALLBACK</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span></span></div></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Q0gn clean-btn">Copy</button></div></div><p><code>警告</code>：如果不使用<code>with torch.no_grad()</code>，则会报以下错误</p><blockquote><p>RuntimeError: isDifferentiableType(variable.scalar_type()) INTERNAL ASSERT FAILED at &quot;/pytorch/torch/csrc/autograd/functions/utils.h&quot;:59, please report a bug to PyTorch.</p></blockquote><header><h1 class="h1Heading_5RMM">2. 分析工具</h1></header><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_k6ZT" id="21-wb_analyse-分析工具"></a>2.1 wb_analyse 分析工具<a class="hash-link" href="#21-wb_analyse-分析工具" title="Direct link to heading">#</a></h2><div class="codeBlockContainer_9aag"><div class="codeBlockContent_0VPv python"><pre tabindex="0" class="prism-code language-python codeBlock_pSDi thin-scrollbar" style="color:#9CDCFE;background-color:#1E1E1E"><div class="codeBlockLines_sq2l"><span class="token-line" style="color:#9CDCFE"><span class="token comment" style="color:rgb(106, 153, 85)">#                         原始浮点基线权重 pth          分析日志保存地址</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">linger</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">wb_analyse</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;data.ignore/tool_test.pt&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain">  </span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;data.ignore/wb_anylse.log&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)">#-------------------------------------------------------------------------------------</span></span></div></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Q0gn clean-btn">Copy</button></div></div><p>或者采用如下的方法：</p><div class="codeBlockContainer_9aag"><div class="codeBlockContent_0VPv python"><pre tabindex="0" class="prism-code language-python codeBlock_pSDi thin-scrollbar" style="color:#9CDCFE;background-color:#1E1E1E"><div class="codeBlockLines_sq2l"><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">checkpoint </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> torch</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">load</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;best_checkpoint.pth&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">checkpoint </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> checkpoint</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;state_dict&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)">#                  也可以传入加载后的pth     分析日志保存地址默认为./wb_analyse.log</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">linger</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">wb_analyse</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">checkpoint</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span></span></div></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Q0gn clean-btn">Copy</button></div></div><div class="codeBlockContainer_9aag"><div class="codeBlockContent_0VPv python"><pre tabindex="0" class="prism-code language-python codeBlock_pSDi thin-scrollbar" style="color:#9CDCFE;background-color:#1E1E1E"><div class="codeBlockLines_sq2l"><span class="token-line" style="color:#9CDCFE"><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">&#x27;&#x27;&#x27;</span></span><span class="token-line" style="color:#9CDCFE"><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">日志如下所示  Multiple = Max / Mean , Versu = Max / Dynamic </span></span><span class="token-line" style="color:#9CDCFE"><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">+-------------------------------------------------------+--------------------+--------------------+-----------------+--------------------+-----------------+</span></span><span class="token-line" style="color:#9CDCFE"><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">|                       Layer_name                      |        Mean        |        Max         |     Multiple    |    Dynamic 0.99    |      Versu      |</span></span><span class="token-line" style="color:#9CDCFE"><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">+-------------------------------------------------------+--------------------+--------------------+-----------------+--------------------+-----------------+</span></span><span class="token-line" style="color:#9CDCFE"><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">|               encoder.conv1.conv.weight               |   tensor(0.8093)   |   tensor(4.0748)   |  tensor(5.0348) |   tensor(3.2437)   |  tensor(1.2562) |</span></span><span class="token-line" style="color:#9CDCFE"><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">|                encoder.conv1.conv.bias                |   tensor(0.1000)   |   tensor(0.1000)   |  tensor(1.0000) |   tensor(0.1000)   |    tensor(1.)   |</span></span><span class="token-line" style="color:#9CDCFE"><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">|                encoder.conv1.bn.weight                |   tensor(0.4724)   |   tensor(1.2380)   |  tensor(2.6208) |   tensor(1.0338)   |  tensor(1.1975) |</span></span><span class="token-line" style="color:#9CDCFE"><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">|                 encoder.conv1.bn.bias                 |   tensor(0.3030)   |   tensor(1.9110)   |  tensor(6.3075) |   tensor(1.5030)   |  tensor(1.2714) |</span></span><span class="token-line" style="color:#9CDCFE"><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">|          encoder.conv1.bn.num_batches_tracked         |  tensor(6185962)   |  tensor(6185962)   |    tensor(1.)   |  tensor(6185962)   |    tensor(1.)   |</span></span><span class="token-line" style="color:#9CDCFE"><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">+-------------------------------------------------------+--------------------+--------------------+-----------------+--------------------+-----------------+</span></span><span class="token-line" style="color:#9CDCFE"><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">&#x27;&#x27;&#x27;</span></span></div></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Q0gn clean-btn">Copy</button></div></div><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_k6ZT" id="22-out_analyse-分析工具"></a>2.2 out_analyse 分析工具<a class="hash-link" href="#22-out_analyse-分析工具" title="Direct link to heading">#</a></h2><p><code>(初版，复杂模型可能不适用)</code></p><ul><li>分析网络每一层的输出分布，日志形式同权重分析日志</li></ul><div class="codeBlockContainer_9aag"><div class="codeBlockContent_0VPv python"><pre tabindex="0" class="prism-code language-python codeBlock_pSDi thin-scrollbar" style="color:#9CDCFE;background-color:#1E1E1E"><div class="codeBlockLines_sq2l"><span class="token-line" style="color:#9CDCFE"><span class="token plain">model </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> resnet50</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">cuda</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)">### 加载训练好的浮点checkpoint</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">model</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">load_state_dict</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">checkpoint</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)">### 给定一个网络的真实的典型输入，不要用随机数据</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">typical_input </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> torch</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">randn</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token number" style="color:rgb(181, 206, 168)">1</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token number" style="color:rgb(181, 206, 168)">3</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token number" style="color:rgb(181, 206, 168)">224</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token number" style="color:rgb(181, 206, 168)">224</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">cuda</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">with</span><span class="token plain"> linger</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">Dumper</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">as</span><span class="token plain"> dumper</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token comment" style="color:rgb(106, 153, 85)"># model.eval()</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    dumper</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">analyse_layer_output</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">model</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain">match_pattern</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;root.&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain">   </span><span class="token comment" style="color:rgb(106, 153, 85)"># match_pattern 可支持查看对应哪些层</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    model</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">typical_input</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token comment" style="color:rgb(106, 153, 85)">#跑一遍前向</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    dumper</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">save_out_analyse_log</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">save_log_path</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;Analyse_layer_output.log&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token comment" style="color:rgb(106, 153, 85)">#日志保存路径</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)">## 此接口会在当前目录生成一个名为&quot;Analyse_layer_output.log&quot;的文件</span></span></div></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Q0gn clean-btn">Copy</button></div></div><ul><li>根据日志中Multiple = Max / Mean , Versu = Max / Dynamic0.99 两个的数值进行分析</li><li>一般情况希望输出分布的均值和最值不要相差太大  这两个倍数供参考</li><li>当Versu大于10倍时，说明此层输出的分布最值有明显异常，对量化很不友好  ，日志中会在此层数据下面打印！！！提示</li><li>一般推荐对于异常层来说，对其进行精细的normalize约束设置，向均值方向约束（不代表约束到均值），目的仅为抹除异常的最值即可</li></ul><div class="codeBlockContainer_9aag"><div class="codeBlockContent_0VPv python"><pre tabindex="0" class="prism-code language-python codeBlock_pSDi thin-scrollbar" style="color:#9CDCFE;background-color:#1E1E1E"><div class="codeBlockLines_sq2l"><span class="token-line" style="color:#9CDCFE"><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">&#x27;&#x27;&#x27;</span></span><span class="token-line" style="color:#9CDCFE"><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">日志如下所示  Multiple = Max / Mean , Versu = Max / Dynamic </span></span><span class="token-line" style="color:#9CDCFE"><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">+----------------------------+----------------+-----------------+--------------------+----------------+--------------------+</span></span><span class="token-line" style="color:#9CDCFE"><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">|         Layer_name         |      Mean      |       Max       | Multiple(Max/Mean) |  Dynamic 0.99  | Versu(Max/Dynamic) |</span></span><span class="token-line" style="color:#9CDCFE"><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">+----------------------------+----------------+-----------------+--------------------+----------------+--------------------+</span></span><span class="token-line" style="color:#9CDCFE"><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">|         root.conv1         | tensor(0.7991) |  tensor(4.9494) |   tensor(6.1935)   | tensor(1.6482) |   tensor(3.0028)   |</span></span><span class="token-line" style="color:#9CDCFE"><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">|          root.bn1          | tensor(1.1000) | tensor(11.8600) |  tensor(10.7815)   | tensor(2.5022) |   tensor(4.7399)   |</span></span><span class="token-line" style="color:#9CDCFE"><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">|         root.relu          | tensor(0.4383) |  tensor(7.7810) |  tensor(17.7513)   | tensor(0.8851) |   tensor(8.7912)   |</span></span><span class="token-line" style="color:#9CDCFE"><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">|        root.maxpool        | tensor(0.3245) |  tensor(7.7810) |  tensor(23.9802)   | tensor(0.8358) |   tensor(9.3091)   |</span></span><span class="token-line" style="color:#9CDCFE"><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">|    root.layer1.0.conv1     | tensor(0.7606) |  tensor(7.7810) |  tensor(10.2294)   | tensor(1.4041) |   tensor(5.5418)   |</span></span><span class="token-line" style="color:#9CDCFE"><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">|     root.layer1.0.bn1      | tensor(0.6418) |  tensor(4.2427) |   tensor(6.6106)   | tensor(1.5714) |   tensor(2.7000)   |</span></span><span class="token-line" style="color:#9CDCFE"><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">|     root.layer1.0.relu     | tensor(0.3977) |  tensor(2.7954) |   tensor(7.0291)   | tensor(0.8981) |   tensor(3.1128)   |</span></span><span class="token-line" style="color:#9CDCFE"><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">|    root.layer1.0.conv2     | tensor(0.1164) |  tensor(2.7954) |  tensor(24.0151)   | tensor(0.5088) |   tensor(5.4937)   |</span></span><span class="token-line" style="color:#9CDCFE"><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">+----------------------------+----------------+-----------------+--------------------+----------------+--------------------+</span></span><span class="token-line" style="color:#9CDCFE"><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">&#x27;&#x27;&#x27;</span></span></div></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Q0gn clean-btn">Copy</button></div></div><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_k6ZT" id="23-linger导图错乱及其解决方法"></a>2.3 linger导图错乱及其解决方法<a class="hash-link" href="#23-linger导图错乱及其解决方法" title="Direct link to heading">#</a></h2><p>linger 导出的 onnx 图中 dequant 错乱 或者 图中节点有断裂，可参照下面过程操作</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_k6ZT" id="231-调试选项"></a>2.3.1 调试选项<a class="hash-link" href="#231-调试选项" title="Direct link to heading">#</a></h3><p>torch.onnx.export提供以下选项供调试：</p><ul><li>is_update_dequant = True      # 设为False，关闭添加dequant节点（&amp;删除identity结点）的过程  </li><li>is_scoped_info    = True      # 设为False，关闭添加和删除节点scope name信息的过程  </li><li>debug_dump        = False     # 设为True，保存中间各步的onnx结果，仅供调试使用, （建议使用此选项时不要对以上两个选项做修改）</li></ul><div class="codeBlockContainer_9aag"><div class="codeBlockContent_0VPv python"><pre tabindex="0" class="prism-code language-python codeBlock_pSDi thin-scrollbar" style="color:#9CDCFE;background-color:#1E1E1E"><div class="codeBlockLines_sq2l"><span class="token-line" style="color:#9CDCFE"><span class="token plain">dummy_input </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> torch</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">ones</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token number" style="color:rgb(181, 206, 168)">1</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token number" style="color:rgb(181, 206, 168)">3</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token number" style="color:rgb(181, 206, 168)">224</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token number" style="color:rgb(181, 206, 168)">224</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain">  </span><span class="token comment" style="color:rgb(106, 153, 85)">#模拟输入</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">with</span><span class="token plain"> torch</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">no_grad</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        linger</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">onnx</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">export_debug</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">net</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> dummy_input</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;export_debug.onnx&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain">export_params</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token boolean">True</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain">opset_version</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token number" style="color:rgb(181, 206, 168)">12</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain">operator_export_type</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain">torch</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">onnx</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">OperatorExportTypes</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">ONNX_ATEN_FALLBACK</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain">is_update_dequant </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token boolean">False</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain">is_scoped_info</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token boolean">False</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain">debug_dump</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token boolean">False</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span></span></div></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Q0gn clean-btn">Copy</button></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_k6ZT" id="232-旧版linger导图错误"></a>2.3.2 旧版linger导图错误<a class="hash-link" href="#232-旧版linger导图错误" title="Direct link to heading">#</a></h3><p>当使用旧版linger导出的onnx图中仅有 dequant添加错乱情况 ，可参照下面过程修复</p><ul><li>conda create 新环境 安装最新版linger (方法仅供参考，保证有一个最新版的linger版本即可)</li><li>linger.fix_dequant(ori_onnx, False)   ##原始出错的onnx模型名称 | 是否检测修复后onnxinfer能否运行(设True时需已安装onnxinfer)</li><li>最后将修复好的onnx保存为 后缀多了_fix.onnx</li></ul><div class="codeBlockContainer_9aag"><div class="codeBlockContent_0VPv python"><pre tabindex="0" class="prism-code language-python codeBlock_pSDi thin-scrollbar" style="color:#9CDCFE;background-color:#1E1E1E"><div class="codeBlockLines_sq2l"><span class="token-line" style="color:#9CDCFE"><span class="token comment" style="color:rgb(106, 153, 85)">##                    原始出错的onnx模型名称      | 是否检测修复后onnxinfer能否运行</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">linger</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">fix_dequant</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;dbpagec2_wrong.onnx&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain">            </span><span class="token boolean">False</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span></span></div></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Q0gn clean-btn">Copy</button></div></div></div></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/docs-csk6/AIEcology/Linger/Example/example"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">« 功能示例</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/docs-csk6/AIEcology/Linger/Contribution/doc"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">贡献文档说明 »</div></a></div></nav><div class="gitalk-wrapper"><ul class="gitalk-option"><li class="like"><i class="icon like-icon"></i> <span id="like_num">有帮助  0</span></li><li class="unlike"><i class="icon unlike-icon"></i> <span id="unlike_num">没帮助 0</span></li></ul></div></div></div><div class="col col--3" style="padding-left:0px"><div class="tableOfContents_k96L thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#11-什么是onnx" class="table-of-contents__link">1.1 什么是ONNX</a></li><li><a href="#12-如何导出-onnx-模型" class="table-of-contents__link">1.2 如何导出 ONNX 模型</a><ul><li><a href="#121-torch-官方导出-onnx" class="table-of-contents__link">1.2.1 torch 官方导出 ONNX</a></li><li><a href="#122-使用-linger-导出-onnx" class="table-of-contents__link">1.2.2 使用 linger 导出 onnx</a></li></ul></li><li><a href="#21-wb_analyse-分析工具" class="table-of-contents__link">2.1 wb_analyse 分析工具</a></li><li><a href="#22-out_analyse-分析工具" class="table-of-contents__link">2.2 out_analyse 分析工具</a></li><li><a href="#23-linger导图错乱及其解决方法" class="table-of-contents__link">2.3 linger导图错乱及其解决方法</a><ul><li><a href="#231-调试选项" class="table-of-contents__link">2.3.1 调试选项</a></li><li><a href="#232-旧版linger导图错误" class="table-of-contents__link">2.3.2 旧版linger导图错误</a></li></ul></li></ul></div></div></div></div></main></div></div><footer class="footer"><div class="container"><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 安徽聆思智能科技有限公司皖ICP备05001217号</div></div></div></footer></div>
<script src="/docs-csk6/assets/js/runtime~main.2d336c42.js"></script>
<script src="/docs-csk6/assets/js/main.70a533e0.js"></script>
<script>!function(e,n,s,t,d){e[s]=e[s]||function(){(e[s].a=e[s].a||[]).push(arguments)},(d=n.createElement("script")).async=!0,d.src="https://cdn.jsdelivr.net/simplemde/latest/simplemde.min.js",n.body.appendChild(d)}(window,document,"simplemde")</script></body>
</html>