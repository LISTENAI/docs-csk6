<!doctype html>
<html lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.2">
<title data-react-helmet="true">使用方法 | 聆思文档中心</title><meta data-react-helmet="true" property="og:url" content="https://github.com/LISTENAI/docs-csk6/AIEcology/Linger/Introduction/how_to_use"><meta data-react-helmet="true" name="docusaurus_locale" content="en"><meta data-react-helmet="true" name="docusaurus_version" content="current"><meta data-react-helmet="true" name="docusaurus_tag" content="docs-default-current"><meta data-react-helmet="true" property="og:title" content="使用方法 | 聆思文档中心"><meta data-react-helmet="true" name="description" content="1. 环境配置"><meta data-react-helmet="true" property="og:description" content="1. 环境配置"><link data-react-helmet="true" rel="shortcut icon" href="/docs-csk6/img/favicon.ico"><link data-react-helmet="true" rel="canonical" href="https://github.com/LISTENAI/docs-csk6/AIEcology/Linger/Introduction/how_to_use"><link data-react-helmet="true" rel="alternate" href="https://github.com/LISTENAI/docs-csk6/AIEcology/Linger/Introduction/how_to_use" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://github.com/LISTENAI/docs-csk6/AIEcology/Linger/Introduction/how_to_use" hreflang="x-default"><link rel="stylesheet" href="/docs-csk6/assets/css/styles.b048446a.css">
<link rel="preload" href="/docs-csk6/assets/js/runtime~main.2d336c42.js" as="script">
<link rel="preload" href="/docs-csk6/assets/js/main.70a533e0.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div><a href="#main" class="skipToContent_vO2r">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" titleclassname="navbar__title" href="/docs-csk6/"><img src="/docs-csk6/img/logo_light.svg" alt="LSOpen Logo" class="themedImage_K3WP themedImage--light_Fy0T navbar__logo"><img src="/docs-csk6/img/logo_dark.svg" alt="LSOpen Logo" class="themedImage_K3WP themedImage--dark_V9oi navbar__logo"></a><a class="navbar__item navbar__link" href="/docs-csk6/chips/4002/Chip_information_4002">芯片</a><a class="navbar__item navbar__link" href="/docs-csk6/tools/LStudio">工具</a><a class="navbar__item navbar__link" href="/docs-csk6/AIsolution/ESR/Quick_start/Scheme_introduction">AI语音应用方案</a><a class="navbar__item navbar__link" href="/docs-csk6/Industrysolution/Scanning_pen/Scheme_introduction">行业Turnkey解决方案</a></div><div class="navbar__items navbar__items--right"><a class="navbar__item navbar__link" href="/docs-csk6/FAQ/front_page">FAQ</a><a class="navbar__item navbar__link" href="/docs-csk6/school/school">视频课程</a><a class="navbar__item navbar__link" href="/docs-csk6/workorder/workorder">工单</a><div class="react-toggle displayOnlyInLargeViewport_a-w0 react-toggle--disabled"><div class="react-toggle-track" role="button" tabindex="-1"><div class="react-toggle-track-check"><span class="toggle_8pH0"><img src="/docs-csk6/img/light.svg" alt="" class="themedImage_K3WP themedImage--light_Fy0T"><img src="/docs-csk6/img/unlight.svg" alt="" class="themedImage_K3WP themedImage--dark_V9oi"></span></div><div class="react-toggle-track-x"><span class="toggle_8pH0"><img src="/docs-csk6/img/undark.svg" alt="" class="themedImage_K3WP themedImage--light_Fy0T"><img src="/docs-csk6/img/dark.svg" alt="" class="themedImage_K3WP themedImage--dark_V9oi"></span></div></div><input type="checkbox" class="react-toggle-screenreader-only" aria-label="Switch between dark and light mode"></div><div class="navbar__search searchBarContainer_I7kZ"><input placeholder="搜索" aria-label="Search" class="navbar__search-input"><div class="loadingRing_Zg7X searchBarLoadingRing_J5Ez"><div></div><div></div><div></div><div></div></div></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div><div class="navbar-sidebar"><div class="navbar-sidebar__brand"><a class="navbar__brand" titleclassname="navbar__title" href="/docs-csk6/"><img src="/docs-csk6/img/logo_light.svg" alt="LSOpen Logo" class="themedImage_K3WP themedImage--light_Fy0T navbar__logo"><img src="/docs-csk6/img/logo_dark.svg" alt="LSOpen Logo" class="themedImage_K3WP themedImage--dark_V9oi navbar__logo"></a></div><div class="navbar-sidebar__items"><div class="menu"><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" href="/docs-csk6/chips/4002/Chip_information_4002">芯片</a></li><li class="menu__list-item"><a class="menu__link" href="/docs-csk6/tools/LStudio">工具</a></li><li class="menu__list-item"><a class="menu__link" href="/docs-csk6/AIsolution/ESR/Quick_start/Scheme_introduction">AI语音应用方案</a></li><li class="menu__list-item"><a class="menu__link" href="/docs-csk6/Industrysolution/Scanning_pen/Scheme_introduction">行业Turnkey解决方案</a></li><li class="menu__list-item"><a class="menu__link" href="/docs-csk6/FAQ/front_page">FAQ</a></li><li class="menu__list-item"><a class="menu__link" href="/docs-csk6/school/school">视频课程</a></li><li class="menu__list-item"><a class="menu__link" href="/docs-csk6/workorder/workorder">工单</a></li></ul></div></div></div></nav><nav class="navbar subnavbar--fixed-top sub-navbar" style="padding:0"><div class="navbar__inner subnavbar__inner"><div class="navbar__items" style="overflow-x:auto;padding:var(--ifm-navbar-padding-vertical) var(--ifm-navbar-padding-horizontal)"><a class="subnavbar__item subnavbar__link" dirname="/AIEcology" href="/docs-csk6/AIEcology/Intro/intro">总概</a><a aria-current="page" class="subnavbar__item subnavbar__link subnavbar__link--active" dirname="/AIEcology" href="/docs-csk6/AIEcology/Linger/readme">Linger</a><a class="subnavbar__item subnavbar__link" dirname="/AIEcology" href="/docs-csk6/AIEcology/Thinker/readme">Thinker</a></div></div></nav><div class="main-wrapper docs-wrapper doc-page"><div class="docPage_Ol8-"><aside class="docSidebarContainer_UfDv"><div class="sidebar_OMtR"><nav class="menu menu--responsive thin-scrollbar menu_2y2e menuWithAnnouncementBar_Lwkw" aria-label="Sidebar navigation"><button aria-label="Open menu" aria-haspopup="true" class="button button--secondary button--sm menu__button" type="button"><svg class="sidebarMenuIcon_IcOF" width="24" height="24" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><ul class="menu__list"><li class="menu__list-item menu__list-item--current"><a class="menu__link menu__link--first menu__link--sublist menu__link--active" type="first" href="#!">项目介绍</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs-csk6/AIEcology/Linger/Introduction/intro">功能概述</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs-csk6/AIEcology/Linger/Introduction/quick_start">快速开始</a></li><li class="menu__list-item"><a aria-current="page" class="menu__link menu__link--active active" tabindex="0" href="/docs-csk6/AIEcology/Linger/Introduction/how_to_use">使用方法</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--first menu__link--sublist" type="first" href="#!">训练框架</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs-csk6/AIEcology/Linger/Training_Framework/compile">编译方法</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs-csk6/AIEcology/Linger/Training_Framework/train_clamp">clamp训练</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs-csk6/AIEcology/Linger/Training_Framework/train_quant">量化训练</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs-csk6/AIEcology/Linger/Training_Framework/operator">算子列表</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs-csk6/AIEcology/Linger/Training_Framework/linger_api">Linger API</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--first menu__link--sublist" type="first" href="#!">功能示例</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs-csk6/AIEcology/Linger/Example/example">功能示例</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--first menu__link--sublist" type="first" href="#!">相关工具</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs-csk6/AIEcology/Linger/Tools/tool">相关工具</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--first menu__link--sublist" type="first" href="#!">贡献内容</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs-csk6/AIEcology/Linger/Contribution/doc">贡献文档说明</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs-csk6/AIEcology/Linger/Contribution/code">贡献代码说明</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--first menu__link--sublist" type="first" href="#!">常见问题</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs-csk6/AIEcology/Linger/FAQ/faq">常见问题</a></li></ul></li><li class="menu__list-item"><a class="menu__link" href="/docs-csk6/AIEcology/Linger/readme">README</a></li></ul></nav></div></aside><main class="docMainContainer_dRYS"><div class="container padding-top--md padding-bottom--lg center-container"><div class="row"><div class="col docItemCol_+xOG"><div class="docItemContainer_c+5G"><article><div class="markdown"><header><h1 class="h1Heading_5RMM">使用方法</h1></header><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_k6ZT" id="1-环境配置"></a>1. 环境配置<a class="hash-link" href="#1-环境配置" title="Direct link to heading">#</a></h2><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_k6ZT" id="11-通过源码直接安装"></a>1.1 通过源码直接安装<a class="hash-link" href="#11-通过源码直接安装" title="Direct link to heading">#</a></h2><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_k6ZT" id="111-x86-linux平台"></a>1.1.1 x86-linux平台<a class="hash-link" href="#111-x86-linux平台" title="Direct link to heading">#</a></h3><p>推荐使用conda创建新环境，并使用如下版本的python依赖：</p><ul><li>python 3.7.0</li><li>torch: 1.9.0</li><li>torchvision: 0.10.0</li><li>onnx: 1.7.0</li><li>protobuf: 3.8.0</li></ul><p>一键安装</p><div class="codeBlockContainer_9aag"><div class="codeBlockContent_0VPv sh"><pre tabindex="0" class="prism-code language-sh codeBlock_pSDi thin-scrollbar" style="color:#9CDCFE;background-color:#1E1E1E"><div class="codeBlockLines_sq2l"><span class="token-line" style="color:#9CDCFE"><span class="token plain">git clone https://git-in.iflytek.com/RS_RDG_AI_Group/bitbrain/linger.git</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">cd linger</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">sh install.sh</span></span></div></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Q0gn clean-btn">Copy</button></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_k6ZT" id="11x-其他平台"></a>1.1.x 其他平台<a class="hash-link" href="#11x-其他平台" title="Direct link to heading">#</a></h3><p>即将推出</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_k6ZT" id="12-验证安装"></a>1.2 验证安装<a class="hash-link" href="#12-验证安装" title="Direct link to heading">#</a></h2><div class="codeBlockContainer_9aag"><div class="codeBlockContent_0VPv python"><pre tabindex="0" class="prism-code language-python codeBlock_pSDi thin-scrollbar" style="color:#9CDCFE;background-color:#1E1E1E"><div class="codeBlockLines_sq2l"><span class="token-line" style="color:#9CDCFE"><span class="token plain">Python </span><span class="token number" style="color:rgb(181, 206, 168)">3.7</span><span class="token number" style="color:rgb(181, 206, 168)">.3</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">default</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> Jul </span><span class="token number" style="color:rgb(181, 206, 168)">8</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">2020</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">22</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token number" style="color:rgb(181, 206, 168)">11</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token number" style="color:rgb(181, 206, 168)">17</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">GCC </span><span class="token number" style="color:rgb(181, 206, 168)">7.3</span><span class="token number" style="color:rgb(181, 206, 168)">.0</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> Anaconda</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> Inc</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain"> on linux</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">Type </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;help&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;copyright&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;credits&quot;</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">or</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;license&quot;</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">for</span><span class="token plain"> more information</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token operator" style="color:rgb(212, 212, 212)">&gt;&gt;</span><span class="token operator" style="color:rgb(212, 212, 212)">&gt;</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">import</span><span class="token plain"> linger</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token operator" style="color:rgb(212, 212, 212)">&gt;&gt;</span><span class="token operator" style="color:rgb(212, 212, 212)">&gt;</span><span class="token plain"> </span></span></div></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Q0gn clean-btn">Copy</button></div></div><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_k6ZT" id="13-通过pip安装"></a>1.3 通过pip安装<a class="hash-link" href="#13-通过pip安装" title="Direct link to heading">#</a></h2><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_k6ZT" id="14-通过docker进行安装"></a>1.4 通过docker进行安装<a class="hash-link" href="#14-通过docker进行安装" title="Direct link to heading">#</a></h2><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_k6ZT" id="2-接口使用说明"></a>2 接口使用说明<a class="hash-link" href="#2-接口使用说明" title="Direct link to heading">#</a></h2><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_k6ZT" id="21--基础接口使用说明"></a>2.1  基础接口使用说明<a class="hash-link" href="#21--基础接口使用说明" title="Direct link to heading">#</a></h2><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_k6ZT" id="211-init接口"></a>2.1.1 init接口<a class="hash-link" href="#211-init接口" title="Direct link to heading">#</a></h3><div class="codeBlockContainer_9aag"><div class="codeBlockContent_0VPv python"><pre tabindex="0" class="prism-code language-python codeBlock_pSDi thin-scrollbar" style="color:#9CDCFE;background-color:#1E1E1E"><div class="codeBlockLines_sq2l"><span class="token-line" style="color:#9CDCFE"><span class="token plain">replace_modules </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">nn</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">Conv2d</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> nn</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">ConvTranspose2d</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> nn</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">Linear</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">net </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> linger</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">init</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">net</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> quant_modules</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain">replace_modules</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> mode</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain">linger</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">QuantMode</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">MaxValue</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        data_bits</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token number" style="color:rgb(181, 206, 168)">8</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> parameter_bits</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token number" style="color:rgb(181, 206, 168)">8</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> out_bits</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token number" style="color:rgb(181, 206, 168)">8</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span></span></div></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Q0gn clean-btn">Copy</button></div></div><ul><li>该接口将原始的浮点网络进行module级别的替换成定点网络，可以在替换完成之后打印网络进行观察差别</li><li>quant_modules指明需要量化的module类型，上述示例表明量化三种OP类型，其余OP类型不做量化</li><li>mode参数指明采用的量化方式，包含MaxValue与QValue两种方式，Max方式表示采用最值进行量化，Q值则采用2的幂次进行量化</li><li>data_bits: 指明输入采用的量化bit数， parameter_bits：指明weight采用的量化bit数</li><li>out_bits:输出量化的bit数，针对op输出进行量化，默认参数为None，表明所有OP采用float32输出的混合精度方式，o_bits=8表明输出为int8</li></ul><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_k6ZT" id="212-disable_qunat接口"></a>2.1.2 disable_qunat接口<a class="hash-link" href="#212-disable_qunat接口" title="Direct link to heading">#</a></h3><div class="codeBlockContainer_9aag"><div class="codeBlockContent_0VPv python"><pre tabindex="0" class="prism-code language-python codeBlock_pSDi thin-scrollbar" style="color:#9CDCFE;background-color:#1E1E1E"><div class="codeBlockLines_sq2l"><span class="token-line" style="color:#9CDCFE"><span class="token plain">linger</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">disable_quant</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">net</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">last_fc</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">net </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> linger</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">init</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">net</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span></span></div></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Q0gn clean-btn">Copy</button></div></div><ul><li>该接口指定某些层不做量化操作，通过相应层的module设置即可，该接口需要在init之前使用，没有disable的其他层会采用init的方式进行量化</li><li>该接口主要用于网络最后与loss相关的层，该层不应该做int8的量化操作，否则会增大整体的训练损失,建议一般网络最后一层都采用disable避免量化损失较大</li></ul><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_k6ZT" id="213-quant_module接口"></a>2.1.3 quant_module接口<a class="hash-link" href="#213-quant_module接口" title="Direct link to heading">#</a></h3><div class="codeBlockContainer_9aag"><div class="codeBlockContent_0VPv python"><pre tabindex="0" class="prism-code language-python codeBlock_pSDi thin-scrollbar" style="color:#9CDCFE;background-color:#1E1E1E"><div class="codeBlockLines_sq2l"><span class="token-line" style="color:#9CDCFE"><span class="token plain">linger</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">quant_module</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">net</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">last_fc</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> data_bits</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token number" style="color:rgb(181, 206, 168)">16</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> parameter_bits</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token number" style="color:rgb(181, 206, 168)">16</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> out_bits</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token number" style="color:rgb(181, 206, 168)">32</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">net </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> linger</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">init</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">net</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span></span></div></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Q0gn clean-btn">Copy</button></div></div><ul><li>该接口指定某些层采用特定bit位的量化操作，而不是使用init中的全局配置参数，该接口需要在init之前调用，但是需要注意，某些平台的硬件可能会不支持data_bits和out_bits非8的量化策略如NPU以及Castor平台等</li></ul><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_k6ZT" id="214-自动融合bn接口"></a>2.1.4 自动融合BN接口<a class="hash-link" href="#214-自动融合bn接口" title="Direct link to heading">#</a></h3><div class="codeBlockContainer_9aag"><div class="codeBlockContent_0VPv python"><pre tabindex="0" class="prism-code language-python codeBlock_pSDi thin-scrollbar" style="color:#9CDCFE;background-color:#1E1E1E"><div class="codeBlockLines_sq2l"><span class="token-line" style="color:#9CDCFE"><span class="token plain">linger</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">trace_layers</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">root_model</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain">net</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> target_model</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain">net</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">sub_module</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">x</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain">y</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> fuse_bn</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token boolean">True</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> ahead_conv_relu</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token boolean">True</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain">ahead_bn_relu</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token boolean">True</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain">ahead_linear_relu</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token boolean">True</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">net </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> linger</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">init</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">net</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">**</span><span class="token operator" style="color:rgb(212, 212, 212)">*</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span></span></div></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Q0gn clean-btn">Copy</button></div></div><ul><li>该接口主要用于量化训练过程消除BN结构，加速推理过程，同时统计相关OP+ReLU的节点，量化统计scale过程采用正值操作</li><li>root_model表示原始的model，target_model为需要融合BN的子model，(x, y)为子model的输入，多个输入的情况下采用元组包括</li><li>fuse_bn表示是否需要融合BN，False表示不融合，True表示融合操作, ahead_conv_relu表明是否针对conv-relu结构统计conv的scale_o采用正值方向，其余参数配置含义一致</li><li>该接口需要在init之前调用，同时只能执行一次，目前不允许网络trace多个部分,建议放在所有配置操作的最前面</li></ul><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_k6ZT" id="215-参数加载接口"></a>2.1.5 参数加载接口<a class="hash-link" href="#215-参数加载接口" title="Direct link to heading">#</a></h3><div class="codeBlockContainer_9aag"><div class="codeBlockContent_0VPv python"><pre tabindex="0" class="prism-code language-python codeBlock_pSDi thin-scrollbar" style="color:#9CDCFE;background-color:#1E1E1E"><div class="codeBlockLines_sq2l"><span class="token-line" style="color:#9CDCFE"><span class="token comment" style="color:rgb(106, 153, 85)"># inline操作</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">net </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> linger</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">init</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">net</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">net</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">load_state_dict</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">torch</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">load</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;**.pt&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span></span></div></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Q0gn clean-btn">Copy</button></div></div><ul><li>参数加载的方式与标准的浮点加载一致，load_state_dict调用需要在init之后调用，不支持直接访问net.state_dict()进行参数匹配操作，如有需求，建议直接在外面针对参数名称进行修改,之后调用标准的load_state_dict接口操作</li></ul><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_k6ZT" id="16-查表量化训练接口"></a>1.6 查表量化训练接口<a class="hash-link" href="#16-查表量化训练接口" title="Direct link to heading">#</a></h3><div class="codeBlockContainer_9aag"><div class="codeBlockContent_0VPv python"><pre tabindex="0" class="prism-code language-python codeBlock_pSDi thin-scrollbar" style="color:#9CDCFE;background-color:#1E1E1E"><div class="codeBlockLines_sq2l"><span class="token-line" style="color:#9CDCFE"><span class="token plain">net </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> net</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">init</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">net</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">**</span><span class="token operator" style="color:rgb(212, 212, 212)">*</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span></span></div></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Q0gn clean-btn">Copy</button></div></div><ul><li>参数主要用于配置lstmint， gruint等时序网络中的sigmoid, tanh等函数的查表操作</li></ul><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_k6ZT" id="3-进阶接口使用说明"></a>3. 进阶接口使用说明<a class="hash-link" href="#3-进阶接口使用说明" title="Direct link to heading">#</a></h2><ul><li><p>一般情况下基础接口能解决大部分问题，也是我们常用的，进阶接口是在效果存在损失时才会用到的</p></li><li><p>直接量化具有较大损失，可能数据分布存在奇异值的问题，通过在量化训练中添加normalize功能约束整体的数据分布，统计截断之后的scale,避免奇异值的影响</p></li><li><p>normalize_layers 动态设置特定层不同的normalize 策略,目前只针对Conv2(1)d, Linear, ConvTranspose2d有效，时许模型不支持</p></li></ul><div class="codeBlockContainer_9aag"><div class="codeBlockContent_0VPv"><pre tabindex="0" class="prism-code language-undefined codeBlock_pSDi thin-scrollbar" style="color:#9CDCFE;background-color:#1E1E1E"><div class="codeBlockLines_sq2l"><span class="token-line" style="color:#9CDCFE"><span class="token plain">linger.trace_layers(net, net.trace_module, (x, y), fuse_bn=True)</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">linger.disable_normalize(net.last_fc)</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">normalize_modules = (nn.Conv2d,nn.Linear)</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">linger.normalize_module(net.mid_conv, normalize_weight_value=16, normalize_bias_value=16, normalize_output_value=16)</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">net = linger.normalize_layers(net, normalize_modules = normalize_modules, normalize_weight_value=8, normalize_bias_value=8, normalize_output_value=8) #normalize_dynamic_percent参数目前只推荐调试定位异常层时使用，不推荐实际训练时使用</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">linger.disable_quant(net.last_fc)</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">quant_modules = (nn.Conv2d, nn.Linear)</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">net = linger.init(net, quant_modules = quant_modules, ...)</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">//load_state_dict操作</span></span></div></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Q0gn clean-btn">Copy</button></div></div><ul><li>通过normalize_layers配置全局的normalize数值，disable_normalize用于设置某一层不做normalize操作，</li><li>normalize_module用于配置某一层采用特定的normalize数值进行约束</li><li>init之后会将normalize之后的网络的normalize数值代入量化OP中，从而实现动态配置相关normalize数值的功能</li></ul><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_k6ZT" id="4-算子替换"></a>4 算子替换<a class="hash-link" href="#4-算子替换" title="Direct link to heading">#</a></h2><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_k6ZT" id="41-lstmp"></a>4.1 LSTMP<a class="hash-link" href="#41-lstmp" title="Direct link to heading">#</a></h3><ul><li>linger中实现LSTMP、UBLSTMP与asr-extension封装的lstmp有不同门的顺序也不同</li><li>注意pytorch-asr-extension库中的LSTMP为( input_dim, cell_num, hidden_size ) 本实现为（input_size, hidden_size, cell_size )  注意交换位置</li><li>首先本实现中lstmp只支持batch_first  而且只与asr中lstmp封装的c++ 代码保持一致多余的clip_mask等操作  需要显式保留写出来  </li><li>若输入为 T<em>B</em>D  则应 transpose 后 再进本实现的lstmp  输出同样  </li><li>还有如果lstmp输入有initial_state, 则 应当为 (1, batch_size, hidden_size) 和 (1, batch_size, cell_size)  （若batchsize不为1，也可直接传（batch_size, hidden_size) 和 (batch_size, cell_size)）</li><li>可参照下方  修改checkpoint的门的顺序, 去掉最后四个fc的key修改即可  </li></ul><div class="codeBlockContainer_9aag"><div class="codeBlockContent_0VPv python"><pre tabindex="0" class="prism-code language-python codeBlock_pSDi thin-scrollbar" style="color:#9CDCFE;background-color:#1E1E1E"><div class="codeBlockLines_sq2l"><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">checkpoint </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> torch</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">load</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;state_dict.pt&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain">  </span><span class="token comment" style="color:rgb(106, 153, 85)">#original checkpoint</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">model_dict </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">for</span><span class="token plain"> k</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain">v </span><span class="token keyword" style="color:rgb(86, 156, 214)">in</span><span class="token plain"> checkpoint</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">items</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token keyword" style="color:rgb(86, 156, 214)">if</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;weight_x&#x27;</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">in</span><span class="token plain"> k</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        new_key </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> k</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">replace</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;weight_x&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;input_linearity.weight&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        v_chunk </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> v</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">chunk</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token number" style="color:rgb(181, 206, 168)">4</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">0</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        v </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> torch</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">cat</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">v_chunk</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token number" style="color:rgb(181, 206, 168)">0</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> v_chunk</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token number" style="color:rgb(181, 206, 168)">1</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> v_chunk</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token number" style="color:rgb(181, 206, 168)">3</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> v_chunk</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token number" style="color:rgb(181, 206, 168)">2</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> dim</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token number" style="color:rgb(181, 206, 168)">0</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token keyword" style="color:rgb(86, 156, 214)">elif</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;weight_bias&#x27;</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">in</span><span class="token plain"> k</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        new_key </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> k</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">replace</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;weight_bias&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;input_linearity.bias&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        v_chunk </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> v</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">chunk</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token number" style="color:rgb(181, 206, 168)">4</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">1</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        v </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> torch</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">cat</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">v_chunk</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token number" style="color:rgb(181, 206, 168)">0</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> v_chunk</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token number" style="color:rgb(181, 206, 168)">1</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> v_chunk</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token number" style="color:rgb(181, 206, 168)">3</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> v_chunk</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token number" style="color:rgb(181, 206, 168)">2</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> dim</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token number" style="color:rgb(181, 206, 168)">1</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token keyword" style="color:rgb(86, 156, 214)">elif</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;weight_r&#x27;</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">in</span><span class="token plain"> k</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        new_key </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> k</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">replace</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;weight_r&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;state_linearity.weight&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        v_chunk </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> v</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">chunk</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token number" style="color:rgb(181, 206, 168)">4</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">0</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        v </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> torch</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">cat</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">v_chunk</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token number" style="color:rgb(181, 206, 168)">0</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> v_chunk</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token number" style="color:rgb(181, 206, 168)">1</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> v_chunk</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token number" style="color:rgb(181, 206, 168)">3</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> v_chunk</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token number" style="color:rgb(181, 206, 168)">2</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> dim</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token number" style="color:rgb(181, 206, 168)">0</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token keyword" style="color:rgb(86, 156, 214)">elif</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;weight_p&#x27;</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">in</span><span class="token plain"> k</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        new_key </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> k</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">replace</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;weight_p&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;state_projection.weight&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token keyword" style="color:rgb(86, 156, 214)">else</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        new_key </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> k</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token comment" style="color:rgb(106, 153, 85)"># print(&#x27;new_key: &#x27;, new_key)</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token keyword" style="color:rgb(86, 156, 214)">if</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;weight_bias&#x27;</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">in</span><span class="token plain"> k</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        model_dict</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">new_key</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> v</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">data</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">reshape</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token operator" style="color:rgb(212, 212, 212)">-</span><span class="token number" style="color:rgb(181, 206, 168)">1</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token keyword" style="color:rgb(86, 156, 214)">else</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        model_dict</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">new_key</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> v</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">data</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">net</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">load_state_dict</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">model_dict</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain">  </span><span class="token comment" style="color:rgb(106, 153, 85)">##load replaced checkpoint</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block">
</span></span></div></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Q0gn clean-btn">Copy</button></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_k6ZT" id="42-noralizefastlstmp"></a>4.2 NoralizeFastLSTMP<a class="hash-link" href="#42-noralizefastlstmp" title="Direct link to heading">#</a></h3><ul><li>本实现中NormalizeFastLSTMP 直接移植了torch的nn.LSTM实现过来与asr-extension封装的lstmp有不同门的顺序也不同</li><li>注意pytorch-asr-extension库中的LSTMP为( input_dim, cell_num, hidden_size )    intx中的普通LSTMP为（input_size, hidden_size, cell_size )  注意交换位置</li><li>而 NormalizeFastLSTMP 继承的torch的nn.LSTM实现中为( input_dim, hidden_size, proj_size )</li><li>nn.LSTM在torch1.9及之后多了一个proj_size的参数(以下统称nn.LSTMP)，默认为0，即为原始的lstm，&gt;0即对应LSTMP实现</li><li>Note : 必须在torch1.9.0及以后版本  才生效 ！！！</li></ul><div class="codeBlockContainer_9aag"><div class="codeBlockContent_0VPv python"><pre tabindex="0" class="prism-code language-python codeBlock_pSDi thin-scrollbar" style="color:#9CDCFE;background-color:#1E1E1E"><div class="codeBlockLines_sq2l"><span class="token-line" style="color:#9CDCFE"><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">&quot;&quot;&quot;</span></span><span class="token-line" style="color:#9CDCFE"><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">( input_dim, hidden_size, proj_size ) </span></span><span class="token-line" style="color:#9CDCFE"><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">+--------------------------+-----------------------------------------+</span></span><span class="token-line" style="color:#9CDCFE"><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">|   pytorch-asr-extension  |  ( input_dim, hidden_size, proj_size )   |</span></span><span class="token-line" style="color:#9CDCFE"><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">+==========================+=========================================+</span></span><span class="token-line" style="color:#9CDCFE"><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">|    intx中的普通LSTMP      |  ( input_dim, proj_size, hidden_size )   |</span></span><span class="token-line" style="color:#9CDCFE"><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">+--------------------------+-----------------------------------------+</span></span><span class="token-line" style="color:#9CDCFE"><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">|  NormalizeFastLSTMP(nn.LSTM) |  ( input_dim, hidden_size, proj_size )   |</span></span><span class="token-line" style="color:#9CDCFE"><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">+--------------------------+-----------------------------------------+</span></span><span class="token-line" style="color:#9CDCFE"><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">&quot;&quot;&quot;</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)">#从nn.LSTMP 转为 intx普通LSTMP的 逻辑</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)">#注意nn.LSTMP 中会比普通的LSTMP多一个bias的参数，从nn.LSTMP 转为 intx普通LSTMP时，注意将bias_ih_l0和bias_hh_l0 相加 赋给input_linearity.bias， 反向同理</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)">#而从intx普通LSTMP 转为 nn.LSTMP时，注意input_linearity.bias直接赋给bias_ih_l0，bias_hh_l0直接置零值， 反向同理</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">for</span><span class="token plain"> k</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain">v </span><span class="token keyword" style="color:rgb(86, 156, 214)">in</span><span class="token plain"> checkpoint</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">items</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token keyword" style="color:rgb(86, 156, 214)">if</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;weight_ih_l0&#x27;</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">in</span><span class="token plain"> k </span><span class="token keyword" style="color:rgb(86, 156, 214)">and</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;reverse&#x27;</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">not</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">in</span><span class="token plain"> k</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        new_key </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> k</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">replace</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;weight_ih_l0&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;input_linearity.weight&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token keyword" style="color:rgb(86, 156, 214)">elif</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;bias_ih_l0&#x27;</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">in</span><span class="token plain"> k </span><span class="token keyword" style="color:rgb(86, 156, 214)">and</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;reverse&#x27;</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">not</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">in</span><span class="token plain"> k</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        new_key </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> k</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">replace</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;bias_ih_l0&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;input_linearity.bias&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        v </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> v</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">unsqueeze</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token number" style="color:rgb(181, 206, 168)">0</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        bias </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> v</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token keyword" style="color:rgb(86, 156, 214)">elif</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;weight_hh_l0&#x27;</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">in</span><span class="token plain"> k </span><span class="token keyword" style="color:rgb(86, 156, 214)">and</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;reverse&#x27;</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">not</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">in</span><span class="token plain"> k</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        new_key </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> k</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">replace</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;weight_hh_l0&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;state_linearity.weight&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token keyword" style="color:rgb(86, 156, 214)">elif</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;weight_hr_l0&#x27;</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">in</span><span class="token plain"> k </span><span class="token keyword" style="color:rgb(86, 156, 214)">and</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;reverse&#x27;</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">not</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">in</span><span class="token plain"> k</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        new_key </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> k</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">replace</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;weight_hr_l0&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;state_projection.weight&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token keyword" style="color:rgb(86, 156, 214)">elif</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;bias_hh_l0&#x27;</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">in</span><span class="token plain"> k </span><span class="token keyword" style="color:rgb(86, 156, 214)">and</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;reverse&#x27;</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">not</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">in</span><span class="token plain"> k</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        new_key </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> k</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">replace</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;bias_hh_l0&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;input_linearity.bias&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        v </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> v</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">unsqueeze</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token number" style="color:rgb(181, 206, 168)">0</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        bias </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> v </span><span class="token operator" style="color:rgb(212, 212, 212)">+</span><span class="token plain"> bias</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token keyword" style="color:rgb(86, 156, 214)">elif</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;lstmp.weight_ih_l0_reverse&#x27;</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">in</span><span class="token plain"> k</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        new_key </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> k</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">replace</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;lstmp.weight_ih_l0_reverse&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;lstmp2.input_linearity.weight&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token keyword" style="color:rgb(86, 156, 214)">elif</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;lstmp.bias_ih_l0_reverse&#x27;</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">in</span><span class="token plain"> k</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        new_key </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> k</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">replace</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;lstmp.bias_ih_l0_reverse&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;lstmp2.input_linearity.bias&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        v </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> v</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">unsqueeze</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token number" style="color:rgb(181, 206, 168)">0</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        bias </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> v</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token keyword" style="color:rgb(86, 156, 214)">elif</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;lstmp.weight_hh_l0_reverse&#x27;</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">in</span><span class="token plain"> k</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        new_key </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> k</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">replace</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;lstmp.weight_hh_l0_reverse&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;lstmp2.state_linearity.weight&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token keyword" style="color:rgb(86, 156, 214)">elif</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;lstmp.weight_hr_l0_reverse&#x27;</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">in</span><span class="token plain"> k</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        new_key </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> k</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">replace</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;lstmp.weight_hr_l0_reverse&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;lstmp2.state_projection.weight&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token keyword" style="color:rgb(86, 156, 214)">elif</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;lstmp.bias_hh_l0_reverse&#x27;</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">in</span><span class="token plain"> k</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        new_key </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> k</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">replace</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;lstmp.bias_hh_l0_reverse&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;lstmp2.input_linearity.bias&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        v </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> v</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">unsqueeze</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token number" style="color:rgb(181, 206, 168)">0</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        bias </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> v </span><span class="token operator" style="color:rgb(212, 212, 212)">+</span><span class="token plain"> bias</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token keyword" style="color:rgb(86, 156, 214)">else</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        new_key </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> k</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token keyword" style="color:rgb(86, 156, 214)">if</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;bias_hh_l0&#x27;</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">in</span><span class="token plain"> k </span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        model_dict</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">new_key</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> bias</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">data</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">reshape</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token operator" style="color:rgb(212, 212, 212)">-</span><span class="token number" style="color:rgb(181, 206, 168)">1</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token keyword" style="color:rgb(86, 156, 214)">else</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        model_dict</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">new_key</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> v</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">data</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block">
</span></span></div></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Q0gn clean-btn">Copy</button></div></div><div class="codeBlockContainer_9aag"><div class="codeBlockContent_0VPv python"><pre tabindex="0" class="prism-code language-python codeBlock_pSDi thin-scrollbar" style="color:#9CDCFE;background-color:#1E1E1E"><div class="codeBlockLines_sq2l"><span class="token-line" style="color:#9CDCFE"><span class="token comment" style="color:rgb(106, 153, 85)">#双向LSTMP替换</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">input_size </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">100</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">hidden_size </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">100</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">cell_num </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">50</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)"># self.lstmp = nn.LSTM(input_size, hidden_size, num_layers=1, batch_first=True, bidirectional=True, proj_size = 50)</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">self</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">lstmp </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> linger</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">LSTMP</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token number" style="color:rgb(181, 206, 168)">100</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">50</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">100</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> batch_first</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token boolean">True</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> go_forward</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token boolean">True</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">self</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">lstmp2 </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> linger</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">LSTMP</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token number" style="color:rgb(181, 206, 168)">100</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">50</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">100</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> batch_first</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token boolean">True</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> go_forward</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token boolean">False</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block">
</span></span></div></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Q0gn clean-btn">Copy</button></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_k6ZT" id="43-fasturlstmp"></a>4.3 FastURLSTMP<a class="hash-link" href="#43-fasturlstmp" title="Direct link to heading">#</a></h3><ul><li><p>本实现中FastUBLSTMP 中直接移植了torch最新版的nn.LSTM实现过来 正反向的lstmp都通过nn.LSTM来变相实现</p></li><li><p>Note : 必须在torch1.9.0及以后版本才生效</p></li><li><p>以下为intx普通UBLSTMP到FASTUBLSTMP的state_dict key替换逻辑仅供参考</p></li></ul><div class="codeBlockContainer_9aag"><div class="codeBlockContent_0VPv python"><pre tabindex="0" class="prism-code language-python codeBlock_pSDi thin-scrollbar" style="color:#9CDCFE;background-color:#1E1E1E"><div class="codeBlockLines_sq2l"><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">checkpoint </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> torch</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">load</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;dump_ub/torch_ublstmp.pt&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">model_dict </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">bias </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token boolean">None</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">for</span><span class="token plain"> k</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain">v </span><span class="token keyword" style="color:rgb(86, 156, 214)">in</span><span class="token plain"> checkpoint</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">items</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token keyword" style="color:rgb(86, 156, 214)">if</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;backward_lstmp&quot;</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">in</span><span class="token plain"> k </span><span class="token keyword" style="color:rgb(86, 156, 214)">or</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;forward_lstmp&quot;</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">in</span><span class="token plain"> k</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        </span><span class="token keyword" style="color:rgb(86, 156, 214)">if</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;input_linearity.weight&#x27;</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">in</span><span class="token plain"> k</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            new_key </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> k</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">replace</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;input_linearity.weight&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;weight_ih_l0&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        </span><span class="token keyword" style="color:rgb(86, 156, 214)">elif</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;input_linearity.bias&#x27;</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">in</span><span class="token plain"> k</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            new_key </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> k</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">replace</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;input_linearity.bias&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;bias_ih_l0&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            bias </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> v</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            zeros_bias </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> torch</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">zeros_like</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">bias</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain">  </span><span class="token comment" style="color:rgb(106, 153, 85)">##给予bias_hh_l0 以全0值</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            new_key_2 </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> k</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">replace</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;input_linearity.bias&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;bias_hh_l0&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            model_dict</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">new_key_2</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> zeros_bias</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">data</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        </span><span class="token keyword" style="color:rgb(86, 156, 214)">elif</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;state_linearity.weight&#x27;</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">in</span><span class="token plain"> k</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            new_key </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> k</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">replace</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;state_linearity.weight&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;weight_hh_l0&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        </span><span class="token keyword" style="color:rgb(86, 156, 214)">elif</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;state_projection.weight&#x27;</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">in</span><span class="token plain"> k</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            new_key </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> k</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">replace</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;state_projection.weight&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;weight_hr_l0&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        </span><span class="token keyword" style="color:rgb(86, 156, 214)">else</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            new_key </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> k</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        model_dict</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">new_key</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> v</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">data</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token keyword" style="color:rgb(86, 156, 214)">else</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        model_dict</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">k</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> v</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">net</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">load_state_dict</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">model_dict</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block">
</span></span></div></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Q0gn clean-btn">Copy</button></div></div></div></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/docs-csk6/AIEcology/Linger/Introduction/quick_start"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">« 快速开始</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/docs-csk6/AIEcology/Linger/Training_Framework/compile"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">编译方法 »</div></a></div></nav><div class="gitalk-wrapper"><ul class="gitalk-option"><li class="like"><i class="icon like-icon"></i> <span id="like_num">有帮助  0</span></li><li class="unlike"><i class="icon unlike-icon"></i> <span id="unlike_num">没帮助 0</span></li></ul></div></div></div><div class="col col--3" style="padding-left:0px"><div class="tableOfContents_k96L thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#1-环境配置" class="table-of-contents__link">1. 环境配置</a></li><li><a href="#11-通过源码直接安装" class="table-of-contents__link">1.1 通过源码直接安装</a><ul><li><a href="#111-x86-linux平台" class="table-of-contents__link">1.1.1 x86-linux平台</a></li><li><a href="#11x-其他平台" class="table-of-contents__link">1.1.x 其他平台</a></li></ul></li><li><a href="#12-验证安装" class="table-of-contents__link">1.2 验证安装</a></li><li><a href="#13-通过pip安装" class="table-of-contents__link">1.3 通过pip安装</a></li><li><a href="#14-通过docker进行安装" class="table-of-contents__link">1.4 通过docker进行安装</a></li><li><a href="#2-接口使用说明" class="table-of-contents__link">2 接口使用说明</a></li><li><a href="#21--基础接口使用说明" class="table-of-contents__link">2.1  基础接口使用说明</a><ul><li><a href="#211-init接口" class="table-of-contents__link">2.1.1 init接口</a></li><li><a href="#212-disable_qunat接口" class="table-of-contents__link">2.1.2 disable_qunat接口</a></li><li><a href="#213-quant_module接口" class="table-of-contents__link">2.1.3 quant_module接口</a></li><li><a href="#214-自动融合bn接口" class="table-of-contents__link">2.1.4 自动融合BN接口</a></li><li><a href="#215-参数加载接口" class="table-of-contents__link">2.1.5 参数加载接口</a></li><li><a href="#16-查表量化训练接口" class="table-of-contents__link">1.6 查表量化训练接口</a></li></ul></li><li><a href="#3-进阶接口使用说明" class="table-of-contents__link">3. 进阶接口使用说明</a></li><li><a href="#4-算子替换" class="table-of-contents__link">4 算子替换</a><ul><li><a href="#41-lstmp" class="table-of-contents__link">4.1 LSTMP</a></li><li><a href="#42-noralizefastlstmp" class="table-of-contents__link">4.2 NoralizeFastLSTMP</a></li><li><a href="#43-fasturlstmp" class="table-of-contents__link">4.3 FastURLSTMP</a></li></ul></li></ul></div></div></div></div></main></div></div><footer class="footer"><div class="container"><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 安徽聆思智能科技有限公司皖ICP备05001217号</div></div></div></footer></div>
<script src="/docs-csk6/assets/js/runtime~main.2d336c42.js"></script>
<script src="/docs-csk6/assets/js/main.70a533e0.js"></script>
<script>!function(e,n,s,t,d){e[s]=e[s]||function(){(e[s].a=e[s].a||[]).push(arguments)},(d=n.createElement("script")).async=!0,d.src="https://cdn.jsdelivr.net/simplemde/latest/simplemde.min.js",n.body.appendChild(d)}(window,document,"simplemde")</script></body>
</html>