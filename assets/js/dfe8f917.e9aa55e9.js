"use strict";(self.webpackChunkls_docs_web=self.webpackChunkls_docs_web||[]).push([[8953],{3905:(e,t,n)=>{n.d(t,{Zo:()=>d,kt:()=>p});var r=n(67294);function i(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function a(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function o(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?a(Object(n),!0).forEach((function(t){i(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):a(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function s(e,t){if(null==e)return{};var n,r,i=function(e,t){if(null==e)return{};var n,r,i={},a=Object.keys(e);for(r=0;r<a.length;r++)n=a[r],t.indexOf(n)>=0||(i[n]=e[n]);return i}(e,t);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);for(r=0;r<a.length;r++)n=a[r],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(i[n]=e[n])}return i}var l=r.createContext({}),u=function(e){var t=r.useContext(l),n=t;return e&&(n="function"==typeof e?e(t):o(o({},t),e)),n},d=function(e){var t=u(e.components);return r.createElement(l.Provider,{value:t},e.children)},c={inlineCode:"code",wrapper:function(e){var t=e.children;return r.createElement(r.Fragment,{},t)}},k=r.forwardRef((function(e,t){var n=e.components,i=e.mdxType,a=e.originalType,l=e.parentName,d=s(e,["components","mdxType","originalType","parentName"]),k=u(n),p=i,m=k["".concat(l,".").concat(p)]||k[p]||c[p]||a;return n?r.createElement(m,o(o({ref:t},d),{},{components:n})):r.createElement(m,o({ref:t},d))}));function p(e,t){var n=arguments,i=t&&t.mdxType;if("string"==typeof e||i){var a=n.length,o=new Array(a);o[0]=k;var s={};for(var l in t)hasOwnProperty.call(t,l)&&(s[l]=t[l]);s.originalType=e,s.mdxType="string"==typeof e?e:i,o[1]=s;for(var u=2;u<a;u++)o[u]=n[u];return r.createElement.apply(null,o)}return r.createElement.apply(null,n)}k.displayName="MDXCreateElement"},37720:(e,t,n)=>{n.r(t),n.d(t,{contentTitle:()=>o,default:()=>d,frontMatter:()=>a,metadata:()=>s,toc:()=>l});var r=n(87462),i=(n(67294),n(3905));const a={},o="\u5de5\u4f5c\u961f\u5217\u7ebf\u7a0b",s={unversionedId:"chips/600X/kernel/workqueue",id:"chips/600X/kernel/workqueue",isDocsHomePage:!1,title:"\u5de5\u4f5c\u961f\u5217\u7ebf\u7a0b",description:"A workqueue is a kernel object that uses a dedicated thread to process work items in a first in, first out manner. Each work item is processed by calling the function specified by the work item. A workqueue is typically used by an ISR or a high-priority thread to offload non-urgent processing to a lower-priority thread so it does not impact time-sensitive processing.",source:"@site/docs/chips/600X/kernel/workqueue.md",sourceDirName:"chips/600X/kernel",slug:"/chips/600X/kernel/workqueue",permalink:"/docs-csk6/chips/600X/kernel/workqueue",version:"current",frontMatter:{},sidebar:"docs/chips/600X",previous:{title:"\u7cfb\u7edf\u7ebf\u7a0b",permalink:"/docs-csk6/chips/600X/kernel/system_threads"},next:{title:"\u4e2d\u65ad",permalink:"/docs-csk6/chips/600X/kernel/interrupts"}},l=[{value:"\u5de5\u4f5c\u9879\u751f\u547d\u5468\u671f",id:"\u5de5\u4f5c\u9879\u751f\u547d\u5468\u671f",children:[]},{value:"\u53ef\u5ef6\u8fdf\u5de5\u4f5c",id:"\u53ef\u5ef6\u8fdf\u5de5\u4f5c",children:[]},{value:"\u53ef\u89e6\u53d1\u5de5\u4f5c",id:"\u53ef\u89e6\u53d1\u5de5\u4f5c",children:[]},{value:"\u7cfb\u7edf\u5de5\u4f5c\u961f\u5217",id:"\u7cfb\u7edf\u5de5\u4f5c\u961f\u5217",children:[]}],u={toc:l};function d(e){let{components:t,...n}=e;return(0,i.kt)("wrapper",(0,r.Z)({},u,n,{components:t,mdxType:"MDXLayout"}),(0,i.kt)("h1",{id:"\u5de5\u4f5c\u961f\u5217\u7ebf\u7a0b"},"\u5de5\u4f5c\u961f\u5217\u7ebf\u7a0b"),(0,i.kt)("p",null,"A workqueue is a kernel object that uses a dedicated thread to process work items in a first in, first out manner. Each work item is processed by calling the function specified by the work item. A workqueue is typically used by an ISR or a high-priority thread to offload non-urgent processing to a lower-priority thread so it does not impact time-sensitive processing."),(0,i.kt)("p",null,"\u5de5\u4f5c\u961f\u5217(workqueue )\u662f\u4e00\u4e2a\u4f7f\u7528\u7279\u5b9a\u7ebf\u7a0b\u6765\u8fd0\u884c\u5de5\u4f5c\u9879(work items)\u7684\u5185\u6838\u5bf9\u8c61\uff0c\u5176\u65b9\u5f0f\u4e3a\u5148\u8fdb\u5148\u51fa\uff0c\u901a\u8fc7\u8c03\u7528\u5de5\u4f5c\u9879\u6307\u5b9a\u7684\u51fd\u6570\u6765\u5904\u7406\u6bcf\u4e2a\u5de5\u4f5c\u9879\u3002\u5de5\u4f5c\u961f\u5217\u7684\u5178\u578b\u5e94\u7528\u662f\u5728ISR\u6216\u8005\u9ad8\u4f18\u5148\u7ea7\u7ebf\u7a0b\u4e2d\u53bb\u5206\u62c5\u90e8\u5206\u5de5\u4f5c\u5230\u4e00\u4e2a\u4f4e\u4f18\u5148\u7ea7\u7684\u7ebf\u7a0b\u4e2d\uff0c\u5176\u76ee\u7684\u662f\u51cf\u5c11ISR\u6216\u9ad8\u4f18\u5148\u7ea7\u7ebf\u7a0b\u7684\u5904\u7406\u65f6\u957f\uff0c\u6240\u4ee5\u5b83\u4e0d\u5f71\u54cd\u65f6\u95f4\u654f\u611f\u7684\u5904\u7406\u3002"),(0,i.kt)("p",null,"Any number of workqueues can be defined (limited only by available RAM). Each workqueue is referenced by its memory address."),(0,i.kt)("p",null,"\u53ef\u4ee5\u5b9a\u4e49\u65e0\u4e0a\u9650\u7684\u5de5\u4f5c\u961f\u5217(\u4ec5\u53d7RAM\u9650\u5236)\u3002\u6bcf\u4e2a\u5de5\u4f5c\u961f\u5217\u901a\u8fc7\u5730\u5740\u5f15\u7528\u3002"),(0,i.kt)("p",null,"A workqueue has the following key properties:"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"A\xa0",(0,i.kt)("strong",{parentName:"li"},"queue"),"\xa0of work items that have been added, but not yet processed."),(0,i.kt)("li",{parentName:"ul"},"A\xa0",(0,i.kt)("strong",{parentName:"li"},"thread"),"\xa0that processes the work items in the queue. The priority of the thread is configurable, allowing it to be either cooperative or preemptive as required.")),(0,i.kt)("p",null,"\u5de5\u4f5c\u961f\u5217\u6709\u4e0b\u5217\u5173\u952e\u5c5e\u6027\uff1a"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"\u4e00\u4e2a\u7528\u4e8e\u5b58\u653e\u5df2\u6dfb\u52a0\u4f46\u672a\u6267\u884c\u5de5\u4f5c\u9879\u7684\u961f\u5217\u3002"),(0,i.kt)("li",{parentName:"ul"},"\u4e00\u4e2a\u5904\u7406\u961f\u5217\u4e2d\u7684\u5de5\u4f5c\u9879\u7684\u7ebf\u7a0b\u3002\u8be5\u7ebf\u7a0b\u7684\u4f18\u5148\u7ea7\u662f\u53ef\u4ee5\u914d\u7f6e\u7684\uff0c\u5141\u8bb8\u4e3a\u534f\u4f5c\u5f0f\u7ebf\u7a0b\u6216\u62a2\u5360\u5f0f\u7ebf\u7a0b\u3002")),(0,i.kt)("p",null,"Regardless of workqueue thread priority the workqueue thread will yield between each submitted work item, to prevent a cooperative workqueue from starving other threads."),(0,i.kt)("p",null,"\u4e0d\u7ba1\u5de5\u4f5c\u961f\u5217\u4f18\u5148\u7ea7\u5982\u4f55\uff0c\u5de5\u4f5c\u961f\u5217\u7ebf\u7a0b\u5c06\u5728\u63d0\u4ea4\u5de5\u4f5c\u9879\u4e4b\u540e\u8fdb\u884c\u8ba9\u51fa(yield)CPU\uff0c\u9632\u6b62\u534f\u4f5c\u5f0f\u5de5\u4f5c\u961f\u5217\u997f\u6b7b\u5176\u4ed6\u7ebf\u7a0b\u3002"),(0,i.kt)("p",null,"A workqueue must be initialized before it can be used. This sets its queue to empty and spawns the workqueue\u2019s thread. The thread runs forever, but sleeps when no work items are available."),(0,i.kt)("p",null,"\u5de5\u4f5c\u961f\u5217\u5fc5\u987b\u5728\u4f7f\u7528\u524d\u521d\u59cb\u5316\u3002\u5de5\u4f5c\u961f\u5217\u521b\u5efa\u65f6\u4f1a\u6e05\u7a7a\u961f\u5217\u548c\u521b\u5efa\u4e00\u4e2a\u5de5\u4f5c\u961f\u5217\u7684\u7ebf\u7a0b\u3002\u8fd9\u4e2a\u7ebf\u7a0b\u5728\u6ca1\u6709\u5de5\u4f5c\u9879\u65f6\u7761\u7720\uff0c\u5176\u4ed6\u65f6\u95f4\u5904\u4e8e\u5c31\u7eea\u6001\u3002"),(0,i.kt)("h2",{id:"\u5de5\u4f5c\u9879\u751f\u547d\u5468\u671f"},"\u5de5\u4f5c\u9879\u751f\u547d\u5468\u671f"),(0,i.kt)("p",null,"Any number of\xa0",(0,i.kt)("strong",{parentName:"p"},"work items"),"\xa0can be defined. Each work item is referenced by its memory address."),(0,i.kt)("p",null,"\u53ef\u4ee5\u5b9a\u4e49\u65e0\u4e0a\u9650\u7684\u5de5\u4f5c\u9879\u3002\u6bcf\u4e2a\u5de5\u4f5c\u9879\u53ef\u4ee5\u901a\u8fc7\u5730\u5740\u8fdb\u884c\u5f15\u7528\u3002"),(0,i.kt)("p",null,"A work item is assigned a\xa0",(0,i.kt)("strong",{parentName:"p"},"handler function"),", which is the function executed by the workqueue\u2019s thread when the work item is processed. This function accepts a single argument, which is the address of the work item itself. The work item also maintains information about its status."),(0,i.kt)("p",null,"\u6bcf\u4e2a\u5de5\u4f5c\u9879\u90fd\u88ab\u5206\u914d\u4e00\u4e2a\u5904\u7406\u51fd\u6570(handler function)\uff0c\u8fd9\u662f\u5de5\u4f5c\u961f\u5217\u7ebf\u7a0b\u5728\u6267\u884c\u5de5\u4f5c\u9879\u65f6\u6267\u884c\u7684\u51fd\u6570\u3002\u5904\u7406\u51fd\u6570\u552f\u4e00\u7684\u5f62\u53c2\u5c31\u662f\u5de5\u4f5c\u9879\u53e5\u67c4\uff0c\u53ef\u5728\u5de5\u4f5c\u9879\u53e5\u67c4\u4e2d\u83b7\u53d6\u5de5\u4f5c\u9879\u72b6\u6001\u3002"),(0,i.kt)("p",null,"A work item must be initialized before it can be used. This records the work item\u2019s handler function and marks it as not pending."),(0,i.kt)("p",null,"\u5de5\u4f5c\u9879\u5fc5\u987b\u5728\u4f7f\u7528\u524d\u521d\u59cb\u5316\u3002\u521d\u59cb\u5316\u65f6\u5de5\u4f5c\u9879\u65f6\u4f1a\u5206\u914d\u5904\u7406\u51fd\u6570\uff0c\u7136\u540e\u6807\u8bb0\u4e3a\u672a\u5b8c\u6210\u3002"),(0,i.kt)("p",null,"A work item may be queued (K_WORK_QUEUED) by submitting it to a workqueue by an ISR or a thread. Submitting a work item appends the work item to the workqueue\u2019s queue. "),(0,i.kt)("p",null,"\u5728ISR\u6216\u7ebf\u7a0b\u4e2d\uff0c\u5de5\u4f5c\u9879\u53ef\u88ab\u6dfb\u52a0\u5230\u5de5\u4f5c\u961f\u5217\u4e2d\uff0c\u6b64\u65f6\u5de5\u4f5c\u9879\u5904\u4e8e",(0,i.kt)("inlineCode",{parentName:"p"},"K_WORK_QUEUED")," \u72b6\u6001\u3002"),(0,i.kt)("p",null,"Once the workqueue\u2019s thread has processed all of the preceding work items in its queue the thread will remove the next work item from the queue and invoke the work item\u2019s handler function. "),(0,i.kt)("p",null,"\u4e00\u65e6\u5de5\u4f5c\u961f\u5217\u7684\u7ebf\u7a0b\u5904\u7406\u5b8c\u5176\u961f\u5217\u4e2d\u6240\u6709\u524d\u9762\u7684\u5de5\u4f5c\u9879\uff0c\u8be5\u7ebf\u7a0b\u5c06\u4ece\u5de5\u4f5c\u961f\u5217\u4e2d\u79fb\u9664\u4e0b\u4e00\u4e2a\u5de5\u4f5c\u9879\u5e76\u8c03\u7528\u8be5\u5de5\u4f5c\u9879\u7684\u5904\u7406\u51fd\u6570\u3002"),(0,i.kt)("p",null,"Depending on the scheduling priority of the workqueue\u2019s thread, and the work required by other items in the queue, a queued work item may be processed quickly or it may remain in the queue for an extended period of time."),(0,i.kt)("p",null,"\u6839\u636e\u5de5\u4f5c\u961f\u5217\u7ebf\u7a0b\u7684\u8c03\u5ea6\u4f18\u5148\u7ea7\uff0c\u4ee5\u53ca\u961f\u5217\u4e2d\u5176\u4ed6\u5de5\u4f5c\u9879\u6240\u9700\u7684\u65f6\u95f4\u957f\u77ed\uff0c\u90a3\u4e48\u961f\u5217\u4e2d\u7684\u5de5\u4f5c\u9879\u53ef\u80fd\u88ab\u8fc5\u901f\u5904\u7406\uff0c\u4e5f\u53ef\u80fd\u5728\u961f\u5217\u4e2d\u505c\u7559\u8f83\u957f\u7684\u4e00\u6bb5\u65f6\u95f4\u3002"),(0,i.kt)("p",null,"A delayable work item may be scheduled (K_WORK_DELAYED) to a workqueue; see Delayable Work."),(0,i.kt)("p",null,"\u5de5\u4f5c\u9879\u53ef\u4ee5\u6807\u8bb0\u4e3a\u5ef6\u8fdf\u5de5\u4f5c\u9879(",(0,i.kt)("inlineCode",{parentName:"p"},"K_WORK_DELAYED"),")\uff0c\u53c2\u8003\u53ef\u5ef6\u8fdf\u5de5\u4f5c\u3002"),(0,i.kt)("p",null,"A work item will be running (K_WORK_RUNNING) when it is running on a work queue, and may also be canceling (K_WORK_CANCELING) if it started running before a thread has requested that it be cancelled."),(0,i.kt)("p",null,"\u5f53\u5de5\u4f5c\u961f\u5217\u6b63\u5728\u8fd0\u884c\u65f6\uff0c\u5de5\u4f5c\u9879\u53ef\u88ab\u6267\u884c(",(0,i.kt)("inlineCode",{parentName:"p"},"K_WORK_RUNNING"),")\u3002\u5982\u679c\u8be5\u5de5\u4f5c\u9879\u8fd8\u672a\u88ab\u6267\u884c\uff0c\u4e5f\u53ef\u88ab\u53d6\u6d88(",(0,i.kt)("inlineCode",{parentName:"p"},"K_WORK_CANCELING"),")\u3002"),(0,i.kt)("p",null,"A work item can be in multiple states; for example it can be:"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"running on a queue;"),(0,i.kt)("li",{parentName:"ul"},"marked canceling (because a thread used\xa0",(0,i.kt)("strong",{parentName:"li"},(0,i.kt)("inlineCode",{parentName:"strong"},"[k_work_cancel_sync()](https://docs.zephyrproject.org/latest/kernel/services/threads/workqueue.html#c.k_work_cancel_sync)")),"\xa0to wait until the work item completed);"),(0,i.kt)("li",{parentName:"ul"},"queued to run again on the same queue;"),(0,i.kt)("li",{parentName:"ul"},"scheduled to be submitted to a (possibly different) queue")),(0,i.kt)("p",null,"\u5de5\u4f5c\u9879\u53ef\u5904\u4e8e\u591a\u79cd\u72b6\u6001\uff0c\u6bd4\u5982\u8bf4\uff1a"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"\u6807\u8bb0\u4e3a\u8fd0\u884c(",(0,i.kt)("inlineCode",{parentName:"li"},"K_WORK_RUNNING"),")"),(0,i.kt)("li",{parentName:"ul"},"\u6807\u8bb0\u4e3a\u53d6\u6d88(",(0,i.kt)("inlineCode",{parentName:"li"},"K_WORK_CANCELING"),")"),(0,i.kt)("li",{parentName:"ul"},"\u5728\u76f8\u540c\u961f\u5217\u4e2d\u518d\u6b21\u8fd0\u884c"),(0,i.kt)("li",{parentName:"ul"},"\u8ba1\u5212\u63d0\u4ea4\u5230\u961f\u5217\u4e2d")),(0,i.kt)("p",null,"all simultaneously. A work item that is in any of these states is pending (k_work_is_pending()) or busy (k_work_busy_get())."),(0,i.kt)("p",null,"\u53ef\u4ee5\u901a\u8fc7",(0,i.kt)("inlineCode",{parentName:"p"},"k_work_is_pending()")," \u6216",(0,i.kt)("inlineCode",{parentName:"p"},"k_work_busy_get()")," \u83b7\u53d6\u5de5\u4f5c\u9879\u72b6\u6001\u3002"),(0,i.kt)("p",null,"A handler function can use any kernel API available to threads. However, operations that are potentially blocking (e.g. taking a semaphore) must be used with care, since the workqueue cannot process subsequent work items in its queue until the handler function finishes executing."),(0,i.kt)("p",null,"\u5904\u7406\u51fd\u6570\u53ef\u4ee5\u8c03\u7528\u4efb\u4f55\u9002\u7528\u4e8e\u7ebf\u7a0b\u7684\u5185\u6838API\u3002\u4f46\u662f\uff0c\u5e26\u963b\u585e\u76f8\u5173\u7684\u63a5\u53e3(\u5982",(0,i.kt)("inlineCode",{parentName:"p"},"k_sem_take"),")\u9700\u8981\u659f\u914c\u4f7f\u7528\u3002\u8fd9\u662f\u56e0\u4e3a\uff0c\u5728\u5f53\u524d\u5904\u7406\u51fd\u6570\u6267\u884c\u5b8c\u6210\u4e4b\u524d\uff0c\u5de5\u4f5c\u961f\u5217\u65e0\u6cd5\u5904\u7406\u5176\u961f\u5217\u4e2d\u7684\u540e\u7eed\u5de5\u4f5c\u9879\u3002"),(0,i.kt)("p",null,"The single argument that is passed to a handler function can be ignored if it is not required. If the handler function requires additional information about the work it is to perform, the work item can be embedded in a larger data structure. The handler function can then use the argument value to compute the address of the enclosing data structure with CONTAINER_OF, and thereby obtain access to the additional information it needs."),(0,i.kt)("p",null,"\u6839\u636e\u5b9e\u9645\u9700\u6c42\uff0c\u9009\u62e9\u6027\u4f7f\u7528\u5904\u7406\u51fd\u6570\u7684\u5f62\u53c2\u3002\u5982\u679c\u5904\u7406\u51fd\u6570\u9700\u8981\u66f4\u591a\u7684\u4fe1\u606f\uff0c\u53ef\u4ee5\u5c06\u5de5\u4f5c\u9879\u53e5\u67c4\u4f5c\u4e3a\u7ed3\u6784\u4f53\u6210\u5458\u3002\u5904\u7406\u51fd\u6570\u8c03\u7528",(0,i.kt)("inlineCode",{parentName:"p"},"CONTAINER_OF")," \u5b8f\u83b7\u53d6\u5230\u7ed3\u6784\u4f53\u5730\u5740\uff0c\u4ece\u800c\u83b7\u53d6\u66f4\u591a\u7684\u4fe1\u606f\u3002"),(0,i.kt)("p",null,"A work item is typically initialized once and then submitted to a specific workqueue whenever work needs to be performed. If an ISR or a thread attempts to submit a work item that is already queued the work item is not affected; the work item remains in its current place in the workqueue\u2019s queue, and the work is only performed once."),(0,i.kt)("p",null,"\u4e00\u4e2a\u5de5\u4f5c\u9879\u76ee\u901a\u5e38\u88ab\u521d\u59cb\u5316\u4e00\u6b21\uff0c\u5728\u9700\u8981\u6267\u884c\u5de5\u4f5c\u9879\u65f6\u63d0\u4ea4\u7ed9\u5de5\u4f5c\u961f\u5217\u3002\u63d0\u4ea4\u4e00\u4e2a\u5df2\u7ecf\u5728\u5de5\u4f5c\u961f\u5217\u4e2d\u5de5\u4f5c\u9879\u662f\u4e0d\u4f1a\u4ea7\u751f\u4efb\u4f55\u5f71\u54cd\uff0c\u4e0d\u4f1a\u5f71\u54cd\u8be5\u5de5\u4f5c\u9879\u5728\u5de5\u4f5c\u961f\u5217\u4e2d\u7684\u4f4d\u7f6e\uff0c\u5e76\u4e14\u53ea\u4f1a\u6267\u884c\u4e00\u6b21\u3002"),(0,i.kt)("p",null,"A handler function is permitted to re-submit its work item argument to the workqueue, since the work item is no longer queued at that time. This allows the handler to execute work in stages, without unduly delaying the processing of other work items in the workqueue\u2019s queue."),(0,i.kt)("p",null,"\u5728\u5de5\u4f5c\u9879\u6267\u884c\u5b8c\u6210\u4ee5\u540e\uff0c\u5de5\u4f5c\u9879\u5141\u8bb8\u91cd\u65b0\u5206\u914d\u5904\u7406\u51fd\u6570\uff0c\u5728\u4e0d\u540c\u9636\u6bb5\u65f6\u5206\u914d\u4e0d\u540c\u7684\u5904\u7406\u51fd\u6570\uff0c\u80fd\u907f\u514d\u5de5\u4f5c\u961f\u5217\u4e2d\u6709\u5197\u4f59\u7684\u5de5\u4f5c\u9879\u3002"),(0,i.kt)("h2",{id:"\u53ef\u5ef6\u8fdf\u5de5\u4f5c"},"\u53ef\u5ef6\u8fdf\u5de5\u4f5c"),(0,i.kt)("p",null,"An ISR or a thread may need to schedule a work item that is to be processed only after a specified period of time, rather than immediately. This can be done by scheduling a delayable work item to be submitted to a workqueue at a future time."),(0,i.kt)("p",null,"\u5982\u679c\u5728ISR\u6216\u7ebf\u7a0b\u4e2d\u9700\u8981\u8c03\u5ea6\u4e00\u4e2a\u5de5\u4f5c\u9879\u5728\u6307\u5b9a\u5468\u671f\u540e\u6267\u884c\uff0c\u90a3\u4e48\u901a\u8fc7\u53ef\u5ef6\u8fdf\u7684\u5de5\u4f5c\u9879(delayable work item)\u5728\u5c06\u6765\u7684\u67d0\u4e2a\u65f6\u95f4\u63d0\u4ea4\u5230\u5de5\u4f5c\u961f\u5217\u4e2d\u5b8c\u6210\u3002"),(0,i.kt)("p",null,"A delayable work item contains a standard work item but adds fields that record when and where the item should be submitted."),(0,i.kt)("p",null,"\u4e00\u4e2a\u53ef\u5ef6\u8fdf\u5de5\u4f5c\u9879\u7ed3\u6784\u5728\u6807\u51c6\u5de5\u4f5c\u9879\u7ed3\u6784\u7684\u57fa\u7840\u4e0a\u989d\u5916\u6dfb\u52a0\u5b57\u6bb5\uff0c\u7528\u4e8e\u63cf\u8ff0\u4f55\u65f6\u5c06\u5de5\u4f5c\u9879\u6dfb\u52a0\u5230\u6307\u5b9a\u7684\u961f\u5217\u3002"),(0,i.kt)("p",null,"A delayable work item is initialized and scheduled to a workqueue in a similar manner to a standard work item, although different kernel APIs are used. "),(0,i.kt)("p",null,"\u53ef\u5ef6\u8fdf\u5de5\u4f5c\u9879\u7684\u521d\u59cb\u5316\u548c\u6392\u5230\u5de5\u4f5c\u961f\u5217\u4e2d\u7684\u884c\u4e3a\u4e0e\u6807\u51c6\u5de5\u4f5c\u9879\u4e00\u81f4\uff0c\u53ea\u662f\u8c03\u7528\u7684\u5185\u6838API\u4e0d\u540c\u3002"),(0,i.kt)("p",null,"When the schedule request is made the kernel initiates a timeout mechanism that is triggered after the specified delay has elapsed. Once the timeout occurs the kernel submits the work item to the specified workqueue, where it remains queued until it is processed in the standard manner."),(0,i.kt)("p",null,"\u5f53\u53d1\u51fa\u8be5\u5de5\u4f5c\u961f\u5217\u7684\u8c03\u5ea6\u8bf7\u6c42\u540e\uff0c\u5185\u6838\u542f\u52a8\u8d85\u65f6\u673a\u5236\uff0c\u5728\u6307\u5b9a\u7684\u5ef6\u8fdf\u540e\u88ab\u89e6\u53d1\u3002\u4e00\u65e6\u8d85\u65f6\u53d1\u751f\uff0c\u5185\u6838\u5c31\u4f1a\u628a\u5de5\u4f5c\u9879\u76ee\u63d0\u4ea4\u7ed9\u6307\u5b9a\u7684\u5de5\u4f5c\u961f\u5217\uff0c\u5de5\u4f5c\u9879\u4e00\u76f4\u88ab\u6392\u5728\u5de5\u4f5c\u961f\u5217\u4e2d\uff0c\u4ee5\u6807\u51c6\u5de5\u4f5c\u9879\u65b9\u5f0f\u88ab\u5904\u7406\u3002"),(0,i.kt)("p",null,"Note that work handler used for delayable still receives a pointer to the underlying non-delayable work structure, which is not publicly accessible from k_work_delayable. To get access to an object that contains the delayable work object use this idiom:"),(0,i.kt)("p",null,"\u5ef6\u8fdf\u5de5\u4f5c\u9879\u5904\u7406\u51fd\u6570\u7684\u5f62\u53c2\u662f\u6807\u51c6\u5de5\u4f5c\u9879\u53e5\u67c4\uff0c\u5982\u679c\u60f3\u83b7\u53d6\u5ef6\u8fdf\u5de5\u4f5c\u9879\u7684\u53e5\u67c4\uff0c\u9700\u8981\u4f7f\u7528\u5982\u4e0b\u65b9\u6cd5\uff1a"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-c"},"static void work_handler(struct k_work *work)\n{\n        struct k_work_delayable *dwork = k_work_delayable_from_work(work);\n        struct work_context *ctx = CONTAINER_OF(dwork, struct work_context,\n                                                timed_work);\n        ...\n")),(0,i.kt)("h2",{id:"\u53ef\u89e6\u53d1\u5de5\u4f5c"},"\u53ef\u89e6\u53d1\u5de5\u4f5c"),(0,i.kt)("p",null,"\u56e0\u4e3ak_poll\u4e3aP2\uff0c\u6545\u6682\u4e0d\u8bd1\u8be5\u90e8\u5206\u3002"),(0,i.kt)("h2",{id:"\u7cfb\u7edf\u5de5\u4f5c\u961f\u5217"},"\u7cfb\u7edf\u5de5\u4f5c\u961f\u5217"),(0,i.kt)("p",null,"The kernel defines a workqueue known as the\xa0",(0,i.kt)("em",{parentName:"p"},"system workqueue"),", which is available to any application or kernel code that requires workqueue support. The system workqueue is optional, and only exists if the application makes use of it."),(0,i.kt)("p",null,"\u5185\u6838\u5b9a\u4e49\u4e86\u7cfb\u7edf\u5de5\u4f5c\u961f\u5217\uff0c\u7528\u4e8e\u4efb\u4f55\u5e94\u7528\u6216\u8005\u5185\u6838\u4ee3\u7801\u3002\u7cfb\u7edf\u5de5\u4f5c\u961f\u5217\u662f\u53ef\u9009\u9879\uff0c\u53ea\u6709\u5728\u5e94\u7528\u7a0b\u5e8f\u4f7f\u7528\u5b83\u7684\u60c5\u51b5\u4e0b\u624d\u5b58\u5728\u3002"),(0,i.kt)("div",{className:"admonition admonition-note alert alert--secondary"},(0,i.kt)("div",{parentName:"div",className:"admonition-heading"},(0,i.kt)("h5",{parentName:"div"},(0,i.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,i.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"14",height:"16",viewBox:"0 0 14 16"},(0,i.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"}))),"note")),(0,i.kt)("div",{parentName:"div",className:"admonition-content"},(0,i.kt)("p",{parentName:"div"},"Additional workqueues should only be defined when it is not possible to submit new work items to the system workqueue, since each new workqueue incurs a significant cost in memory footprint. A new workqueue can be justified if it is not possible for its work items to co-exist with existing system workqueue work items without an unacceptable impact; for example, if the new work items perform blocking operations that would delay other system workqueue processing to an unacceptable degree."))),(0,i.kt)("div",{className:"admonition admonition-note alert alert--secondary"},(0,i.kt)("div",{parentName:"div",className:"admonition-heading"},(0,i.kt)("h5",{parentName:"div"},(0,i.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,i.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"14",height:"16",viewBox:"0 0 14 16"},(0,i.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"}))),"note")),(0,i.kt)("div",{parentName:"div",className:"admonition-content"},(0,i.kt)("p",{parentName:"div"},"\u53ea\u6709\u5728\u7cfb\u7edf\u5de5\u4f5c\u961f\u5217\u65e0\u6cd5\u6ee1\u8db3\u9700\u6c42\u7684\u65f6\u5019\uff0c\u624d\u5efa\u8bae\u65b0\u521b\u5efa\u4e00\u4e2a\u5de5\u4f5c\u961f\u5217\uff0c \u56e0\u4e3a\u6bcf\u4e2a\u5de5\u4f5c\u961f\u5217\u90fd\u4f1a\u5360\u7528\u8f83\u5927\u7684\u5185\u5b58\u3002\u5982\u679c\u65b0\u7684\u5de5\u4f5c\u9879\u6267\u884c\u963b\u585e\u6027\u64cd\u4f5c\uff0c\u4f1a\u4f7f\u5176\u4ed6\u7cfb\u7edf\u5de5\u4f5c\u961f\u7684\u5904\u7406\u5ef6\u8fdf\u5230\u4e0d\u53ef\u63a5\u53d7\u7684\u7a0b\u5ea6\u3002\u90a3\u4e48\u8fd9\u79cd\u60c5\u51b5\u4e0b\uff0c\u53ef\u4ee5\u65b0\u5efa\u4e00\u4e2a\u5de5\u4f5c\u961f\u5217\u3002"))))}d.isMDXComponent=!0}}]);