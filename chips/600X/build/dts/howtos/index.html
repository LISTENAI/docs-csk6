<!doctype html>
<html lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.2">
<title data-react-helmet="true">设备树操作指引 | 聆思文档中心</title><meta data-react-helmet="true" property="og:url" content="https://github.com/LISTENAI/docs-csk6/chips/600X/build/dts/howtos"><meta data-react-helmet="true" name="docusaurus_locale" content="en"><meta data-react-helmet="true" name="docusaurus_version" content="current"><meta data-react-helmet="true" name="docusaurus_tag" content="docs-default-current"><meta data-react-helmet="true" property="og:title" content="设备树操作指引 | 聆思文档中心"><meta data-react-helmet="true" name="description" content="阅读完本文，你将学会按步骤使用设备树完成任务。"><meta data-react-helmet="true" property="og:description" content="阅读完本文，你将学会按步骤使用设备树完成任务。"><link data-react-helmet="true" rel="shortcut icon" href="/docs-csk6/img/favicon.ico"><link data-react-helmet="true" rel="canonical" href="https://github.com/LISTENAI/docs-csk6/chips/600X/build/dts/howtos"><link data-react-helmet="true" rel="alternate" href="https://github.com/LISTENAI/docs-csk6/chips/600X/build/dts/howtos" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://github.com/LISTENAI/docs-csk6/chips/600X/build/dts/howtos" hreflang="x-default"><link rel="stylesheet" href="/docs-csk6/assets/css/styles.f018d340.css">
<link rel="preload" href="/docs-csk6/assets/js/runtime~main.e6d313ea.js" as="script">
<link rel="preload" href="/docs-csk6/assets/js/main.68df80fb.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div><a href="#main" class="skipToContent_vO2r">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" titleclassname="navbar__title" href="/docs-csk6/"><img src="/docs-csk6/img/logo_light.svg" alt="LSOpen Logo" class="themedImage_K3WP themedImage--light_Fy0T navbar__logo"><img src="/docs-csk6/img/logo_dark.svg" alt="LSOpen Logo" class="themedImage_K3WP themedImage--dark_V9oi navbar__logo"></a><a class="navbar__item navbar__link" href="/docs-csk6/chips/4002/Chip_information_4002">芯片</a><a class="navbar__item navbar__link" href="/docs-csk6/tools/LStudio">工具</a><a class="navbar__item navbar__link" href="/docs-csk6/AIsolution/ESR/Quick_start/Scheme_introduction">AI语音应用方案</a><a class="navbar__item navbar__link" href="/docs-csk6/Industrysolution/Scanning_pen/Scheme_introduction">行业Turnkey解决方案</a></div><div class="navbar__items navbar__items--right"><a class="navbar__item navbar__link" href="/docs-csk6/FAQ/faq">FAQ</a><a class="navbar__item navbar__link" href="/docs-csk6/school/school">视频课程</a><a class="navbar__item navbar__link" href="/docs-csk6/workorder/workorder">工单</a><div class="react-toggle displayOnlyInLargeViewport_a-w0 react-toggle--disabled"><div class="react-toggle-track" role="button" tabindex="-1"><div class="react-toggle-track-check"><span class="toggle_8pH0"><img src="/docs-csk6/img/light.svg" alt="" class="themedImage_K3WP themedImage--light_Fy0T"><img src="/docs-csk6/img/unlight.svg" alt="" class="themedImage_K3WP themedImage--dark_V9oi"></span></div><div class="react-toggle-track-x"><span class="toggle_8pH0"><img src="/docs-csk6/img/undark.svg" alt="" class="themedImage_K3WP themedImage--light_Fy0T"><img src="/docs-csk6/img/dark.svg" alt="" class="themedImage_K3WP themedImage--dark_V9oi"></span></div></div><input type="checkbox" class="react-toggle-screenreader-only" aria-label="Switch between dark and light mode"></div><div class="navbar__search searchBarContainer_I7kZ"><input placeholder="搜索" aria-label="Search" class="navbar__search-input"><div class="loadingRing_Zg7X searchBarLoadingRing_J5Ez"><div></div><div></div><div></div><div></div></div></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div><div class="navbar-sidebar"><div class="navbar-sidebar__brand"><a class="navbar__brand" titleclassname="navbar__title" href="/docs-csk6/"><img src="/docs-csk6/img/logo_light.svg" alt="LSOpen Logo" class="themedImage_K3WP themedImage--light_Fy0T navbar__logo"><img src="/docs-csk6/img/logo_dark.svg" alt="LSOpen Logo" class="themedImage_K3WP themedImage--dark_V9oi navbar__logo"></a></div><div class="navbar-sidebar__items"><div class="menu"><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" href="/docs-csk6/chips/4002/Chip_information_4002">芯片</a></li><li class="menu__list-item"><a class="menu__link" href="/docs-csk6/tools/LStudio">工具</a></li><li class="menu__list-item"><a class="menu__link" href="/docs-csk6/AIsolution/ESR/Quick_start/Scheme_introduction">AI语音应用方案</a></li><li class="menu__list-item"><a class="menu__link" href="/docs-csk6/Industrysolution/Scanning_pen/Scheme_introduction">行业Turnkey解决方案</a></li><li class="menu__list-item"><a class="menu__link" href="/docs-csk6/FAQ/faq">FAQ</a></li><li class="menu__list-item"><a class="menu__link" href="/docs-csk6/school/school">视频课程</a></li><li class="menu__list-item"><a class="menu__link" href="/docs-csk6/workorder/workorder">工单</a></li></ul></div></div></div></nav><nav class="navbar subnavbar--fixed-top sub-navbar"><div class="navbar__inner subnavbar__inner"><div class="navbar__items"><a class="subnavbar__item subnavbar__link" dirname="/chips" href="/docs-csk6/chips/4002/Chip_information_4002">CSK4002</a><a aria-current="page" class="subnavbar__item subnavbar__link subnavbar__link--active" dirname="/chips" href="/docs-csk6/chips/600X/overview/chips">CSK600X</a><a class="subnavbar__item subnavbar__link" dirname="/chips" href="/docs-csk6/chips/micropython/index">MicroPython</a></div></div></nav><div class="main-wrapper docs-wrapper doc-page"><div class="docPage_Ol8-"><aside class="docSidebarContainer_UfDv"><div class="sidebar_OMtR"><nav class="menu menu--responsive thin-scrollbar menu_2y2e menuWithAnnouncementBar_Lwkw" aria-label="Sidebar navigation"><button aria-label="Open menu" aria-haspopup="true" class="button button--secondary button--sm menu__button" type="button"><svg class="sidebarMenuIcon_IcOF" width="24" height="24" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><ul class="menu__list"><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--first menu__link--sublist" type="first" href="#!">简介</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs-csk6/chips/600X/overview/chips">芯片</a></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" type="" href="#!" tabindex="-1">开发套件</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs-csk6/chips/600X/overview/nanokit/nanokit_introduction">NanoKit开发套件</a></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" type="" href="#!" tabindex="-1">CSK6 NanoKit开发板</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs-csk6/chips/600X/overview/nanokit/nanokit_csk6002_9s_nano">csk6002-9s-nano</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs-csk6/chips/600X/overview/nanokit/nanokit_csk6011a_9s_nano">csk6011a-9s-nano</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" type="" href="#!" tabindex="-1">NanoKit 功能扩展板</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs-csk6/chips/600X/overview/nanokit/nanokit_audio">语音功能板 v1</a></li></ul></li></ul></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs-csk6/chips/600X/overview/system">系统与软件</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--first menu__link--sublist" type="first" href="#!">开发</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs-csk6/chips/600X/application/getting_start">快速开始</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs-csk6/chips/600X/application/application_development">应用开发</a></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" type="" href="#!" tabindex="-1">烧录与调试</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs-csk6/chips/600X/gdbdebug/overview">概述</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs-csk6/chips/600X/gdbdebug/csk6_load">CSK6 烧录</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs-csk6/chips/600X/gdbdebug/gdbdebug-daplink">基于 DAPLink 的 GDB 调试</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs-csk6/chips/600X/gdbdebug/gdbdebug-jlink">基于 J-Link 的 GDB 调试</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" type="" href="#!" tabindex="-1">优化</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs-csk6/chips/600X/application/optimizations_ways">优化方式</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" type="" href="#!" tabindex="-1">lisa zephyr 命令行工具</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs-csk6/chips/600X/tool/lisa_plugin_zephyr/index">概述</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs-csk6/chips/600X/tool/lisa_plugin_zephyr/install">安装/更新</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs-csk6/chips/600X/tool/lisa_plugin_zephyr/basic">基础命令</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs-csk6/chips/600X/tool/lisa_plugin_zephyr/command_detail">内置命令</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs-csk6/chips/600X/tool/lisa_plugin_zephyr/config">配置</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs-csk6/chips/600X/tool/lisa_plugin_zephyr/build_flash_debug">编译 烧录 调试</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs-csk6/chips/600X/tool/lisa_plugin_zephyr/filesystem">文件系统相关</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs-csk6/chips/600X/tool/lisa_plugin_zephyr/application_project">应用级提货单</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs-csk6/chips/600X/tool/lisa_plugin_zephyr/trouble_shooting">疑难解答</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs-csk6/chips/600X/tool/lisa_plugin_zephyr/release_note">lisa zep 更新日志</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" type="" href="#!" tabindex="-1">vscode开发插件推荐</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs-csk6/chips/600X/tool/vscode_plugin/code_completion">代码补全</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs-csk6/chips/600X/tool/vscode_plugin/debug">调试</a></li></ul></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs-csk6/chips/600X/application/modules">模块</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--first menu__link--sublist" type="first" href="#!">使用示例</a><ul class="menu__list"><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" type="" href="#!" tabindex="-1">外设驱动</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs-csk6/chips/600X/application/peripheral/overview">外设驱动的使用</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs-csk6/chips/600X/application/peripheral/samples/gpio">GPIO</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs-csk6/chips/600X/application/peripheral/samples/pwm">PWM</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs-csk6/chips/600X/application/peripheral/samples/UART">UART</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs-csk6/chips/600X/application/peripheral/samples/I2C">I2C</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs-csk6/chips/600X/application/peripheral/samples/spi">SPI</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs-csk6/chips/600X/application/peripheral/samples/ADC">SAR ADC</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs-csk6/chips/600X/application/peripheral/samples/RTC">RTC</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs-csk6/chips/600X/application/peripheral/samples/watchdog">WatchDog</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" type="" href="#!" tabindex="-1">系统内核</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs-csk6/chips/600X/application/kernel/overview">概述</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs-csk6/chips/600X/application/kernel/timer">Timer定时器</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs-csk6/chips/600X/application/kernel/multithread">多线程</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs-csk6/chips/600X/application/kernel/sync_semaphore">信号量</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs-csk6/chips/600X/application/kernel/sync_mutex">互斥量</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs-csk6/chips/600X/application/kernel/sync_poll">轮询</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs-csk6/chips/600X/application/kernel/thread_analyzer">线程分析器的使用</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs-csk6/chips/600X/application/kernel/workqueue">工作队列的使用</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" type="" href="#!" tabindex="-1">系统服务</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs-csk6/chips/600X/application/modules/overview">概述</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs-csk6/chips/600X/application/modules/logger">日志输出</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs-csk6/chips/600X/application/modules/usb_class">USB 模块</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs-csk6/chips/600X/application/modules/display_kscan">显示&amp;触摸</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs-csk6/chips/600X/application/modules/lvgl">LVGL 显示组件</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs-csk6/chips/600X/application/shell_sample">Shell 的使用</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs-csk6/chips/600X/application/modules/nvs">NVS 的使用</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs-csk6/chips/600X/application/modules/filesystem">文件系统的使用</a></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" type="" href="#!" tabindex="-1">音频</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs-csk6/chips/600X/application/audio/overview">概述</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs-csk6/chips/600X/application/audio/audio_record">录音</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs-csk6/chips/600X/application/audio/audio_playback">播音</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs-csk6/chips/600X/application/audio/audio_record_play">录音和播音示例</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" type="" href="#!" tabindex="-1">网络</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs-csk6/chips/600X/application/network/overview">概述</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs-csk6/chips/600X/application/network/wifi_connect">WIFI连接</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs-csk6/chips/600X/application/network/net_socket">网络连接</a></li></ul></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" type="" href="#!" tabindex="-1">自定义驱动</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs-csk6/chips/600X/application/customdriver/custom-driver-video">添加自定义驱动</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" type="" href="#!" tabindex="-1">自定义板型</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs-csk6/chips/600X/application/board">添加自定义板型</a></li></ul></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--first menu__link--sublist" type="first" href="#!">内核</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs-csk6/chips/600X/kernel/index">概述</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs-csk6/chips/600X/kernel/threads">线程</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs-csk6/chips/600X/kernel/scheduling">调度</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs-csk6/chips/600X/kernel/system_threads">系统线程</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs-csk6/chips/600X/kernel/workqueue">工作队列线程</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs-csk6/chips/600X/kernel/interrupts">中断</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs-csk6/chips/600X/kernel/semaphores">信号量</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs-csk6/chips/600X/kernel/mutexes">互斥量</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs-csk6/chips/600X/kernel/timing/timers">定时器</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs-csk6/chips/600X/kernel/heap">堆管理</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs-csk6/chips/600X/kernel/datapassing/message_queues">消息队列</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs-csk6/chips/600X/kernel/fifos">FIFOs</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs-csk6/chips/600X/kernel/data_passing/pipes">管道</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--first menu__link--sublist" type="first" href="#!">系统服务</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs-csk6/chips/600X/service/index">概述</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs-csk6/chips/600X/service/logging">日志</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs-csk6/chips/600X/service/portability/posix">POSIX 支持</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs-csk6/chips/600X/service/shell">Shell</a></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" type="" href="#!" tabindex="-1">存储</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs-csk6/chips/600X/service/storage/nvs">非易失性存储 (NVS)</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs-csk6/chips/600X/service/storage/flash_map">Flash map</a></li></ul></li></ul></li><li class="menu__list-item menu__list-item--current"><a class="menu__link menu__link--first menu__link--sublist menu__link--active" type="first" href="#!">构建与配置系统</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs-csk6/chips/600X/build/cmake/index">构建系统（ CMake ）</a></li><li class="menu__list-item menu__list-item--current"><a class="menu__link menu__link--sublist menu__link--active" type="" href="#!" tabindex="0">设备树</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs-csk6/chips/600X/build/dts/intro">设备树概述</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs-csk6/chips/600X/build/dts/design">设计目标</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs-csk6/chips/600X/build/dts/bindings">设备树绑定</a></li><li class="menu__list-item"><a aria-current="page" class="menu__link menu__link--active active" tabindex="0" href="/docs-csk6/chips/600X/build/dts/howtos">设备树操作指引</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs-csk6/chips/600X/build/dts/api_usage">在 C/C++ 中访问设备树</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs-csk6/chips/600X/build/dts/troubleshooting">问题排查</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs-csk6/chips/600X/build/dts/dt_vs_kconfig">设备树 VS Kconfig</a></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" type="" href="#!" tabindex="0">API 引用</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs-csk6/chips/600X/build/dts/api/index">概述</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs-csk6/chips/600X/build/dts/api/api">设备树 API</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs-csk6/chips/600X/build/dts/api/bindings">绑定索引</a></li></ul></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" type="" href="#!" tabindex="0">Kconfig配置系统</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs-csk6/chips/600X/build/kconfig/overview">概述</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs-csk6/chips/600X/build/kconfig/Kconfig_gui">Kconfig交互界面</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs-csk6/chips/600X/build/kconfig/Kconfig_configuration">设置Kconfig配置</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs-csk6/chips/600X/build/kconfig/Kconfig_tips_and_demo">小贴士与最佳实践</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs-csk6/chips/600X/build/kconfig/Kconfig_custom">自定义 Kconfig 预处理函数</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs-csk6/chips/600X/build/kconfig/Kconfig_extension">Kconfig 拓展</a></li></ul></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs-csk6/chips/600X/build/zephyr_cmake_package">Zephyr CMake Package(包)</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--first menu__link--sublist" type="first" href="#!">硬件支持</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs-csk6/chips/600X/hardware/pinctrl">引脚控制</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--first menu__link--sublist" type="first" href="#!">疑难解答</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs-csk6/chips/600X/FAQ/index">FAQ</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs-csk6/chips/600X/quick_start/doc_issue">反馈</a></li></ul></li><li class="menu__list-item"><a class="menu__link menu__link--first menu__link--sublist" type="first" href="#!">引用</a><ul class="menu__list"><li class="menu__list-item"><a href="https://zephyr-docs.listenai.com/doxygen/html/index.html" target="_blank" rel="noopener noreferrer" class="menu__link" tabindex="0"><span>Zephyr API<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_qQrU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li class="menu__list-item"><a href="https://zephyr-docs.listenai.com/kconfig.html" target="_blank" rel="noopener noreferrer" class="menu__link" tabindex="0"><span>Kconfig 检索<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_qQrU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li class="menu__list-item"><a href="https://zephyr-docs.listenai.com/reference/devicetree/bindings.html" target="_blank" rel="noopener noreferrer" class="menu__link" tabindex="0"><span>设备树绑定索引<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_qQrU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></li></ul></nav></div></aside><main class="docMainContainer_dRYS"><div class="container padding-top--md padding-bottom--lg center-container"><div class="row"><div class="col docItemCol_+xOG"><div class="docItemContainer_c+5G"><article><div class="markdown"><header><h1 class="h1Heading_5RMM">设备树操作指引</h1></header><p>阅读完本文，你将学会按步骤使用设备树完成任务。</p><div class="admonition admonition-tip alert alert--success"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="12" height="16" viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>提示</h5></div><div class="admonition-content"><p>参考 <a href="/docs-csk6/chips/600X/build/dts/troubleshooting">设备树问题排查</a> 了解一些解决问题的思路。</p></div></div><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_k6ZT" id="获取你的设备树与生成的头文件"></a>获取你的设备树与生成的头文件<a class="hash-link" href="#获取你的设备树与生成的头文件" title="Direct link to heading">#</a></h2><p>一个板型的设备树 ( <a href="https://docs.zephyrproject.org/latest/build/dts/intro.html#devicetree-in-out-files" target="_blank" rel="noopener noreferrer">BOARD.dts</a> ) 是通过 <code>#include</code> 预处理器指令来引入公共节点定义的。这一操作至少会 include  SoC 的 <code>.dtsi</code> 。查看这些文件是理解设备树内容的方法之一，例如查看 <code>dts/&lt;ARCH&gt;/&lt;vendor&gt;/&lt;soc&gt;.dtsi</code> ，但这可能耗费大量时间。</p><p>如果你只想查看你的板型的“最终”设备树，只需成功构建一个应用程序，并打开构建目录中的 <code>zephyr.dts</code> 文件（路径一般为 <code>build/zephyr/zephyr.dts</code> ）。</p><div class="admonition admonition-tip alert alert--success"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="12" height="16" viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>提示</h5></div><div class="admonition-content"><p>你可以通过为你的板型构建 <a href="https://docs.zephyrproject.org/latest/samples/hello_world/README.html#hello-world" target="_blank" rel="noopener noreferrer">Hello World</a> 查看“基础”设备树，因为这一结果没有受任何 <a href="/docs-csk6/chips/600X/build/dts/intro#%E8%BE%93%E5%85%A5%E6%96%87%E4%BB%B6">overlay 文件</a> 影响。</p></div></div><p>例如，使用 <code>csk6002_9s_nano</code> 构建 <a href="https://docs.zephyrproject.org/latest/samples/hello_world/README.html#hello-world" target="_blank" rel="noopener noreferrer">Hello World</a> ：</p><div class="codeBlockContainer_9aag"><div class="codeBlockContent_0VPv"><pre tabindex="0" class="prism-code language-undefined codeBlock_pSDi thin-scrollbar" style="color:#9CDCFE;background-color:#1E1E1E"><div class="codeBlockLines_sq2l"><span class="token-line" style="color:#9CDCFE"><span class="token plain"># 此处的 --cmake-only 目的是为了节省时间，</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"># 它会强制让 CMake 运行，并跳过构建过程。</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">lisa zep build -b csk6002_9s_nano samples/hello_world --cmake-only</span></span></div></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Q0gn clean-btn">Copy</button></div></div><p>你也可以将 <code>csk6002_9s_nano</code> 替换成你的板型。</p><p>CMake 将打印输入和输出文件的位置，如下所示：</p><div class="codeBlockContainer_9aag"><div class="codeBlockContent_0VPv"><pre tabindex="0" class="prism-code language-undefined codeBlock_pSDi thin-scrollbar" style="color:#9CDCFE;background-color:#1E1E1E"><div class="codeBlockLines_sq2l"><span class="token-line" style="color:#9CDCFE"><span class="token plain">-- Found BOARD.dts: .../zephyr/boards/arm/csk6002_9s_nano/csk6002_9s_nano.dts</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">-- Generated zephyr.dts: .../build/zephyr/zephyr.dts</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">-- Generated devicetree_unfixed.h: .../build/zephyr/include/generated/devicetree_unfixed.h</span></span></div></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Q0gn clean-btn">Copy</button></div></div><p>DTS 格式文件 <code>zephyr.dts</code> 即为最终设备树。</p><p><code>devicetree_unfixed.h</code> 文件则是与其对应的生成头文件。</p><p>请参阅 <a href="/docs-csk6/chips/600X/build/dts/intro#%E8%BE%93%E5%85%A5%E4%B8%8E%E8%BE%93%E5%87%BA%E6%96%87%E4%BB%B6">输入和输出文件</a> 了解这么文件的详细信息。</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_k6ZT" id="从设备树节点获取设备结构体struct-device"></a>从设备树节点获取设备结构体（<code>struct device</code>）<a class="hash-link" href="#从设备树节点获取设备结构体struct-device" title="Direct link to heading">#</a></h2><p>在编写 Zephyr 应用程序时，你通常希望获得与设备树节点对应的驱动程序级 <a href="https://docs.zephyrproject.org/latest/kernel/drivers/index.html#device-model-api" target="_blank" rel="noopener noreferrer">struct device</a> 变量。</p><p>假设你要从这个设备树片段中获取 <code>serial@40002000</code> 的 <code>struct device</code> ：</p><div class="codeBlockContainer_9aag"><div class="codeBlockContent_0VPv c"><pre tabindex="0" class="prism-code language-c codeBlock_pSDi thin-scrollbar" style="color:#9CDCFE;background-color:#1E1E1E"><div class="codeBlockLines_sq2l"><span class="token-line" style="color:#9CDCFE"><span class="token operator" style="color:rgb(212, 212, 212)">/</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        soc </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                serial0</span><span class="token operator" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> serial@</span><span class="token number" style="color:rgb(181, 206, 168)">40002000</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                        status </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;okay&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                        current</span><span class="token operator" style="color:rgb(212, 212, 212)">-</span><span class="token plain">speed </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">&lt;</span><span class="token number" style="color:rgb(181, 206, 168)">115200</span><span class="token operator" style="color:rgb(212, 212, 212)">&gt;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                        </span><span class="token comment" style="color:rgb(106, 153, 85)">/* ... */</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                </span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        aliases </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                my</span><span class="token operator" style="color:rgb(212, 212, 212)">-</span><span class="token plain">serial </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">&amp;</span><span class="token plain">serial0</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        chosen </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                zephyr</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain">console </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">&amp;</span><span class="token plain">serial0</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span></span></div></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Q0gn clean-btn">Copy</button></div></div><p>首先为你感兴趣的设备节点定义一个 <a href="/docs-csk6/chips/600X/build/dts/api_usage#%E8%8A%82%E7%82%B9-id">节点 id</a> 。下面的例子展示了可达成目的的不同方法，你可以从中选择最满足你需求的方式：</p><div class="codeBlockContainer_9aag"><div class="codeBlockContent_0VPv c"><pre tabindex="0" class="prism-code language-c codeBlock_pSDi thin-scrollbar" style="color:#9CDCFE;background-color:#1E1E1E"><div class="codeBlockLines_sq2l"><span class="token-line" style="color:#9CDCFE"><span class="token comment" style="color:rgb(106, 153, 85)">/* 方法 1: 通过节点标签 */</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token macro property directive-hash">#</span><span class="token macro property directive keyword" style="color:rgb(86, 156, 214)">define</span><span class="token macro property"> </span><span class="token macro property macro-name">MY_SERIAL</span><span class="token macro property"> </span><span class="token macro property expression function" style="color:rgb(220, 220, 170)">DT_NODELABEL</span><span class="token macro property expression punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token macro property expression">serial0</span><span class="token macro property expression punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)">/* 方法 1: 通过节点别名 */</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token macro property directive-hash">#</span><span class="token macro property directive keyword" style="color:rgb(86, 156, 214)">define</span><span class="token macro property"> </span><span class="token macro property macro-name">MY_SERIAL</span><span class="token macro property"> </span><span class="token macro property expression function" style="color:rgb(220, 220, 170)">DT_ALIAS</span><span class="token macro property expression punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token macro property expression">my_serial</span><span class="token macro property expression punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)">/* 方法 1: 通过 chosen 节点 */</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token macro property directive-hash">#</span><span class="token macro property directive keyword" style="color:rgb(86, 156, 214)">define</span><span class="token macro property"> </span><span class="token macro property macro-name">MY_SERIAL</span><span class="token macro property"> </span><span class="token macro property expression function" style="color:rgb(220, 220, 170)">DT_CHOSEN</span><span class="token macro property expression punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token macro property expression">zephyr_console</span><span class="token macro property expression punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)">/* 方法 1: 通过路径 */</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token macro property directive-hash">#</span><span class="token macro property directive keyword" style="color:rgb(86, 156, 214)">define</span><span class="token macro property"> </span><span class="token macro property macro-name">MY_SERIAL</span><span class="token macro property"> </span><span class="token macro property expression function" style="color:rgb(220, 220, 170)">DT_PATH</span><span class="token macro property expression punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token macro property expression">soc</span><span class="token macro property expression punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token macro property expression"> serial_40002000</span><span class="token macro property expression punctuation" style="color:rgb(212, 212, 212)">)</span></span></div></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Q0gn clean-btn">Copy</button></div></div><p>获得节点 id 后，有两种方法可以获取设备。一种方法是使用 <a href="https://docs.zephyrproject.org/latest/kernel/drivers/index.html#c.DEVICE_DT_GET" target="_blank" rel="noopener noreferrer"><code>DEVICE_DT_GET()</code></a> ：</p><div class="codeBlockContainer_9aag"><div class="codeBlockContent_0VPv c"><pre tabindex="0" class="prism-code language-c codeBlock_pSDi thin-scrollbar" style="color:#9CDCFE;background-color:#1E1E1E"><div class="codeBlockLines_sq2l"><span class="token-line" style="color:#9CDCFE"><span class="token keyword" style="color:rgb(86, 156, 214)">const</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">struct</span><span class="token plain"> </span><span class="token class-name" style="color:rgb(78, 201, 176)">device</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">*</span><span class="token plain">uart_dev </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token function" style="color:rgb(220, 220, 170)">DEVICE_DT_GET</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">MY_SERIAL</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">if</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token operator" style="color:rgb(212, 212, 212)">!</span><span class="token function" style="color:rgb(220, 220, 170)">device_is_ready</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">uart_dev</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        </span><span class="token comment" style="color:rgb(106, 153, 85)">/* Not ready, do not use */</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        </span><span class="token keyword" style="color:rgb(86, 156, 214)">return</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">-</span><span class="token plain">ENODEV</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span></span></div></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Q0gn clean-btn">Copy</button></div></div><p><a href="https://docs.zephyrproject.org/latest/kernel/drivers/index.html#c.DEVICE_DT_GET" target="_blank" rel="noopener noreferrer"><code>DEVICE_DT_GET()</code></a> 有多种变体，例如 <a href="https://docs.zephyrproject.org/latest/kernel/drivers/index.html#c.DEVICE_DT_GET_OR_NULL" target="_blank" rel="noopener noreferrer"><code>DEVICE_DT_GET_OR_NULL()</code></a> 、 <a href="https://docs.zephyrproject.org/latest/kernel/drivers/index.html#c.DEVICE_DT_GET_ONE" target="_blank" rel="noopener noreferrer"><code>DEVICE_DT_GET_ONE()</code></a> 或 <a href="https://docs.zephyrproject.org/latest/kernel/drivers/index.html#c.DEVICE_DT_GET_ANY" target="_blank" rel="noopener noreferrer"><code>DEVICE_DT_GET_ANY()</code></a> 。这个惯用方式在构建时获取设备指针，这意味着没有运行时的性能损失。如果要将设备指针存储为配置数据，此方法很有用。但由于设备可能未初始化或初始化失败，因此在将设备指针传递给任何 API 函数之前，你必须验证设备是否已准备好被使用。 （此检查由 <a href="https://docs.zephyrproject.org/latest/kernel/drivers/index.html#c.device_get_binding" target="_blank" rel="noopener noreferrer"><code>device_get_binding()</code></a> 为你完成。）</p><p>在某些情况下，设备在构建时是未知的，例如，有时设备需要通过用户输入（比如 shell ）来确认。这种情况下，你可以通过将 <a href="/docs-csk6/chips/600X/build/dts/api/api#dt_labelnode_id"><code>DT_LABEL()</code></a> 与 <a href="https://docs.zephyrproject.org/latest/kernel/drivers/index.html#c.device_get_binding" target="_blank" rel="noopener noreferrer"><code>device_get_binding()</code></a> 组合来获取 <code>struct device</code> ：</p><div class="codeBlockContainer_9aag"><div class="codeBlockContent_0VPv c"><pre tabindex="0" class="prism-code language-c codeBlock_pSDi thin-scrollbar" style="color:#9CDCFE;background-color:#1E1E1E"><div class="codeBlockLines_sq2l"><span class="token-line" style="color:#9CDCFE"><span class="token keyword" style="color:rgb(86, 156, 214)">const</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">struct</span><span class="token plain"> </span><span class="token class-name" style="color:rgb(78, 201, 176)">device</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">*</span><span class="token plain">uart_dev </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token function" style="color:rgb(220, 220, 170)">device_get_binding</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token function" style="color:rgb(220, 220, 170)">DT_LABEL</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">MY_SERIAL</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span></span></div></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Q0gn clean-btn">Copy</button></div></div><p>然后，你可以将 <code>uart_dev</code> 用于 <a href="https://docs.zephyrproject.org/latest/hardware/peripherals/uart.html#uart-api" target="_blank" rel="noopener noreferrer">UART</a> API 函数（如 <a href="https://docs.zephyrproject.org/latest/hardware/peripherals/uart.html#c.uart_configure" target="_blank" rel="noopener noreferrer"><code>uart_configure()</code></a> ）。其他设备类型所使用的代码也与此类似；只需确保为设备使用正确的 API。</p><p>无需将 <code>label</code> 属性覆盖为其他内容：只需创建一个节点标识符并将其传递给 <code>DT_LABEL</code> 以获取正确的字符串以传递给 <code>device_get_binding()</code> 。</p><p>如果你遇到问题，请参阅 <a href="/docs-csk6/chips/600X/build/dts/troubleshooting">设备树问题排查</a> 。首先要检查的是节点的 <code>status = &quot;okay&quot;</code> ，像这样：</p><div class="codeBlockContainer_9aag"><div class="codeBlockContent_0VPv c"><pre tabindex="0" class="prism-code language-c codeBlock_pSDi thin-scrollbar" style="color:#9CDCFE;background-color:#1E1E1E"><div class="codeBlockLines_sq2l"><span class="token-line" style="color:#9CDCFE"><span class="token macro property directive-hash">#</span><span class="token macro property directive keyword" style="color:rgb(86, 156, 214)">define</span><span class="token macro property"> </span><span class="token macro property macro-name">MY_SERIAL</span><span class="token macro property"> </span><span class="token macro property expression function" style="color:rgb(220, 220, 170)">DT_NODELABEL</span><span class="token macro property expression punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token macro property expression">my_serial</span><span class="token macro property expression punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token macro property directive-hash">#</span><span class="token macro property directive keyword" style="color:rgb(86, 156, 214)">if</span><span class="token macro property"> </span><span class="token macro property expression function" style="color:rgb(220, 220, 170)">DT_NODE_HAS_STATUS</span><span class="token macro property expression punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token macro property expression">MY_SERIAL</span><span class="token macro property expression punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token macro property expression"> okay</span><span class="token macro property expression punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">const</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">struct</span><span class="token plain"> </span><span class="token class-name" style="color:rgb(78, 201, 176)">device</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">*</span><span class="token plain">uart_dev </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token function" style="color:rgb(220, 220, 170)">DEVICE_DT_GET</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">MY_SERIAL</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token macro property directive-hash">#</span><span class="token macro property directive keyword" style="color:rgb(86, 156, 214)">else</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token macro property directive-hash">#</span><span class="token macro property directive keyword" style="color:rgb(86, 156, 214)">error</span><span class="token macro property"> </span><span class="token macro property string" style="color:rgb(206, 145, 120)">&quot;Node is disabled&quot;</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token macro property directive-hash">#</span><span class="token macro property directive keyword" style="color:rgb(86, 156, 214)">endif</span></span></div></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Q0gn clean-btn">Copy</button></div></div><p>如果你看到此 <code>#error</code> 输出，请确保你已经启用了该设备树节点。在某些情况下，你的代码虽然会编译，但无法链接到类似于以下内容的消息：</p><div class="codeBlockContainer_9aag"><div class="codeBlockContent_0VPv"><pre tabindex="0" class="prism-code language-undefined codeBlock_pSDi thin-scrollbar" style="color:#9CDCFE;background-color:#1E1E1E"><div class="codeBlockLines_sq2l"><span class="token-line" style="color:#9CDCFE"><span class="token plain">...undefined reference to `__device_dts_ord_N&#x27;</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">collect2: error: ld returned 1 exit status</span></span></div></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Q0gn clean-btn">Copy</button></div></div><p>这可能意味着，存在某个 Kconfig 问题，阻止了设备驱动程序的构建，导致引用不生效。如果你的代码可以编译成功，最后要做的是，通过以下方式检查设备是否准备就绪：</p><div class="codeBlockContainer_9aag"><div class="codeBlockContent_0VPv c"><pre tabindex="0" class="prism-code language-c codeBlock_pSDi thin-scrollbar" style="color:#9CDCFE;background-color:#1E1E1E"><div class="codeBlockLines_sq2l"><span class="token-line" style="color:#9CDCFE"><span class="token keyword" style="color:rgb(86, 156, 214)">if</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token operator" style="color:rgb(212, 212, 212)">!</span><span class="token function" style="color:rgb(220, 220, 170)">device_is_ready</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">uart_dev</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">     </span><span class="token function" style="color:rgb(220, 220, 170)">printk</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;Device not ready\n&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span></span></div></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Q0gn clean-btn">Copy</button></div></div><p>如果你发现设备没有准备就绪，很可能是设备的初始化功能失败了。在这种情况下，启用日志记录或对驱动程序代码进行调试，可能会有所帮助。请注意，你还可以使用 <a href="https://docs.zephyrproject.org/latest/kernel/drivers/index.html#c.device_get_binding" target="_blank" rel="noopener noreferrer"><code>device_get_binding()</code></a> 在运行时获取对设备引用。如果它返回 <code>NULL</code> ，则可能意味着设备的驱动程序无法初始化或根本不存在。</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_k6ZT" id="找到设备树绑定"></a>找到设备树绑定<a class="hash-link" href="#找到设备树绑定" title="Direct link to heading">#</a></h2><p><a href="/docs-csk6/chips/600X/build/dts/bindings">设备树绑定</a> 是 YAML 文件，它声明了你可以对其描述的节点执行什么操作，因此能够为你正在使用的节点找到绑定至关重要。</p><p>首先，先参考 <a href="#%E8%8E%B7%E5%8F%96%E4%BD%A0%E7%9A%84%E8%AE%BE%E5%A4%87%E6%A0%91%E4%B8%8E%E7%94%9F%E6%88%90%E7%9A%84%E5%A4%B4%E6%96%87%E4%BB%B6">获取你的设备树与生成的头文件</a> ，确保所需的设备树头文件已经生成。然后，打开生成的头文件，在以下述注释开头的块注释中，可以看到一个节点列表：</p><div class="codeBlockContainer_9aag"><div class="codeBlockContent_0VPv c"><pre tabindex="0" class="prism-code language-c codeBlock_pSDi thin-scrollbar" style="color:#9CDCFE;background-color:#1E1E1E"><div class="codeBlockLines_sq2l"><span class="token-line" style="color:#9CDCFE"><span class="token comment" style="color:rgb(106, 153, 85)">/*</span></span><span class="token-line" style="color:#9CDCFE"><span class="token comment" style="color:rgb(106, 153, 85)"> * [...]</span></span><span class="token-line" style="color:#9CDCFE"><span class="token comment" style="color:rgb(106, 153, 85)"> * Nodes in dependency order (ordinal and path):</span></span><span class="token-line" style="color:#9CDCFE"><span class="token comment" style="color:rgb(106, 153, 85)"> *   0   /</span></span><span class="token-line" style="color:#9CDCFE"><span class="token comment" style="color:rgb(106, 153, 85)"> *   1   /aliases</span></span><span class="token-line" style="color:#9CDCFE"><span class="token comment" style="color:rgb(106, 153, 85)"> *   2   /chosen</span></span><span class="token-line" style="color:#9CDCFE"><span class="token comment" style="color:rgb(106, 153, 85)"> *   3   /flash@0</span></span><span class="token-line" style="color:#9CDCFE"><span class="token comment" style="color:rgb(106, 153, 85)"> *   4   /memory@20000000</span></span><span class="token-line" style="color:#9CDCFE"><span class="token comment" style="color:rgb(106, 153, 85)"> *          (etc.)</span></span><span class="token-line" style="color:#9CDCFE"><span class="token comment" style="color:rgb(106, 153, 85)"> * [...]</span></span><span class="token-line" style="color:#9CDCFE"><span class="token comment" style="color:rgb(106, 153, 85)"> */</span></span></div></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Q0gn clean-btn">Copy</button></div></div><p>先记下要查找的节点的路径，例如 <code>/flash@0</code> 。在文件中搜索这一节点的内容，如果节点具有匹配的绑定，那它应该以类似下面的内容开头：</p><div class="codeBlockContainer_9aag"><div class="codeBlockContent_0VPv c"><pre tabindex="0" class="prism-code language-c codeBlock_pSDi thin-scrollbar" style="color:#9CDCFE;background-color:#1E1E1E"><div class="codeBlockLines_sq2l"><span class="token-line" style="color:#9CDCFE"><span class="token comment" style="color:rgb(106, 153, 85)">/*</span></span><span class="token-line" style="color:#9CDCFE"><span class="token comment" style="color:rgb(106, 153, 85)"> * Devicetree node:</span></span><span class="token-line" style="color:#9CDCFE"><span class="token comment" style="color:rgb(106, 153, 85)"> *   /flash@0</span></span><span class="token-line" style="color:#9CDCFE"><span class="token comment" style="color:rgb(106, 153, 85)"> *</span></span><span class="token-line" style="color:#9CDCFE"><span class="token comment" style="color:rgb(106, 153, 85)"> * Binding (compatible = soc-nv-flash):</span></span><span class="token-line" style="color:#9CDCFE"><span class="token comment" style="color:rgb(106, 153, 85)"> *   $ZEPHYR_BASE/dts/bindings/mtd/soc-nv-flash.yaml</span></span><span class="token-line" style="color:#9CDCFE"><span class="token comment" style="color:rgb(106, 153, 85)"> * [...]</span></span><span class="token-line" style="color:#9CDCFE"><span class="token comment" style="color:rgb(106, 153, 85)"> */</span></span></div></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Q0gn clean-btn">Copy</button></div></div><p>如果这一过程遇到问题，可参阅 <a href="/docs-csk6/chips/600X/build/dts/troubleshooting#%E6%A3%80%E6%9F%A5%E7%BC%BA%E5%A4%B1%E7%9A%84%E7%BB%91%E5%AE%9A">问题排查中的检查缺失的绑定</a> 。</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_k6ZT" id="设置设备树-overlay"></a>设置设备树 overlay<a class="hash-link" href="#设置设备树-overlay" title="Direct link to heading">#</a></h2><p>设备树 overlay 在 <a href="/docs-csk6/chips/600X/build/dts/intro">设备树概述</a> 中进行了介绍。 CMake 变量 <strong>DTC_OVERLAY_FILE</strong> 包含要使用的 overlay 文件的列表，每个文件用 <em>空格</em> 或 <em>分号</em> 分隔。如果 <strong>DTC_OVERLAY_FILE</strong> 指定了多个文件，它们将由 C 预处理器按指定的顺序包含。</p><p>你可以设置 <strong>DTC_OVERLAY_FILE</strong> 用于包含你要使用的文件。这里提供一个使用 <code>lisa zep build</code> 的 <a href="/docs-csk6/chips/600X/tool/lisa_plugin_zephyr/build_flash_debug">示例</a> 。</p><p>如果你没有设置 <strong>DTC_OVERLAY_FILE</strong> ，构建系统将按照以下步骤，在你的应用程序源目录中查找文件以用作设备树 overlay ：</p><ol><li>如果存在 <code>boards/&lt;BOARD&gt;.overlay</code> 文件，则直接使用。</li><li>如果当前板型存在 <a href="https://docs.zephyrproject.org/latest/hardware/porting/board_porting.html#porting-board-revisions" target="_blank" rel="noopener noreferrer">多个修订版</a> ，并且存在 <code>boards/&lt;BOARD&gt;_&lt;revision&gt;.overlay</code> 文件，那么该 overlay 文件将被使用。如果 <code>boards/&lt;BOARD&gt;.overlay</code> 存在，那么会两者将组合在一起在构建系统中使用。</li><li>如果上一步中已经找到了一个或多个文件，构建系统就停止继续查找。</li><li>否则，如果 <code>&lt;BOARD&gt;.overlay</code> 文件存在，那么它将被使用，并且构建系统将停止查找过程。</li><li>再不然，如果 <code>app.overlay</code> 存在就会被使用。</li></ol><p>使用 <a href="https://docs.zephyrproject.org/latest/hardware/porting/shields.html#shields" target="_blank" rel="noopener noreferrer">Shields</a> 也可以添加设备树 overlay 文件。</p><p><strong>DTC_OVERLAY_FILE</strong> 的值存储在 CMake 缓存中并在后续构建中使用。</p><p><a href="/docs-csk6/chips/600X/build/cmake/index">构建系统</a> 会在配置阶段打印找到的所有设备树 overlay ，如下所示：</p><div class="codeBlockContainer_9aag"><div class="codeBlockContent_0VPv"><pre tabindex="0" class="prism-code language-undefined codeBlock_pSDi thin-scrollbar" style="color:#9CDCFE;background-color:#1E1E1E"><div class="codeBlockLines_sq2l"><span class="token-line" style="color:#9CDCFE"><span class="token plain">-- Found devicetree overlay: .../some/file.overlay</span></span></div></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Q0gn clean-btn">Copy</button></div></div><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_k6ZT" id="使用设备树-overlay"></a>使用设备树 overlay<a class="hash-link" href="#使用设备树-overlay" title="Direct link to heading">#</a></h2><p>先根据 <a href="#%E8%AE%BE%E7%BD%AE%E8%AE%BE%E5%A4%87%E6%A0%91-overlay">设置设备树 overlay</a> 的描述为你的构建添加一个 overlay 。</p><p>overlay 可以使用多种方式覆盖节点属性值。例如，假设你的 <code>BOARD.dts</code> 中包含以下节点：</p><div class="codeBlockContainer_9aag"><div class="codeBlockContent_0VPv c"><pre tabindex="0" class="prism-code language-c codeBlock_pSDi thin-scrollbar" style="color:#9CDCFE;background-color:#1E1E1E"><div class="codeBlockLines_sq2l"><span class="token-line" style="color:#9CDCFE"><span class="token operator" style="color:rgb(212, 212, 212)">/</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        soc </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                serial0</span><span class="token operator" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> serial@</span><span class="token number" style="color:rgb(181, 206, 168)">40002000</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                        status </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;okay&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                        current</span><span class="token operator" style="color:rgb(212, 212, 212)">-</span><span class="token plain">speed </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">&lt;</span><span class="token number" style="color:rgb(181, 206, 168)">115200</span><span class="token operator" style="color:rgb(212, 212, 212)">&gt;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                        </span><span class="token comment" style="color:rgb(106, 153, 85)">/* ... */</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                </span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span></span></div></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Q0gn clean-btn">Copy</button></div></div><p>在 overlay 中覆盖 <code>current-speed</code> 属性值的等价方式是：</p><div class="codeBlockContainer_9aag"><div class="codeBlockContent_0VPv c"><pre tabindex="0" class="prism-code language-c codeBlock_pSDi thin-scrollbar" style="color:#9CDCFE;background-color:#1E1E1E"><div class="codeBlockLines_sq2l"><span class="token-line" style="color:#9CDCFE"><span class="token comment" style="color:rgb(106, 153, 85)">/* Option 1 */</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token operator" style="color:rgb(212, 212, 212)">&amp;</span><span class="token plain">serial0 </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">     current</span><span class="token operator" style="color:rgb(212, 212, 212)">-</span><span class="token plain">speed </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">&lt;</span><span class="token number" style="color:rgb(181, 206, 168)">9600</span><span class="token operator" style="color:rgb(212, 212, 212)">&gt;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)">/* Option 2 */</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token operator" style="color:rgb(212, 212, 212)">&amp;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token operator" style="color:rgb(212, 212, 212)">/</span><span class="token plain">soc</span><span class="token operator" style="color:rgb(212, 212, 212)">/</span><span class="token plain">serial@</span><span class="token number" style="color:rgb(181, 206, 168)">40002000</span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">     current</span><span class="token operator" style="color:rgb(212, 212, 212)">-</span><span class="token plain">speed </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">&lt;</span><span class="token number" style="color:rgb(181, 206, 168)">9600</span><span class="token operator" style="color:rgb(212, 212, 212)">&gt;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span></span></div></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Q0gn clean-btn">Copy</button></div></div><p>在下面的例子我们将使用 <code>&amp;serial0</code> 的形式来引用这一节点。</p><p>你可以使用 overlay 在你的设备树中别名添加到：别名作为 <code>/aliases</code> 节点的一个属性。例如：</p><div class="codeBlockContainer_9aag"><div class="codeBlockContent_0VPv c"><pre tabindex="0" class="prism-code language-c codeBlock_pSDi thin-scrollbar" style="color:#9CDCFE;background-color:#1E1E1E"><div class="codeBlockLines_sq2l"><span class="token-line" style="color:#9CDCFE"><span class="token operator" style="color:rgb(212, 212, 212)">/</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">     aliases </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">             my</span><span class="token operator" style="color:rgb(212, 212, 212)">-</span><span class="token plain">serial </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">&amp;</span><span class="token plain">serial0</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">     </span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span></span></div></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Q0gn clean-btn">Copy</button></div></div><p>选择的节点也以相同的方式工作。例如：</p><div class="codeBlockContainer_9aag"><div class="codeBlockContent_0VPv c"><pre tabindex="0" class="prism-code language-c codeBlock_pSDi thin-scrollbar" style="color:#9CDCFE;background-color:#1E1E1E"><div class="codeBlockLines_sq2l"><span class="token-line" style="color:#9CDCFE"><span class="token operator" style="color:rgb(212, 212, 212)">/</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">     chosen </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">             zephyr</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain">console </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">&amp;</span><span class="token plain">serial0</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">     </span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span></span></div></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Q0gn clean-btn">Copy</button></div></div><p>删除一个属性（除了一般情况之外，如果 boolean 属性在 <code>BOARD.dts</code> 中，则代表它为 true ，以下是如何将 boolean 属性设置为 false ，具体描述可参考 <a href="/docs-csk6/chips/600X/build/dts/intro#%E8%AE%BE%E7%BD%AE%E5%B1%9E%E6%80%A7%E5%80%BC">设置属性值</a> ）：</p><div class="codeBlockContainer_9aag"><div class="codeBlockContent_0VPv"><pre tabindex="0" class="prism-code language-undefined codeBlock_pSDi thin-scrollbar" style="color:#9CDCFE;background-color:#1E1E1E"><div class="codeBlockLines_sq2l"><span class="token-line" style="color:#9CDCFE"><span class="token plain">&amp;serial0 {</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">     /delete-property/ some-unwanted-property;</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">};</span></span></div></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Q0gn clean-btn">Copy</button></div></div><p>你可以使用 overlay 添加子节点。例如，要在现有总线节点上配置 SPI 或 I2C 子设备，可执行以下操作：</p><div class="codeBlockContainer_9aag"><div class="codeBlockContent_0VPv c"><pre tabindex="0" class="prism-code language-c codeBlock_pSDi thin-scrollbar" style="color:#9CDCFE;background-color:#1E1E1E"><div class="codeBlockLines_sq2l"><span class="token-line" style="color:#9CDCFE"><span class="token comment" style="color:rgb(106, 153, 85)">/* SPI device example */</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token operator" style="color:rgb(212, 212, 212)">&amp;</span><span class="token plain">spi1 </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">     my_spi_device</span><span class="token operator" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> temp</span><span class="token operator" style="color:rgb(212, 212, 212)">-</span><span class="token plain">sensor@</span><span class="token number" style="color:rgb(181, 206, 168)">0</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">             compatible </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;...&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">             label </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;TEMP_SENSOR_0&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">             </span><span class="token comment" style="color:rgb(106, 153, 85)">/* 如有必要， reg 可作为片选数字;</span></span><span class="token-line" style="color:#9CDCFE"><span class="token comment" style="color:rgb(106, 153, 85)">              * 如果存在，它必须匹配到节点的单元地址。 */</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">             reg </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">&lt;</span><span class="token number" style="color:rgb(181, 206, 168)">0</span><span class="token operator" style="color:rgb(212, 212, 212)">&gt;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            </span><span class="token comment" style="color:rgb(106, 153, 85)">/* 根据需要配置 SPI 设备的其他属性</span></span><span class="token-line" style="color:#9CDCFE"><span class="token comment" style="color:rgb(106, 153, 85)">             * 找到你的设备的设备树绑定了解详细信息。 */</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">             spi</span><span class="token operator" style="color:rgb(212, 212, 212)">-</span><span class="token plain">max</span><span class="token operator" style="color:rgb(212, 212, 212)">-</span><span class="token plain">frequency </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">&lt;</span><span class="token number" style="color:rgb(181, 206, 168)">4000000</span><span class="token operator" style="color:rgb(212, 212, 212)">&gt;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">     </span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)">/* I2C device example */</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token operator" style="color:rgb(212, 212, 212)">&amp;</span><span class="token plain">i2c2 </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">     my_i2c_device</span><span class="token operator" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> touchscreen@</span><span class="token number" style="color:rgb(181, 206, 168)">76</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">             compatible </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;...&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">             label </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;TOUCHSCREEN&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">             </span><span class="token comment" style="color:rgb(106, 153, 85)">/* reg 是 I2C 设备的地址。</span></span><span class="token-line" style="color:#9CDCFE"><span class="token comment" style="color:rgb(106, 153, 85)">              * 如果存在，它必须匹配到节点的单元地址。 */</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">             reg </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">&lt;</span><span class="token number" style="color:rgb(181, 206, 168)">76</span><span class="token operator" style="color:rgb(212, 212, 212)">&gt;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            </span><span class="token comment" style="color:rgb(106, 153, 85)">/* 根据需要配置 I2C 设备的其他属性</span></span><span class="token-line" style="color:#9CDCFE"><span class="token comment" style="color:rgb(106, 153, 85)">             * 找到你的设备的设备树绑定了解详细信息。 */</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">     </span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span></span></div></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Q0gn clean-btn">Copy</button></div></div><p>其他总线设备也可以类似配置：</p><ul><li>将设备创建为父总线的子节点</li><li>根据其绑定设置其属性</li></ul><p>假设你有一个合适设备驱动程序，与 <code>my_spi_device</code> 和 <code>my_i2c_device</code> 的 compatible 相关联，那么你可通过 Kconfig 启用驱动程序，并根据你新添加的总线节点 <a href="#%E4%BB%8E%E8%AE%BE%E5%A4%87%E6%A0%91%E8%8A%82%E7%82%B9%E8%8E%B7%E5%8F%96%E8%AE%BE%E5%A4%87%E7%BB%93%E6%9E%84%E4%BD%93struct-device">获取设备结构体</a> ，然后将其与该驱动程序 API 一起使用。</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_k6ZT" id="使用设备树-api-编写设备驱动"></a>使用设备树 API 编写设备驱动<a class="hash-link" href="#使用设备树-api-编写设备驱动" title="Direct link to heading">#</a></h2><p>“设备树感知”<a href="https://docs.zephyrproject.org/latest/kernel/drivers/index.html#device-model-api" target="_blank" rel="noopener noreferrer">设备驱动程序</a> （即驱动程序可通过设备树来确认需驱动哪些设备）应该为每个配置 <code>status = &quot;okay&quot;</code> 的设备树节点创建一个 <code>struct device</code> ，该节点具有驱动程序支持的特定 <a href="/docs-csk6/chips/600X/build/dts/intro#%E9%87%8D%E8%A6%81%E5%B1%9E%E6%80%A7">compatible</a> （或相关的 compatible 集合）。</p><p>编写“设备树感知”驱动程序，首先要为驱动程序支持的设备定义一个 <a href="/docs-csk6/chips/600X/build/dts/bindings">设备树绑定</a> 。使用来自驱动程序中的现有绑定作为起点。开始的绑定脚手架只需要这样：</p><div class="codeBlockContainer_9aag"><div class="codeBlockContent_0VPv yaml"><pre tabindex="0" class="prism-code language-yaml codeBlock_pSDi thin-scrollbar" style="color:#9CDCFE;background-color:#1E1E1E"><div class="codeBlockLines_sq2l"><span class="token-line" style="color:#9CDCFE"><span class="token key atrule">description</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> &lt;Human</span><span class="token punctuation" style="color:rgb(212, 212, 212)">-</span><span class="token plain">readable description of your binding</span><span class="token punctuation" style="color:rgb(212, 212, 212)">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token key atrule">compatible</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;foo-company,bar-device&quot;</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token key atrule">include</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> base.yaml</span></span></div></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Q0gn clean-btn">Copy</button></div></div><p>有关查找现有绑定的更多建议，请参阅 <a href="#%E6%89%BE%E5%88%B0%E8%AE%BE%E5%A4%87%E6%A0%91%E7%BB%91%E5%AE%9A">查找设备树绑定</a> 。</p><p>编写绑定后，你的驱动程序 C 文件可以使用设备树 API 查找满足 compatible 描述的 <code>status = &quot;okay&quot;</code> 节点，并为每个节点实例化一个 <code>struct device</code> 。实例化每个 <code>struct device</code> 有两种选择：使用实例编号和使用节点标签。</p><p>对应每一种情况：</p><ul><li>每个 <code>struct device</code> 的名称都应设置为其设备树节点的标签 <code>label</code> 属性。这允许驱动程序的使用者以通常的方式 <a href="#%E4%BB%8E%E8%AE%BE%E5%A4%87%E6%A0%91%E8%8A%82%E7%82%B9%E8%8E%B7%E5%8F%96%E8%AE%BE%E5%A4%87%E7%BB%93%E6%9E%84%E4%BD%93struct-device">从设备树节点获取设备结构体</a> 。</li><li>每个设备的初始配置应尽可能使用来自设备树属性的值。这允许使用者使用 <a href="#%E4%BD%BF%E7%94%A8%E8%AE%BE%E5%A4%87%E6%A0%91-overlay">设备树 overlay</a> 来配置驱动程序。</li></ul><p>以下是如何执行此操作的示例。这些示例均假设你已经实现了特定于设备的配置和数据结构以及 API 函数，如下所示：</p><div class="codeBlockContainer_9aag"><div class="codeBlockContent_0VPv c"><pre tabindex="0" class="prism-code language-c codeBlock_pSDi thin-scrollbar" style="color:#9CDCFE;background-color:#1E1E1E"><div class="codeBlockLines_sq2l"><span class="token-line" style="color:#9CDCFE"><span class="token comment" style="color:rgb(106, 153, 85)">/* my_driver.c */</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token macro property directive-hash">#</span><span class="token macro property directive keyword" style="color:rgb(86, 156, 214)">include</span><span class="token macro property"> </span><span class="token macro property string" style="color:rgb(206, 145, 120)">&lt;zephyr/drivers/some_api.h&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)">/* 定义数据 (RAM) 和配置 (ROM) 结构: */</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">struct</span><span class="token plain"> </span><span class="token class-name" style="color:rgb(78, 201, 176)">my_dev_data</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">     </span><span class="token comment" style="color:rgb(106, 153, 85)">/* 存储在 RAM 中的每个设备的值*/</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">struct</span><span class="token plain"> </span><span class="token class-name" style="color:rgb(78, 201, 176)">my_dev_cfg</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">     </span><span class="token class-name" style="color:rgb(78, 201, 176)">uint32_t</span><span class="token plain"> freq</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"> </span><span class="token comment" style="color:rgb(106, 153, 85)">/* Just an example: initial clock frequency in Hz */</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">     </span><span class="token comment" style="color:rgb(106, 153, 85)">/* 存储在 ROM 中的配置 */</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)">/* 实现驱动的 API 函数 (drivers/some_api.h 回调): */</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">static</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">int</span><span class="token plain"> </span><span class="token function" style="color:rgb(220, 220, 170)">my_driver_api_func1</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token keyword" style="color:rgb(86, 156, 214)">const</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">struct</span><span class="token plain"> </span><span class="token class-name" style="color:rgb(78, 201, 176)">device</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">*</span><span class="token plain">dev</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token class-name" style="color:rgb(78, 201, 176)">uint32_t</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">*</span><span class="token plain">foo</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"> </span><span class="token comment" style="color:rgb(106, 153, 85)">/* ... */</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">static</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">int</span><span class="token plain"> </span><span class="token function" style="color:rgb(220, 220, 170)">my_driver_api_func2</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token keyword" style="color:rgb(86, 156, 214)">const</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">struct</span><span class="token plain"> </span><span class="token class-name" style="color:rgb(78, 201, 176)">device</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">*</span><span class="token plain">dev</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token class-name" style="color:rgb(78, 201, 176)">uint64_t</span><span class="token plain"> bar</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"> </span><span class="token comment" style="color:rgb(106, 153, 85)">/* ... */</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">static</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">struct</span><span class="token plain"> </span><span class="token class-name" style="color:rgb(78, 201, 176)">some_api</span><span class="token plain"> my_api_funcs </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">     </span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">func1 </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> my_driver_api_func1</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">     </span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">func2 </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> my_driver_api_func2</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span></span></div></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Q0gn clean-btn">Copy</button></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_k6ZT" id="方式-1通过实例编号创建设备"></a>方式 1：通过实例编号创建设备<a class="hash-link" href="#方式-1通过实例编号创建设备" title="Direct link to heading">#</a></h3><p>请尽可能使用此方式，本方式使用 <a href="https://docs.zephyrproject.org/latest/build/dts/api/api.html#devicetree-inst-apis" target="_blank" rel="noopener noreferrer">基于实例的 API</a> 。但是，它们仅当设备树节点与驱动程序的 <code>compatible</code> 是等效时才起作用，并且你不需要能够区分它们。</p><p>为了使用基于实例的 API，首先需要将 <code>DT_DRV_COMPAT</code> 定义为设备驱动程序支持的 compatible （小写和下划线版本）。例如，如果你的驱动程序的 compatible 对应设备树中的 <code>vnd_my_device</code> ，你需要在驱动程序 C 文件中将 <code>DT_DRV_COMPAT</code> 定义为 <code>vnd_my_device</code> ：</p><div class="codeBlockContainer_9aag"><div class="codeBlockContent_0VPv c"><pre tabindex="0" class="prism-code language-c codeBlock_pSDi thin-scrollbar" style="color:#9CDCFE;background-color:#1E1E1E"><div class="codeBlockLines_sq2l"><span class="token-line" style="color:#9CDCFE"><span class="token plain"> </span><span class="token comment" style="color:rgb(106, 153, 85)">/*</span></span><span class="token-line" style="color:#9CDCFE"><span class="token comment" style="color:rgb(106, 153, 85)"> * 将此行定义置于源码文件的顶部。位于 include 区域之后就挺好。</span></span><span class="token-line" style="color:#9CDCFE"><span class="token comment" style="color:rgb(106, 153, 85)"> * (你可以在 Zephry git 仓库运行 &quot;git grep DT_DRV_COMPAT drivers&quot; 查看</span></span><span class="token-line" style="color:#9CDCFE"><span class="token comment" style="color:rgb(106, 153, 85)"> * 那些使用此样式声明的示例驱动程序)。</span></span><span class="token-line" style="color:#9CDCFE"><span class="token comment" style="color:rgb(106, 153, 85)"> */</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token macro property directive-hash">#</span><span class="token macro property directive keyword" style="color:rgb(86, 156, 214)">define</span><span class="token macro property"> </span><span class="token macro property macro-name">DT_DRV_COMPAT</span><span class="token macro property"> </span><span class="token macro property expression">vnd_my_device</span></span></div></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Q0gn clean-btn">Copy</button></div></div><div class="admonition admonition-tip alert alert--success"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="12" height="16" viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>重要</h5></div><div class="admonition-content"><p>正如示例中的形式， <code>DT_DRV_COMPAT</code> 宏不应包含引号或特殊字符。从 compatible 属性创建 <code>DT_DRV_COMPAT</code> 时，应当删除引号并将特殊字符转换为下划线。</p></div></div><p>最后，定义一个实例化宏，它使用实例编号创建每个设备结构体 <code>struct device</code> 。在定义 <code>my_api_funcs</code> 之后执行此操作。</p><div class="codeBlockContainer_9aag"><div class="codeBlockContent_0VPv c"><pre tabindex="0" class="prism-code language-c codeBlock_pSDi thin-scrollbar" style="color:#9CDCFE;background-color:#1E1E1E"><div class="codeBlockLines_sq2l"><span class="token-line" style="color:#9CDCFE"><span class="token comment" style="color:rgb(106, 153, 85)">/*</span></span><span class="token-line" style="color:#9CDCFE"><span class="token comment" style="color:rgb(106, 153, 85)"> * 这一实例化宏命名为 &quot;CREATE_MY_DEVICE&quot; 。</span></span><span class="token-line" style="color:#9CDCFE"><span class="token comment" style="color:rgb(106, 153, 85)"> * 其 &quot;inst&quot; 参数表示任一实例编号。</span></span><span class="token-line" style="color:#9CDCFE"><span class="token comment" style="color:rgb(106, 153, 85)"> *</span></span><span class="token-line" style="color:#9CDCFE"><span class="token comment" style="color:rgb(106, 153, 85)"> * 将此代码段放着文件末尾，例如在定义 &quot;my_api_funcs&quot; 之后。</span></span><span class="token-line" style="color:#9CDCFE"><span class="token comment" style="color:rgb(106, 153, 85)"> */</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token macro property directive-hash">#</span><span class="token macro property directive keyword" style="color:rgb(86, 156, 214)">define</span><span class="token macro property"> </span><span class="token macro property macro-name function" style="color:rgb(220, 220, 170)">CREATE_MY_DEVICE</span><span class="token macro property expression punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token macro property expression">inst</span><span class="token macro property expression punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token macro property expression">                                       </span><span class="token macro property punctuation" style="color:rgb(212, 212, 212)">\</span><span class="token macro property"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token macro property">     </span><span class="token macro property expression keyword" style="color:rgb(86, 156, 214)">static</span><span class="token macro property expression"> </span><span class="token macro property expression keyword" style="color:rgb(86, 156, 214)">struct</span><span class="token macro property expression"> </span><span class="token macro property expression class-name" style="color:rgb(78, 201, 176)">my_dev_data</span><span class="token macro property expression"> my_data_</span><span class="token macro property punctuation" style="color:rgb(212, 212, 212)">##</span><span class="token macro property expression">inst </span><span class="token macro property expression operator" style="color:rgb(212, 212, 212)">=</span><span class="token macro property expression"> </span><span class="token macro property expression punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token macro property expression">                    </span><span class="token macro property punctuation" style="color:rgb(212, 212, 212)">\</span><span class="token macro property"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token macro property">             </span><span class="token macro property comment" style="color:rgb(106, 153, 85)">/* initialize RAM values as needed, e.g.: */</span><span class="token macro property">            </span><span class="token macro property punctuation" style="color:rgb(212, 212, 212)">\</span><span class="token macro property"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token macro property">             </span><span class="token macro property expression punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token macro property expression">freq </span><span class="token macro property expression operator" style="color:rgb(212, 212, 212)">=</span><span class="token macro property expression"> </span><span class="token macro property expression function" style="color:rgb(220, 220, 170)">DT_INST_PROP</span><span class="token macro property expression punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token macro property expression">inst</span><span class="token macro property expression punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token macro property expression"> clock_frequency</span><span class="token macro property expression punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token macro property expression punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token macro property expression">            </span><span class="token macro property punctuation" style="color:rgb(212, 212, 212)">\</span><span class="token macro property"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token macro property">     </span><span class="token macro property expression punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token macro property expression punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token macro property expression">                                                              </span><span class="token macro property punctuation" style="color:rgb(212, 212, 212)">\</span><span class="token macro property"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token macro property">     </span><span class="token macro property expression keyword" style="color:rgb(86, 156, 214)">static</span><span class="token macro property expression"> </span><span class="token macro property expression keyword" style="color:rgb(86, 156, 214)">const</span><span class="token macro property expression"> </span><span class="token macro property expression keyword" style="color:rgb(86, 156, 214)">struct</span><span class="token macro property expression"> </span><span class="token macro property expression class-name" style="color:rgb(78, 201, 176)">my_dev_cfg</span><span class="token macro property expression"> my_cfg_</span><span class="token macro property punctuation" style="color:rgb(212, 212, 212)">##</span><span class="token macro property expression">inst </span><span class="token macro property expression operator" style="color:rgb(212, 212, 212)">=</span><span class="token macro property expression"> </span><span class="token macro property expression punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token macro property expression">                </span><span class="token macro property punctuation" style="color:rgb(212, 212, 212)">\</span><span class="token macro property"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token macro property">             </span><span class="token macro property comment" style="color:rgb(106, 153, 85)">/* initialize ROM values as needed. */</span><span class="token macro property">                  </span><span class="token macro property punctuation" style="color:rgb(212, 212, 212)">\</span><span class="token macro property"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token macro property">     </span><span class="token macro property expression punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token macro property expression punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token macro property expression">                                                              </span><span class="token macro property punctuation" style="color:rgb(212, 212, 212)">\</span><span class="token macro property"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token macro property">     </span><span class="token macro property expression function" style="color:rgb(220, 220, 170)">DEVICE_DT_INST_DEFINE</span><span class="token macro property expression punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token macro property expression">inst</span><span class="token macro property expression punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token macro property expression">                                     </span><span class="token macro property punctuation" style="color:rgb(212, 212, 212)">\</span><span class="token macro property"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token macro property">                           </span><span class="token macro property expression">my_dev_init_function</span><span class="token macro property expression punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token macro property expression">                     </span><span class="token macro property punctuation" style="color:rgb(212, 212, 212)">\</span><span class="token macro property"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token macro property">                           </span><span class="token macro property expression constant" style="color:rgb(100, 102, 149)">NULL</span><span class="token macro property expression punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token macro property expression">                                     </span><span class="token macro property punctuation" style="color:rgb(212, 212, 212)">\</span><span class="token macro property"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token macro property">                           </span><span class="token macro property expression operator" style="color:rgb(212, 212, 212)">&amp;</span><span class="token macro property expression">my_data_</span><span class="token macro property punctuation" style="color:rgb(212, 212, 212)">##</span><span class="token macro property expression">inst</span><span class="token macro property expression punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token macro property expression">                          </span><span class="token macro property punctuation" style="color:rgb(212, 212, 212)">\</span><span class="token macro property"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token macro property">                           </span><span class="token macro property expression operator" style="color:rgb(212, 212, 212)">&amp;</span><span class="token macro property expression">my_cfg_</span><span class="token macro property punctuation" style="color:rgb(212, 212, 212)">##</span><span class="token macro property expression">inst</span><span class="token macro property expression punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token macro property expression">                           </span><span class="token macro property punctuation" style="color:rgb(212, 212, 212)">\</span><span class="token macro property"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token macro property">                           </span><span class="token macro property expression">MY_DEV_INIT_LEVEL</span><span class="token macro property expression punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token macro property expression"> MY_DEV_INIT_PRIORITY</span><span class="token macro property expression punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token macro property expression">  </span><span class="token macro property punctuation" style="color:rgb(212, 212, 212)">\</span><span class="token macro property"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token macro property">                           </span><span class="token macro property expression operator" style="color:rgb(212, 212, 212)">&amp;</span><span class="token macro property expression">my_api_funcs</span><span class="token macro property expression punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token macro property expression punctuation" style="color:rgb(212, 212, 212)">;</span></span></div></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Q0gn clean-btn">Copy</button></div></div><p>注意使用 <a href="/docs-csk6/chips/600X/build/dts/api/api#dt_inst_propinst-prop"><code>DT_INST_PROP()</code></a> 和 <a href="https://docs.zephyrproject.org/latest/kernel/drivers/index.html#c.DEVICE_DT_INST_DEFINE" target="_blank" rel="noopener noreferrer"><code>DEVICE_DT_INST_DEFINE()</code></a> 等 API 来访问设备树节点数据。这些 API 从设备树中检索实例编号为 <code>inst</code> 的节点数据——其中判断节点满足条件的依据是，检查 compatible 是否与 <code>DT_DRV_COMPAT</code> 对应。</p><p>最后，将实例化的宏传给 <a href="https://docs.zephyrproject.org/latest/build/dts/api/api.html#c.DT_INST_FOREACH_STATUS_OKAY" target="_blank" rel="noopener noreferrer"><code>DT_INST_FOREACH_STATUS_OKAY()</code></a> ：</p><div class="codeBlockContainer_9aag"><div class="codeBlockContent_0VPv c"><pre tabindex="0" class="prism-code language-c codeBlock_pSDi thin-scrollbar" style="color:#9CDCFE;background-color:#1E1E1E"><div class="codeBlockLines_sq2l"><span class="token-line" style="color:#9CDCFE"><span class="token comment" style="color:rgb(106, 153, 85)">/* 对每一个实例，调用创建设备的宏: */</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token function" style="color:rgb(220, 220, 170)">DT_INST_FOREACH_STATUS_OKAY</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">CREATE_MY_DEVICE</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span></span></div></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Q0gn clean-btn">Copy</button></div></div><p><code>DT_INST_FOREACH_STATUS_OKAY</code> 将展开为代码段，该代码为每个启用的节点（其 compatible 与 <code>DT_DRV_COMPAT</code> 对应）调用一次 <code>CREATE_MY_DEVICE</code> 。它不会在 <code>CREATE_MY_DEVICE</code> 扩展的末尾附加分号，因此 <code>CREATE_MY_DEVICE</code> 的扩展必须以分号或代表函数的宏（此宏的定义中也需要以分号结尾）结尾以支持多个设备。</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_k6ZT" id="方式-2通过节点标签创建设备"></a>方式 2：通过节点标签创建设备<a class="hash-link" href="#方式-2通过节点标签创建设备" title="Direct link to heading">#</a></h3><p>某些设备驱动程序不能使用实例编号。例如，一个 SoC 外设驱动程序，它依赖于专门针对各个 IP 块的供应商 HAL API 来实现 Zephyr 驱动程序回调。此类情况应使用 <a href="/docs-csk6/chips/600X/build/dts/api/api#dt_nodelabellabel"><code>DT_NODELABEL()</code></a> 来引用设备树中代表 SoC 上支持的外设的各个节点。然后可以使用 devicetree.h <a href="/docs-csk6/chips/600X/build/dts/api/api#devicetree-generic-apis">通用 API</a> 访问节点数据。</p><p>为此，必须在你的 <a href="/docs-csk6/chips/600X/build/dts/intro#%E8%BE%93%E5%85%A5%E6%96%87%E4%BB%B6">SoC 的 dtsi 文件</a> 中，为你的驱动程序支持的 IP 块定义适合的节点标签，如 <code>mydevice0</code> 、 <code>mydevice1</code> 等。生成的设备树通常看起来像这样：</p><div class="codeBlockContainer_9aag"><div class="codeBlockContent_0VPv c"><pre tabindex="0" class="prism-code language-c codeBlock_pSDi thin-scrollbar" style="color:#9CDCFE;background-color:#1E1E1E"><div class="codeBlockLines_sq2l"><span class="token-line" style="color:#9CDCFE"><span class="token operator" style="color:rgb(212, 212, 212)">/</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        soc </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                mydevice0</span><span class="token operator" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> dev@</span><span class="token number" style="color:rgb(181, 206, 168)">0</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                        compatible </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;vnd,my-device&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                </span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                mydevice1</span><span class="token operator" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> dev@</span><span class="token number" style="color:rgb(181, 206, 168)">1</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                        compatible </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;vnd,my-device&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                </span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span></span></div></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Q0gn clean-btn">Copy</button></div></div><p>驱动程序可以使用设备树中的节点标签 <code>mydevice0</code> 和 <code>mydevice1</code> 对特定设备节点进行操作：</p><div class="codeBlockContainer_9aag"><div class="codeBlockContent_0VPv c"><pre tabindex="0" class="prism-code language-c codeBlock_pSDi thin-scrollbar" style="color:#9CDCFE;background-color:#1E1E1E"><div class="codeBlockLines_sq2l"><span class="token-line" style="color:#9CDCFE"><span class="token comment" style="color:rgb(106, 153, 85)">/*</span></span><span class="token-line" style="color:#9CDCFE"><span class="token comment" style="color:rgb(106, 153, 85)"> * 创建此宏可便于为对应设备创建节点 id 。</span></span><span class="token-line" style="color:#9CDCFE"><span class="token comment" style="color:rgb(106, 153, 85)"> * 例如使用 MYDEV(0) 来引用标签为 &quot;mydevice0&quot; 的节点。</span></span><span class="token-line" style="color:#9CDCFE"><span class="token comment" style="color:rgb(106, 153, 85)"> */</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token macro property directive-hash">#</span><span class="token macro property directive keyword" style="color:rgb(86, 156, 214)">define</span><span class="token macro property"> </span><span class="token macro property macro-name function" style="color:rgb(220, 220, 170)">MYDEV</span><span class="token macro property expression punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token macro property expression">idx</span><span class="token macro property expression punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token macro property expression"> </span><span class="token macro property expression function" style="color:rgb(220, 220, 170)">DT_NODELABEL</span><span class="token macro property expression punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token macro property expression">mydevice </span><span class="token macro property punctuation" style="color:rgb(212, 212, 212)">##</span><span class="token macro property"> </span><span class="token macro property expression">idx</span><span class="token macro property expression punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)">/*</span></span><span class="token-line" style="color:#9CDCFE"><span class="token comment" style="color:rgb(106, 153, 85)"> * 定义你的实例化宏； &quot;idx&quot; 是索引，表示与设备有对应关系的数字，</span></span><span class="token-line" style="color:#9CDCFE"><span class="token comment" style="color:rgb(106, 153, 85)"> * 例如 mydevice0 对应 0 ，mydevice1 对应 1 。</span></span><span class="token-line" style="color:#9CDCFE"><span class="token comment" style="color:rgb(106, 153, 85)"> * 其中将使用 MYDEV() 创建由索引得出的节点标签。</span></span><span class="token-line" style="color:#9CDCFE"><span class="token comment" style="color:rgb(106, 153, 85)"> */</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token macro property directive-hash">#</span><span class="token macro property directive keyword" style="color:rgb(86, 156, 214)">define</span><span class="token macro property"> </span><span class="token macro property macro-name function" style="color:rgb(220, 220, 170)">CREATE_MY_DEVICE</span><span class="token macro property expression punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token macro property expression">idx</span><span class="token macro property expression punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token macro property expression">                                        </span><span class="token macro property punctuation" style="color:rgb(212, 212, 212)">\</span><span class="token macro property"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token macro property">     </span><span class="token macro property expression keyword" style="color:rgb(86, 156, 214)">static</span><span class="token macro property expression"> </span><span class="token macro property expression keyword" style="color:rgb(86, 156, 214)">struct</span><span class="token macro property expression"> </span><span class="token macro property expression class-name" style="color:rgb(78, 201, 176)">my_dev_data</span><span class="token macro property expression"> my_data_</span><span class="token macro property punctuation" style="color:rgb(212, 212, 212)">##</span><span class="token macro property expression">idx </span><span class="token macro property expression operator" style="color:rgb(212, 212, 212)">=</span><span class="token macro property expression"> </span><span class="token macro property expression punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token macro property expression">                     </span><span class="token macro property punctuation" style="color:rgb(212, 212, 212)">\</span><span class="token macro property"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token macro property">             </span><span class="token macro property comment" style="color:rgb(106, 153, 85)">/* initialize RAM values as needed, e.g.: */</span><span class="token macro property">            </span><span class="token macro property punctuation" style="color:rgb(212, 212, 212)">\</span><span class="token macro property"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token macro property">             </span><span class="token macro property expression punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token macro property expression">freq </span><span class="token macro property expression operator" style="color:rgb(212, 212, 212)">=</span><span class="token macro property expression"> </span><span class="token macro property expression function" style="color:rgb(220, 220, 170)">DT_PROP</span><span class="token macro property expression punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token macro property expression function" style="color:rgb(220, 220, 170)">MYDEV</span><span class="token macro property expression punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token macro property expression">idx</span><span class="token macro property expression punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token macro property expression punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token macro property expression"> clock_frequency</span><span class="token macro property expression punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token macro property expression punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token macro property expression">           </span><span class="token macro property punctuation" style="color:rgb(212, 212, 212)">\</span><span class="token macro property"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token macro property">     </span><span class="token macro property expression punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token macro property expression punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token macro property expression">                                                              </span><span class="token macro property punctuation" style="color:rgb(212, 212, 212)">\</span><span class="token macro property"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token macro property">     </span><span class="token macro property expression keyword" style="color:rgb(86, 156, 214)">static</span><span class="token macro property expression"> </span><span class="token macro property expression keyword" style="color:rgb(86, 156, 214)">const</span><span class="token macro property expression"> </span><span class="token macro property expression keyword" style="color:rgb(86, 156, 214)">struct</span><span class="token macro property expression"> </span><span class="token macro property expression class-name" style="color:rgb(78, 201, 176)">my_dev_cfg</span><span class="token macro property expression"> my_cfg_</span><span class="token macro property punctuation" style="color:rgb(212, 212, 212)">##</span><span class="token macro property expression">idx </span><span class="token macro property expression operator" style="color:rgb(212, 212, 212)">=</span><span class="token macro property expression"> </span><span class="token macro property expression punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token macro property expression"> </span><span class="token macro property comment" style="color:rgb(106, 153, 85)">/* ... */</span><span class="token macro property"> </span><span class="token macro property expression punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token macro property expression punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token macro property expression">    </span><span class="token macro property punctuation" style="color:rgb(212, 212, 212)">\</span><span class="token macro property"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token macro property">     </span><span class="token macro property expression function" style="color:rgb(220, 220, 170)">DEVICE_DT_DEFINE</span><span class="token macro property expression punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token macro property expression function" style="color:rgb(220, 220, 170)">MYDEV</span><span class="token macro property expression punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token macro property expression">idx</span><span class="token macro property expression punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token macro property expression punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token macro property expression">                                    </span><span class="token macro property punctuation" style="color:rgb(212, 212, 212)">\</span><span class="token macro property"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token macro property">                     </span><span class="token macro property expression">my_dev_init_function</span><span class="token macro property expression punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token macro property expression">                           </span><span class="token macro property punctuation" style="color:rgb(212, 212, 212)">\</span><span class="token macro property"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token macro property">                     </span><span class="token macro property expression constant" style="color:rgb(100, 102, 149)">NULL</span><span class="token macro property expression punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token macro property expression">                                           </span><span class="token macro property punctuation" style="color:rgb(212, 212, 212)">\</span><span class="token macro property"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token macro property">                     </span><span class="token macro property expression operator" style="color:rgb(212, 212, 212)">&amp;</span><span class="token macro property expression">my_data_</span><span class="token macro property punctuation" style="color:rgb(212, 212, 212)">##</span><span class="token macro property expression">idx</span><span class="token macro property expression punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token macro property expression">                                 </span><span class="token macro property punctuation" style="color:rgb(212, 212, 212)">\</span><span class="token macro property"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token macro property">                     </span><span class="token macro property expression operator" style="color:rgb(212, 212, 212)">&amp;</span><span class="token macro property expression">my_cfg_</span><span class="token macro property punctuation" style="color:rgb(212, 212, 212)">##</span><span class="token macro property expression">idx</span><span class="token macro property expression punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token macro property expression">                                  </span><span class="token macro property punctuation" style="color:rgb(212, 212, 212)">\</span><span class="token macro property"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token macro property">                     </span><span class="token macro property expression">MY_DEV_INIT_LEVEL</span><span class="token macro property expression punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token macro property expression"> MY_DEV_INIT_PRIORITY</span><span class="token macro property expression punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token macro property expression">        </span><span class="token macro property punctuation" style="color:rgb(212, 212, 212)">\</span><span class="token macro property"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token macro property">                     </span><span class="token macro property expression operator" style="color:rgb(212, 212, 212)">&amp;</span><span class="token macro property expression">my_api_funcs</span><span class="token macro property expression punctuation" style="color:rgb(212, 212, 212)">)</span></span></div></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Q0gn clean-btn">Copy</button></div></div><p>要访问设备树节点数据时，请注意 <a href="/docs-csk6/chips/600X/build/dts/api/api#dt_propnode_id-prop"><code>DT_PROP()</code></a> 和 <a href="https://docs.zephyrproject.org/latest/kernel/drivers/index.html#c.DEVICE_DT_DEFINE" target="_blank" rel="noopener noreferrer"><code>DEVICE_DT_DEFINE()</code></a> 等 API 的用法。</p><p>最后，通过定义宏手动检测每个设备树节点是否启用，并使用 <code>CREATE_MY_DEVICE</code> 实例化每个 <code>struct device</code> ：</p><div class="codeBlockContainer_9aag"><div class="codeBlockContent_0VPv c"><pre tabindex="0" class="prism-code language-c codeBlock_pSDi thin-scrollbar" style="color:#9CDCFE;background-color:#1E1E1E"><div class="codeBlockLines_sq2l"><span class="token-line" style="color:#9CDCFE"><span class="token macro property directive-hash">#</span><span class="token macro property directive keyword" style="color:rgb(86, 156, 214)">if</span><span class="token macro property"> </span><span class="token macro property expression function" style="color:rgb(220, 220, 170)">DT_NODE_HAS_STATUS</span><span class="token macro property expression punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token macro property expression function" style="color:rgb(220, 220, 170)">DT_NODELABEL</span><span class="token macro property expression punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token macro property expression">mydevice0</span><span class="token macro property expression punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token macro property expression punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token macro property expression"> okay</span><span class="token macro property expression punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token function" style="color:rgb(220, 220, 170)">CREATE_MY_DEVICE</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token number" style="color:rgb(181, 206, 168)">0</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token macro property directive-hash">#</span><span class="token macro property directive keyword" style="color:rgb(86, 156, 214)">endif</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token macro property directive-hash">#</span><span class="token macro property directive keyword" style="color:rgb(86, 156, 214)">if</span><span class="token macro property"> </span><span class="token macro property expression function" style="color:rgb(220, 220, 170)">DT_NODE_HAS_STATUS</span><span class="token macro property expression punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token macro property expression function" style="color:rgb(220, 220, 170)">DT_NODELABEL</span><span class="token macro property expression punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token macro property expression">mydevice1</span><span class="token macro property expression punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token macro property expression punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token macro property expression"> okay</span><span class="token macro property expression punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token function" style="color:rgb(220, 220, 170)">CREATE_MY_DEVICE</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token number" style="color:rgb(181, 206, 168)">1</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token macro property directive-hash">#</span><span class="token macro property directive keyword" style="color:rgb(86, 156, 214)">endif</span></span></div></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Q0gn clean-btn">Copy</button></div></div><p>这种调用形式不使用 <code>DT_INST_FOREACH_STATUS_OKAY()</code> ，因此驱动程序作者需要负责为每个可能满足条件的节点调用 <code>CREATE_MY_DEVICE()</code> ，例如根据受 SoC 上可支持外设的有关信息，来判断是否可满足条件。</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_k6ZT" id="依赖其他设备的设备驱动"></a>依赖其他设备的设备驱动<a class="hash-link" href="#依赖其他设备的设备驱动" title="Direct link to heading">#</a></h2><p>有时，一个<code>struct device</code> 依赖于另一个 <code>struct device</code> 并需要一个可指向它的指针。例如，传感器设备可能需要指向其 SPI 总线控制器设备的指针。对此有一些建议：</p><ul><li><p>在编写你的设备树绑定时，尽可能以使用由 devicetree.h 的 <a href="https://docs.zephyrproject.org/latest/build/dts/api/api.html#devicetree-hw-api" target="_blank" rel="noopener noreferrer">硬件特定 API</a> 批准的方式。</p></li><li><p>特别是，对于总线设备，你的驱动程序绑定应该 include 例如 <a href="https://cloud.listenai.com/zephyr/zephyr/-/blob/master/dts/bindings/spi/spi-device.yaml" target="_blank" rel="noopener noreferrer">dts/bindings/spi/spi-device.yaml</a> 的文件，它为设备提供一些通用定义，用于特定总线寻址。这允许使用 <a href="/docs-csk6/chips/600X/build/dts/api/api#dt_busnode_id"><code>DT_BUS()</code></a> 之类的 API 来获取总线节点的节点 id 。然后，你可以对总线使用 <a href="#%E4%BB%8E%E8%AE%BE%E5%A4%87%E6%A0%91%E8%8A%82%E7%82%B9%E8%8E%B7%E5%8F%96%E8%AE%BE%E5%A4%87%E7%BB%93%E6%9E%84%E4%BD%93struct-device">从设备树节点获取设备结构体</a> 的一般方式。</p></li></ul><p>可搜索现有绑定和设备驱动程序以获取示例。</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_k6ZT" id="依赖开发板特定设备的应用"></a>依赖开发板特定设备的应用<a class="hash-link" href="#依赖开发板特定设备的应用" title="Direct link to heading">#</a></h2><p>如果想要应用程序代码未经修改即可在多个板上运行，你可以通过设备树别名来指定硬件特定部分，就像在 <a href="/docs-csk6/chips/600X/application/peripheral/samples/gpio">GPIO 示例</a> 中所做的那样。然后可以在 <a href="/docs-csk6/chips/600X/build/dts/intro#%E8%BE%93%E5%85%A5%E4%B8%8E%E8%BE%93%E5%87%BA%E6%96%87%E4%BB%B6">BOARD.dts</a> 文件中或通过 <a href="#%E4%BD%BF%E7%94%A8%E8%AE%BE%E5%A4%87%E6%A0%91-overlay">设备树 overlay</a> 配置应用程序。</p></div></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/docs-csk6/chips/600X/build/dts/bindings"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">« 设备树绑定</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/docs-csk6/chips/600X/build/dts/api_usage"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">在 C/C++ 中访问设备树 »</div></a></div></nav><div class="gitalk-wrapper"><ul class="gitalk-option"><li class="like"><i class="icon like-icon"></i> <span id="like_num">有帮助  0</span></li><li class="unlike"><i class="icon unlike-icon"></i> <span id="unlike_num">没帮助 0</span></li><li>文档反馈</li></ul></div></div></div><div class="col col--3" style="padding-left:0px"><div class="tableOfContents_k96L thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#获取你的设备树与生成的头文件" class="table-of-contents__link">获取你的设备树与生成的头文件</a></li><li><a href="#从设备树节点获取设备结构体struct-device" class="table-of-contents__link">从设备树节点获取设备结构体（<code>struct device</code>）</a></li><li><a href="#找到设备树绑定" class="table-of-contents__link">找到设备树绑定</a></li><li><a href="#设置设备树-overlay" class="table-of-contents__link">设置设备树 overlay</a></li><li><a href="#使用设备树-overlay" class="table-of-contents__link">使用设备树 overlay</a></li><li><a href="#使用设备树-api-编写设备驱动" class="table-of-contents__link">使用设备树 API 编写设备驱动</a><ul><li><a href="#方式-1通过实例编号创建设备" class="table-of-contents__link">方式 1：通过实例编号创建设备</a></li><li><a href="#方式-2通过节点标签创建设备" class="table-of-contents__link">方式 2：通过节点标签创建设备</a></li></ul></li><li><a href="#依赖其他设备的设备驱动" class="table-of-contents__link">依赖其他设备的设备驱动</a></li><li><a href="#依赖开发板特定设备的应用" class="table-of-contents__link">依赖开发板特定设备的应用</a></li></ul></div></div></div></div></main></div></div><footer class="footer"><div class="container"><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 安徽聆思智能科技有限公司皖ICP备05001217号</div></div></div></footer></div>
<script src="/docs-csk6/assets/js/runtime~main.e6d313ea.js"></script>
<script src="/docs-csk6/assets/js/main.68df80fb.js"></script>
<script>!function(e,n,s,t,d){e[s]=e[s]||function(){(e[s].a=e[s].a||[]).push(arguments)},(d=n.createElement("script")).async=!0,d.src="https://cdn.jsdelivr.net/simplemde/latest/simplemde.min.js",n.body.appendChild(d)}(window,document,"simplemde")</script></body>
</html>