<!doctype html>
<html lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.2">
<title data-react-helmet="true">引导程序 &amp; OTA | 聆思文档中心</title><meta data-react-helmet="true" property="og:url" content="https://github.com/LISTENAI/docs-csk6/chips/600X/old_doc/应用开发/基础/mcuboot"><meta data-react-helmet="true" name="docusaurus_locale" content="en"><meta data-react-helmet="true" name="docusaurus_version" content="current"><meta data-react-helmet="true" name="docusaurus_tag" content="docs-default-current"><meta data-react-helmet="true" property="og:title" content="引导程序 &amp; OTA | 聆思文档中心"><meta data-react-helmet="true" name="description" content="bootloader"><meta data-react-helmet="true" property="og:description" content="bootloader"><link data-react-helmet="true" rel="shortcut icon" href="/docs-csk6/img/favicon.ico"><link data-react-helmet="true" rel="canonical" href="https://github.com/LISTENAI/docs-csk6/chips/600X/old_doc/应用开发/基础/mcuboot"><link data-react-helmet="true" rel="alternate" href="https://github.com/LISTENAI/docs-csk6/chips/600X/old_doc/应用开发/基础/mcuboot" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://github.com/LISTENAI/docs-csk6/chips/600X/old_doc/应用开发/基础/mcuboot" hreflang="x-default"><link rel="stylesheet" href="/docs-csk6/assets/css/styles.e821b6b0.css">
<link rel="preload" href="/docs-csk6/assets/js/runtime~main.a1ada762.js" as="script">
<link rel="preload" href="/docs-csk6/assets/js/main.612aaa00.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div><a href="#main" class="skipToContent_vO2r">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" titleclassname="navbar__title" href="/docs-csk6/"><img src="/docs-csk6/img/logo_light.svg" alt="LSOpen Logo" class="themedImage_K3WP themedImage--light_Fy0T navbar__logo"><img src="/docs-csk6/img/logo_dark.svg" alt="LSOpen Logo" class="themedImage_K3WP themedImage--dark_V9oi navbar__logo"></a><a class="navbar__item navbar__link" href="/docs-csk6/chips/4002/Chip_information_4002">芯片</a><a class="navbar__item navbar__link" href="/docs-csk6/tools/LStudio">工具</a><a class="navbar__item navbar__link" href="/docs-csk6/AIsolution/ESR/Quick_start/Scheme_introduction">AI语音应用方案</a><a class="navbar__item navbar__link" href="/docs-csk6/Industrysolution/Scanning_pen/Scheme_introduction">行业Turnkey解决方案</a></div><div class="navbar__items navbar__items--right"><a class="navbar__item navbar__link" href="/docs-csk6/faq/faq">FAQ</a><a class="navbar__item navbar__link" href="/docs-csk6/school/school">视频课程</a><a class="navbar__item navbar__link" href="/docs-csk6/workorder/workorder">工单</a><div class="react-toggle displayOnlyInLargeViewport_a-w0 react-toggle--disabled"><div class="react-toggle-track" role="button" tabindex="-1"><div class="react-toggle-track-check"><span class="toggle_8pH0"><img src="/docs-csk6/img/light.svg" alt="" class="themedImage_K3WP themedImage--light_Fy0T"><img src="/docs-csk6/img/unlight.svg" alt="" class="themedImage_K3WP themedImage--dark_V9oi"></span></div><div class="react-toggle-track-x"><span class="toggle_8pH0"><img src="/docs-csk6/img/undark.svg" alt="" class="themedImage_K3WP themedImage--light_Fy0T"><img src="/docs-csk6/img/dark.svg" alt="" class="themedImage_K3WP themedImage--dark_V9oi"></span></div></div><input type="checkbox" class="react-toggle-screenreader-only" aria-label="Switch between dark and light mode"></div><div class="navbar__search searchBarContainer_I7kZ"><input placeholder="搜索" aria-label="Search" class="navbar__search-input"><div class="loadingRing_Zg7X searchBarLoadingRing_J5Ez"><div></div><div></div><div></div><div></div></div></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div><div class="navbar-sidebar"><div class="navbar-sidebar__brand"><a class="navbar__brand" titleclassname="navbar__title" href="/docs-csk6/"><img src="/docs-csk6/img/logo_light.svg" alt="LSOpen Logo" class="themedImage_K3WP themedImage--light_Fy0T navbar__logo"><img src="/docs-csk6/img/logo_dark.svg" alt="LSOpen Logo" class="themedImage_K3WP themedImage--dark_V9oi navbar__logo"></a></div><div class="navbar-sidebar__items"><div class="menu"><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" href="/docs-csk6/chips/4002/Chip_information_4002">芯片</a></li><li class="menu__list-item"><a class="menu__link" href="/docs-csk6/tools/LStudio">工具</a></li><li class="menu__list-item"><a class="menu__link" href="/docs-csk6/AIsolution/ESR/Quick_start/Scheme_introduction">AI语音应用方案</a></li><li class="menu__list-item"><a class="menu__link" href="/docs-csk6/Industrysolution/Scanning_pen/Scheme_introduction">行业Turnkey解决方案</a></li><li class="menu__list-item"><a class="menu__link" href="/docs-csk6/faq/faq">FAQ</a></li><li class="menu__list-item"><a class="menu__link" href="/docs-csk6/school/school">视频课程</a></li><li class="menu__list-item"><a class="menu__link" href="/docs-csk6/workorder/workorder">工单</a></li></ul></div></div></div></nav><nav class="navbar subnavbar--fixed-top sub-navbar"><div class="navbar__inner subnavbar__inner"><div class="navbar__items"><a class="subnavbar__item subnavbar__link" dirname="/chips" href="/docs-csk6/chips/4002/Chip_information_4002">CSK4002</a><a aria-current="page" class="subnavbar__item subnavbar__link subnavbar__link--active" dirname="/chips" href="/docs-csk6/chips/600X/overview/chips">CSK600X</a><a class="subnavbar__item subnavbar__link" dirname="/chips" href="/docs-csk6/chips/micropython/index">MicroPython</a></div></div></nav><div class="main-wrapper docs-wrapper doc-page"><div class="docPage_Ol8-"><main class="docMainContainer_dRYS docMainContainerEnhanced_EGxD"><div class="container padding-top--md padding-bottom--lg center-container"><div class="row"><div class="col docItemCol_+xOG"><div class="docItemContainer_c+5G"><article><div class="markdown"><header><h1 class="h1Heading_5RMM">引导程序 &amp; OTA</h1></header><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_k6ZT" id="bootloader"></a>bootloader<a class="hash-link" href="#bootloader" title="Direct link to heading">#</a></h2><p>bootloader是芯片上电后执行的第一段代码，主要用于引导和升级应用程序。</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_k6ZT" id="mcuboot"></a>mcuboot<a class="hash-link" href="#mcuboot" title="Direct link to heading">#</a></h2><p><a href="https://www.mcuboot.com/" target="_blank" rel="noopener noreferrer">mcuboot</a>是开源32bit Mcu
bootloader，直接兼容于zephyr，可以用来加载zephyr代码。</p><p>为了在Zephyr上使用mcuboot，需要依赖相关的条件。具体请参考<a href="https://docs.zephyrproject.org/latest/guides/device_mgmt/dfu.html?highlight=mcuboot#mcuboot" target="_blank" rel="noopener noreferrer">Mcuboot</a>和<a href="https://www.mcuboot.com/documentation/readme-zephyr/" target="_blank" rel="noopener noreferrer">Building
and using MCUboot with
Zephyr</a></p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_k6ZT" id="flash-map"></a>flash map<a class="hash-link" href="#flash-map" title="Direct link to heading">#</a></h3><p>mcuboot通过对flash分区进行操作来加载和升级Zephyr固件。<a href="https://docs.zephyrproject.org/2.6.0/reference/storage/flash_map/flash_map.html#flash-map" target="_blank" rel="noopener noreferrer">flash
map</a>提供了获取flash分区信息的API。flash分区与zephyr的设备树相关，举例如下：</p><div class="codeBlockContainer_9aag"><div class="codeBlockContent_0VPv default"><pre tabindex="0" class="prism-code language-default codeBlock_pSDi thin-scrollbar" style="color:#9CDCFE;background-color:#1E1E1E"><div class="codeBlockLines_sq2l"><span class="token-line" style="color:#9CDCFE"><span class="token plain">&amp;flash0 {</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        /*</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">         * For more information, see:</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">         * http: //docs.zephyrproject.org/latest/guides/dts/index.html#flash-partitions</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">         */</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        partitions {</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                compatible = &quot;fixed-partitions&quot;;</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                #address-cells = &lt;1&gt;;</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                #size-cells = &lt;1&gt;;</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                /* 256KB for bootloader */</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                boot_partition: partition@0 {</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                        label = &quot;mcuboot&quot;;</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                        reg = &lt;0x0 0x40000&gt;;</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                        read-only;</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                };</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                /* application image slot: 512KB */</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                slot0_partition: partition@40000 {</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                        label = &quot;image-0&quot;;</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                        reg = &lt;0x40000 0x80000&gt;;</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                };</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                /* backup slot: 512KB */</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                slot1_partition: partition@c0000 {</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                        label = &quot;image-1&quot;;</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                        reg = &lt;0xc0000 0x80000&gt;;</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                };</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                /* swap slot: 128KB */</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                scratch_partition: partition@140000 {</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                        label = &quot;image-scratch&quot;;</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                        reg = &lt;0x140000 0x20000&gt;;</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                };</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                /* storage: 6.625MB for storage */</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                storage_partition: partition@160000 {</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                        label = &quot;storage&quot;;</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                        reg = &lt;0x160000 0x6a0000&gt;;</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                };</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        };</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">};</span></span></div></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Q0gn clean-btn">Copy</button></div></div><p>其中<code>boot_partition</code>、<code>slot0_partition</code>、<code>slot1_partition</code>和<code>scratch_partition</code>是为了mcuboot定义的，<code>storage_partition</code>分区可用于存放文件系统等其他非易失存储。</p><p>flash分区示例图：</p><div class="codeBlockContainer_9aag"><div class="codeBlockContent_0VPv default"><pre tabindex="0" class="prism-code language-default codeBlock_pSDi thin-scrollbar" style="color:#9CDCFE;background-color:#1E1E1E"><div class="codeBlockLines_sq2l"><span class="token-line" style="color:#9CDCFE"><span class="token plain">+----------+----------+----------+----------+</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">|              boot_partition               |                用于烧录bootloader</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">+----------+----------+----------+----------+</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">|              slot0_partition              |                主分区APP0</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">+---------------------+---------------------+</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">|              slot1_partition              |                次分区APP1</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">+---------------------+---------------------+</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">|              scratch_partition            |        用来作为slot0和slot1的交换区</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">+---------------------+---------------------+</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">|              storage_partition            |                用来其他存储(如文件系统)</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">+---------------------+---------------------+</span></span></div></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Q0gn clean-btn">Copy</button></div></div><p>mcuboot被烧录到<code>boot_partition</code>分区，并且负责管理<code>slot0_partition</code>、<code>slot1_partition</code>和<code>scratch_partition</code>。芯片上电后，首先启动mcuboot，mcuboot校验<code>slot0_partition</code>和<code>slot1_partition</code>分区，并根选择其中一个启动。<code>slot0_partition</code>分区固定用于启动，<code>slot1_partition</code>分区固定用于升级。mcuboot支持通过uart、usb
cdc、usb dfu的方式进行升级，升级完成后，就开始启动APP固件。</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_k6ZT" id="生成mcuboot"></a>生成mcuboot<a class="hash-link" href="#生成mcuboot" title="Direct link to heading">#</a></h3><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_k6ZT" id="编译"></a>编译<a class="hash-link" href="#编译" title="Direct link to heading">#</a></h4><div class="codeBlockContainer_9aag"><div class="codeBlockContent_0VPv shell"><pre tabindex="0" class="prism-code language-shell codeBlock_pSDi thin-scrollbar" style="color:#9CDCFE;background-color:#1E1E1E"><div class="codeBlockLines_sq2l"><span class="token-line" style="color:#9CDCFE"><span class="token plain">west build -p</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain">auto -b csk6001_pico -d build_mcuboot bootloader</span><span class="token punctuation" style="color:rgb(212, 212, 212)">\</span><span class="token plain">mcuboot</span><span class="token punctuation" style="color:rgb(212, 212, 212)">\</span><span class="token plain">boot</span><span class="token punctuation" style="color:rgb(212, 212, 212)">\</span><span class="token plain">zephyr</span></span></div></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Q0gn clean-btn">Copy</button></div></div><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_k6ZT" id="烧录到boot分区"></a>烧录到boot分区<a class="hash-link" href="#烧录到boot分区" title="Direct link to heading">#</a></h4><div class="codeBlockContainer_9aag"><div class="codeBlockContent_0VPv shell"><pre tabindex="0" class="prism-code language-shell codeBlock_pSDi thin-scrollbar" style="color:#9CDCFE;background-color:#1E1E1E"><div class="codeBlockLines_sq2l"><span class="token-line" style="color:#9CDCFE"><span class="token comment" style="color:rgb(106, 153, 85)"># 烧录mcuboot到boot_partition分区(flash偏移位置0x0)</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">west flash -d build_mcuboot</span></span></div></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Q0gn clean-btn">Copy</button></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_k6ZT" id="生成app固件"></a>生成App固件<a class="hash-link" href="#生成app固件" title="Direct link to heading">#</a></h3><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_k6ZT" id="编译-1"></a>编译<a class="hash-link" href="#编译-1" title="Direct link to heading">#</a></h4><p>这里使用hello_world工程为例来生成App固件。因为App固件由mcuboot启动，需要在编译时需要配置<code>CONFIG_BOOTLOADER_MCUBOOT=y</code>。</p><div class="codeBlockContainer_9aag"><div class="codeBlockContent_0VPv shell"><pre tabindex="0" class="prism-code language-shell codeBlock_pSDi thin-scrollbar" style="color:#9CDCFE;background-color:#1E1E1E"><div class="codeBlockLines_sq2l"><span class="token-line" style="color:#9CDCFE"><span class="token comment" style="color:rgb(106, 153, 85)"># 编译生成App固件</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">west build -p</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain">auto -b csk6001_pico .</span><span class="token punctuation" style="color:rgb(212, 212, 212)">\</span><span class="token plain">zephyr</span><span class="token punctuation" style="color:rgb(212, 212, 212)">\</span><span class="token plain">samples</span><span class="token punctuation" style="color:rgb(212, 212, 212)">\</span><span class="token plain">hello_world -- -DCONFIG_BOOTLOADER_MCUBOOT</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain">y</span></span></div></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Q0gn clean-btn">Copy</button></div></div><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_k6ZT" id="签名"></a>签名<a class="hash-link" href="#签名" title="Direct link to heading">#</a></h4><p>mcuboot在启动App前会先对App进行校验，因此需要用密钥对App进行签名。注意App签名时用到的密钥要和mcuboot一致，否则mcuboot对App校验失败。mcuboot编译时通过<code>CONFIG_BOOT_SIGNATURE_KEY_FILE</code>来选择密钥，App签名也应用同一个密钥。密钥可由用户自定义生成，参考<a href="https://docs.mcuboot.com/readme-zephyr.html" target="_blank" rel="noopener noreferrer">Building
and using MCUboot with
Zephyr</a>，本例使用mcuboot默认自带的<code>root-rsa-2048.pem</code></p><div class="codeBlockContainer_9aag"><div class="codeBlockContent_0VPv shell"><pre tabindex="0" class="prism-code language-shell codeBlock_pSDi thin-scrollbar" style="color:#9CDCFE;background-color:#1E1E1E"><div class="codeBlockLines_sq2l"><span class="token-line" style="color:#9CDCFE"><span class="token comment" style="color:rgb(106, 153, 85)"># 使用.\bootloader\mcuboot\script\imgtool.py对.\build目录的App固件进行签名</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)"># 下面的两种方法任选一个</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)"># 简单使用方法</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">west sign -t imgtool -- --key bootloader</span><span class="token punctuation" style="color:rgb(212, 212, 212)">\</span><span class="token plain">mcuboot</span><span class="token punctuation" style="color:rgb(212, 212, 212)">\</span><span class="token plain">root-rsa-2048.pem</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)"># 展开使用方法</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)"># 注意：--slot-size为APP0所在的slot0_partitoin分区大小，对应上面flash map为0x80000</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">.</span><span class="token punctuation" style="color:rgb(212, 212, 212)">\</span><span class="token plain">bootloader</span><span class="token punctuation" style="color:rgb(212, 212, 212)">\</span><span class="token plain">mcuboot</span><span class="token punctuation" style="color:rgb(212, 212, 212)">\</span><span class="token plain">script</span><span class="token punctuation" style="color:rgb(212, 212, 212)">\</span><span class="token plain">imgtool.py sign </span><span class="token punctuation" style="color:rgb(212, 212, 212)">\</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        --key .</span><span class="token punctuation" style="color:rgb(212, 212, 212)">\</span><span class="token plain">bootloader</span><span class="token punctuation" style="color:rgb(212, 212, 212)">\</span><span class="token plain">mcuboot</span><span class="token punctuation" style="color:rgb(212, 212, 212)">\</span><span class="token plain">root-rsa-2048.pem </span><span class="token punctuation" style="color:rgb(212, 212, 212)">\</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        --header-size 0x200 </span><span class="token punctuation" style="color:rgb(212, 212, 212)">\</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        --align </span><span class="token number" style="color:rgb(181, 206, 168)">8</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">\</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        --version </span><span class="token number" style="color:rgb(181, 206, 168)">1.2</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">\</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        --slot-size 0x80000 </span><span class="token punctuation" style="color:rgb(212, 212, 212)">\</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        .</span><span class="token punctuation" style="color:rgb(212, 212, 212)">\</span><span class="token plain">build</span><span class="token punctuation" style="color:rgb(212, 212, 212)">\</span><span class="token plain">zephyr</span><span class="token punctuation" style="color:rgb(212, 212, 212)">\</span><span class="token plain">zephyr.bin </span><span class="token punctuation" style="color:rgb(212, 212, 212)">\</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        .</span><span class="token punctuation" style="color:rgb(212, 212, 212)">\</span><span class="token plain">build</span><span class="token punctuation" style="color:rgb(212, 212, 212)">\</span><span class="token plain">zephyr</span><span class="token punctuation" style="color:rgb(212, 212, 212)">\</span><span class="token plain">zephyr.signed.bin</span></span></div></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Q0gn clean-btn">Copy</button></div></div><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_k6ZT" id="烧录到slot0分区"></a>烧录到slot0分区<a class="hash-link" href="#烧录到slot0分区" title="Direct link to heading">#</a></h4><p>App固件需要烧录到<code>slot0_partition</code>分区，注意烧录时需指定烧录位置为<code>slot0_partition</code>分区的起始位置</p><div class="codeBlockContainer_9aag"><div class="codeBlockContent_0VPv shell"><pre tabindex="0" class="prism-code language-shell codeBlock_pSDi thin-scrollbar" style="color:#9CDCFE;background-color:#1E1E1E"><div class="codeBlockLines_sq2l"><span class="token-line" style="color:#9CDCFE"><span class="token comment" style="color:rgb(106, 153, 85)"># 烧录App到slot0_partition分区（flash偏移位置0x40000）</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">west flash --bin-file build</span><span class="token punctuation" style="color:rgb(212, 212, 212)">\</span><span class="token plain">zephyr</span><span class="token punctuation" style="color:rgb(212, 212, 212)">\</span><span class="token plain">zephyr.signed.bin</span></span></div></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Q0gn clean-btn">Copy</button></div></div><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_k6ZT" id="csk6001启动日志"></a>CSK6001启动日志<a class="hash-link" href="#csk6001启动日志" title="Direct link to heading">#</a></h4><p>csk6001启动日志如下，可以看到mcuboot已经启动了App固件</p><div class="codeBlockContainer_9aag"><div class="codeBlockContent_0VPv default"><pre tabindex="0" class="prism-code language-default codeBlock_pSDi thin-scrollbar" style="color:#9CDCFE;background-color:#1E1E1E"><div class="codeBlockLines_sq2l"><span class="token-line" style="color:#9CDCFE"><span class="token plain">*** Booting Zephyr OS build 3c2037394676  ***</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">I: Starting bootloader</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">I: Primary image: magic=unset, swap_type=0x1, copy_done=0x3, image_ok=0x3</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">I: Scratch: magic=unset, swap_type=0x1, copy_done=0x3, image_ok=0x3</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">I: Boot source: primary slot</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">I: Swap type: none</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">I: Bootloader chainload address offset: 0x40000</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">I: Jumping to the first image slot</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">*** Booting Zephyr OS build 3c2037394676  ***</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">Hello World! csk6001</span></span></div></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Q0gn clean-btn">Copy</button></div></div><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_k6ZT" id="dfudevice-firmware-upgrade"></a>DFU(Device Firmware Upgrade)<a class="hash-link" href="#dfudevice-firmware-upgrade" title="Direct link to heading">#</a></h2><p>Zephyr使用<a href="https://docs.zephyrproject.org/latest/guides/device_mgmt/dfu.html?highlight=mcuboot#device-firmware-upgrade" target="_blank" rel="noopener noreferrer">Device Firmware
Upgrade</a>框架来管理固件，使用<a href="https://docs.zephyrproject.org/latest/guides/device_mgmt/index.html#device-management" target="_blank" rel="noopener noreferrer">Device
Management</a>来管理升级固件的传输和相关传输协议。即DFU子系统不负责固件的传输，只负责固件的管理。DFU和Device
Management共同配合完成固件的升级和管理。</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_k6ZT" id="device-management"></a>Device Management<a class="hash-link" href="#device-management" title="Direct link to heading">#</a></h2><p>Device
Management包含<a href="https://docs.zephyrproject.org/latest/guides/device_mgmt/mcumgr.html#mcumgr" target="_blank" rel="noopener noreferrer">MCUmgr</a>、<a href="https://docs.zephyrproject.org/latest/samples/subsys/usb/dfu/README.html#usb-dfu-sample-application" target="_blank" rel="noopener noreferrer">usb
dfu</a>、<a href="https://docs.zephyrproject.org/latest/samples/subsys/mgmt/hawkbit/README.html#hawkbit-direct-device-integration-api-sample" target="_blank" rel="noopener noreferrer">Hawkbit</a>、<a href="https://docs.zephyrproject.org/latest/samples/subsys/mgmt/updatehub/README.html#updatehub-embedded-firmware-over-the-air-fota-sample" target="_blank" rel="noopener noreferrer">Updatehub</a>、<a href="https://docs.zephyrproject.org/latest/samples/subsys/mgmt/osdp/README.html" target="_blank" rel="noopener noreferrer">OSDP</a>等升级方式，接口涵盖uart、usb、eth、wifi、ble等。<a href="https://docs.zephyrproject.org/latest/samples/subsys/mgmt/mgmt.html" target="_blank" rel="noopener noreferrer">Management
Samples</a>给出了上面的示例。</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_k6ZT" id="usb-dfu"></a>USB DFU<a class="hash-link" href="#usb-dfu" title="Direct link to heading">#</a></h2><p>usb dfu是zephyr Device
Management的一种，此方案可通过usb接口完成对固件升级和备份。<a href="https://docs.zephyrproject.org/latest/samples/subsys/usb/dfu/README.html#usb-dfu-sample-application" target="_blank" rel="noopener noreferrer">USB DFU
Sample
Application</a>演示了通过APP进行USB
DFU升级的流程。</p><p>下面给出一个通过mcuboot进行USB DFU升级固件的例子。</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_k6ZT" id="mcuboot的usb-dfu的升级"></a>mcuboot的usb dfu的升级<a class="hash-link" href="#mcuboot的usb-dfu的升级" title="Direct link to heading">#</a></h2><p>因为mcuboot具有升级功能，可通过uart、uart cdc、usb
dfu进行升级。这里使用mcuboot的usb dfu功能进行升级。mcuboot的usb
dfu升级可以使用gpio引脚触发；也可以上电等待一段时间，如果上位机没升级操作，就开始引导app。本例使用上电等待的方法来演示。</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_k6ZT" id="生成mcuboot-1"></a>生成mcuboot<a class="hash-link" href="#生成mcuboot-1" title="Direct link to heading">#</a></h3><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_k6ZT" id="添加csk6001_picoconf"></a>添加csk6001_pico.conf<a class="hash-link" href="#添加csk6001_picoconf" title="Direct link to heading">#</a></h4><p>需要在bootloadermcubootbootzephyrboards目录下添加csk6001_pico.conf文件，内容如下</p><div class="codeBlockContainer_9aag"><div class="codeBlockContent_0VPv default"><pre tabindex="0" class="prism-code language-default codeBlock_pSDi thin-scrollbar" style="color:#9CDCFE;background-color:#1E1E1E"><div class="codeBlockLines_sq2l"><span class="token-line" style="color:#9CDCFE"><span class="token plain">CONFIG_BOOT_USB_DFU_WAIT=y</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">CONFIG_BOOT_USB_DFU_WAIT_DELAY_MS=10000                      #等待10s</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">CONFIG_IMG_BLOCK_BUF_SIZE=4096</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">CONFIG_USB_REQUEST_BUFFER_SIZE=4096                          #usb每次传输4096</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">CONFIG_SYSTEM_WORKQUEUE_STACK_SIZE=4096</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">CONFIG_USB_DFU_DEFAULT_POLLTIMEOUT=1</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">CONFIG_USB_DEVICE_LOG_LEVEL_ERR=y</span></span></div></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Q0gn clean-btn">Copy</button></div></div><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_k6ZT" id="编译和烧录"></a>编译和烧录<a class="hash-link" href="#编译和烧录" title="Direct link to heading">#</a></h4><h5><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_k6ZT" id="编译-2"></a>编译<a class="hash-link" href="#编译-2" title="Direct link to heading">#</a></h5><div class="codeBlockContainer_9aag"><div class="codeBlockContent_0VPv shell"><pre tabindex="0" class="prism-code language-shell codeBlock_pSDi thin-scrollbar" style="color:#9CDCFE;background-color:#1E1E1E"><div class="codeBlockLines_sq2l"><span class="token-line" style="color:#9CDCFE"><span class="token plain">west build -p</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain">auto -b csk6001_pico -d build_mcuboot bootloader</span><span class="token punctuation" style="color:rgb(212, 212, 212)">\</span><span class="token plain">mcuboot</span><span class="token punctuation" style="color:rgb(212, 212, 212)">\</span><span class="token plain">boot</span><span class="token punctuation" style="color:rgb(212, 212, 212)">\</span><span class="token plain">zephyr</span></span></div></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Q0gn clean-btn">Copy</button></div></div><h5><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_k6ZT" id="烧录到boot分区-1"></a>烧录到boot分区<a class="hash-link" href="#烧录到boot分区-1" title="Direct link to heading">#</a></h5><div class="codeBlockContainer_9aag"><div class="codeBlockContent_0VPv shell"><pre tabindex="0" class="prism-code language-shell codeBlock_pSDi thin-scrollbar" style="color:#9CDCFE;background-color:#1E1E1E"><div class="codeBlockLines_sq2l"><span class="token-line" style="color:#9CDCFE"><span class="token comment" style="color:rgb(106, 153, 85)"># 烧录mcuboot到boot_partition分区(flash偏移位置0x0)</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">west flash -d build_mcuboot</span></span></div></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Q0gn clean-btn">Copy</button></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_k6ZT" id="生成升级固件"></a>生成升级固件<a class="hash-link" href="#生成升级固件" title="Direct link to heading">#</a></h3><p>升级固件被下载到设备后，也要被mcuboot引导。因此升级固件同样需要配置<code>CONFIG_BOOTLOADER_MCUBOOT=y</code>，并需要进行签名。</p><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_k6ZT" id="编译-3"></a>编译<a class="hash-link" href="#编译-3" title="Direct link to heading">#</a></h4><p>这里仍旧使用hello_world作为升级固件，注意需要添加配置<code>CONFIG_BOOTLOADER_MCUBOOT=y</code></p><div class="codeBlockContainer_9aag"><div class="codeBlockContent_0VPv shell"><pre tabindex="0" class="prism-code language-shell codeBlock_pSDi thin-scrollbar" style="color:#9CDCFE;background-color:#1E1E1E"><div class="codeBlockLines_sq2l"><span class="token-line" style="color:#9CDCFE"><span class="token comment" style="color:rgb(106, 153, 85)"># 编译生成升级固件</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">west build -p</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain">auto -b csk6001_pico .</span><span class="token punctuation" style="color:rgb(212, 212, 212)">\</span><span class="token plain">zephyr</span><span class="token punctuation" style="color:rgb(212, 212, 212)">\</span><span class="token plain">samples</span><span class="token punctuation" style="color:rgb(212, 212, 212)">\</span><span class="token plain">hello-world -- -DCONFIG_BOOTLOADER_MCUBOOT</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain">y</span></span></div></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Q0gn clean-btn">Copy</button></div></div><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_k6ZT" id="签名-1"></a>签名<a class="hash-link" href="#签名-1" title="Direct link to heading">#</a></h4><div class="codeBlockContainer_9aag"><div class="codeBlockContent_0VPv shell"><pre tabindex="0" class="prism-code language-shell codeBlock_pSDi thin-scrollbar" style="color:#9CDCFE;background-color:#1E1E1E"><div class="codeBlockLines_sq2l"><span class="token-line" style="color:#9CDCFE"><span class="token comment" style="color:rgb(106, 153, 85)"># 对升级固件进行签名</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">west sign -t imgtool -- --key bootloader</span><span class="token punctuation" style="color:rgb(212, 212, 212)">\</span><span class="token plain">mcuboot</span><span class="token punctuation" style="color:rgb(212, 212, 212)">\</span><span class="token plain">root-rsa-2048.pem</span></span></div></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Q0gn clean-btn">Copy</button></div></div><p>生成的.buildzephyrzepyr.signed.bin重命名成signed-hello.bin，用于PC端下载使用</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_k6ZT" id="测试"></a>测试<a class="hash-link" href="#测试" title="Direct link to heading">#</a></h3><p>PC端使用<a href="http://dfu-util.sourceforge.net/" target="_blank" rel="noopener noreferrer">dfu-util</a>软件来控制dfu设备进行固件升级和备份。</p><ul><li>linux上一般自带dfu-util，如果没有可通过包管理软件进行安装，如ubuntu、debian可以使用sudo
apt-get install dfu-util安装。</li></ul><ul><li>windows端测试需要先安装驱动，驱动安装见<a href="https://lexiangla.com/docs/d9cc0f3c58f411ec9e9bc2d4bb7d7c8f?company_from=246da8589c0811ea9d995254002f1020" target="_blank" rel="noopener noreferrer">Windows进行DFU升级步骤</a></li></ul><ul><li>mac端暂未测试。</li></ul><p>下面例子是在linux系统下进行的测试</p><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_k6ZT" id="查看dfu设备"></a>查看dfu设备<a class="hash-link" href="#查看dfu设备" title="Direct link to heading">#</a></h4><div class="codeBlockContainer_9aag"><div class="codeBlockContent_0VPv shell"><pre tabindex="0" class="prism-code language-shell codeBlock_pSDi thin-scrollbar" style="color:#9CDCFE;background-color:#1E1E1E"><div class="codeBlockLines_sq2l"><span class="token-line" style="color:#9CDCFE"><span class="token comment" style="color:rgb(106, 153, 85)"># 查看当前连接的PC的dfu设备</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">$</span><span class="token operator" style="color:rgb(212, 212, 212)">&gt;</span><span class="token plain"> </span><span class="token function" style="color:rgb(220, 220, 170)">sudo</span><span class="token plain"> dfu-util --list</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">dfu-util </span><span class="token number" style="color:rgb(181, 206, 168)">0.11</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">Copyright </span><span class="token number" style="color:rgb(181, 206, 168)">2005</span><span class="token plain">-2009 Weston Schmidt, Harald Welte and OpenMoko Inc.</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">Copyright </span><span class="token number" style="color:rgb(181, 206, 168)">2010</span><span class="token plain">-2021 Tormod Volden and Stefan Schmidt</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">This program is Free Software and has ABSOLUTELY NO WARRANTY</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">Please report bugs to http://sourceforge.net/p/dfu-util/tickets/</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">Found Runtime: </span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">2fe3:0005</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"> </span><span class="token assign-left variable" style="color:rgb(156, 220, 254)">ver</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain">0207, </span><span class="token assign-left variable" style="color:rgb(156, 220, 254)">devnum</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token number" style="color:rgb(181, 206, 168)">36</span><span class="token plain">, </span><span class="token assign-left variable" style="color:rgb(156, 220, 254)">cfg</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token number" style="color:rgb(181, 206, 168)">1</span><span class="token plain">, </span><span class="token assign-left variable" style="color:rgb(156, 220, 254)">intf</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token number" style="color:rgb(181, 206, 168)">0</span><span class="token plain">, </span><span class="token assign-left variable" style="color:rgb(156, 220, 254)">path</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;1-3.3.2&quot;</span><span class="token plain">, </span><span class="token assign-left variable" style="color:rgb(156, 220, 254)">alt</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token number" style="color:rgb(181, 206, 168)">0</span><span class="token plain">, </span><span class="token assign-left variable" style="color:rgb(156, 220, 254)">name</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;UNKNOWN&quot;</span><span class="token plain">, </span><span class="token assign-left variable" style="color:rgb(156, 220, 254)">serial</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;0123456789ABCDEF&quot;</span></span></div></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Q0gn clean-btn">Copy</button></div></div><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_k6ZT" id="下载升级固件到slot1分区"></a>下载升级固件到slot1分区<a class="hash-link" href="#下载升级固件到slot1分区" title="Direct link to heading">#</a></h4><div class="codeBlockContainer_9aag"><div class="codeBlockContent_0VPv shell"><pre tabindex="0" class="prism-code language-shell codeBlock_pSDi thin-scrollbar" style="color:#9CDCFE;background-color:#1E1E1E"><div class="codeBlockLines_sq2l"><span class="token-line" style="color:#9CDCFE"><span class="token comment" style="color:rgb(106, 153, 85)"># 下载升级固件signed-hello.bin到slot1_partition分区</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">$</span><span class="token operator" style="color:rgb(212, 212, 212)">&gt;</span><span class="token plain"> </span><span class="token function" style="color:rgb(220, 220, 170)">sudo</span><span class="token plain"> dfu-util --alt </span><span class="token number" style="color:rgb(181, 206, 168)">1</span><span class="token plain"> --download signed-hello.bin</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">dfu-util </span><span class="token number" style="color:rgb(181, 206, 168)">0.11</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">Copyright </span><span class="token number" style="color:rgb(181, 206, 168)">2005</span><span class="token plain">-2009 Weston Schmidt, Harald Welte and OpenMoko Inc.</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">Copyright </span><span class="token number" style="color:rgb(181, 206, 168)">2010</span><span class="token plain">-2021 Tormod Volden and Stefan Schmidt</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">This program is Free Software and has ABSOLUTELY NO WARRANTY</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">Please report bugs to http://sourceforge.net/p/dfu-util/tickets/</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">Warning: Invalid DFU suffix signature</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">A valid DFU suffix will be required </span><span class="token keyword" style="color:rgb(86, 156, 214)">in</span><span class="token plain"> a future dfu-util release</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">Opening DFU capable USB device</span><span class="token punctuation" style="color:rgb(212, 212, 212)">..</span><span class="token plain">.</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">Device ID 2fe3:0005</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">Device DFU version 0110</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">Claiming USB DFU </span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">Run-Time</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> Interface</span><span class="token punctuation" style="color:rgb(212, 212, 212)">..</span><span class="token plain">.</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">Setting Alternate Interface zero</span><span class="token punctuation" style="color:rgb(212, 212, 212)">..</span><span class="token plain">.</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">Determining device status</span><span class="token punctuation" style="color:rgb(212, 212, 212)">..</span><span class="token plain">.</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">DFU state</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token number" style="color:rgb(181, 206, 168)">0</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> appIDLE, status</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token number" style="color:rgb(181, 206, 168)">0</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> No error condition is present</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">Device really </span><span class="token keyword" style="color:rgb(86, 156, 214)">in</span><span class="token plain"> Run-Time Mode, send DFU detach request</span><span class="token punctuation" style="color:rgb(212, 212, 212)">..</span><span class="token plain">.</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">Resetting USB</span><span class="token punctuation" style="color:rgb(212, 212, 212)">..</span><span class="token plain">.</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">Opening DFU USB Device</span><span class="token punctuation" style="color:rgb(212, 212, 212)">..</span><span class="token plain">.</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">Claiming USB DFU Interface</span><span class="token punctuation" style="color:rgb(212, 212, 212)">..</span><span class="token plain">.</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">Setting Alternate Interface </span><span class="token comment" style="color:rgb(106, 153, 85)">#1 ...</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">Determining device status</span><span class="token punctuation" style="color:rgb(212, 212, 212)">..</span><span class="token plain">.</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">DFU state</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token number" style="color:rgb(181, 206, 168)">2</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> dfuIDLE, status</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token number" style="color:rgb(181, 206, 168)">0</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> No error condition is present</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">DFU mode device DFU version 0110</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">Device returned transfer size </span><span class="token number" style="color:rgb(181, 206, 168)">4096</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">Copying data from PC to DFU device</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">Download        </span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token operator" style="color:rgb(212, 212, 212)">==</span><span class="token operator" style="color:rgb(212, 212, 212)">==</span><span class="token operator" style="color:rgb(212, 212, 212)">==</span><span class="token operator" style="color:rgb(212, 212, 212)">==</span><span class="token operator" style="color:rgb(212, 212, 212)">==</span><span class="token operator" style="color:rgb(212, 212, 212)">==</span><span class="token operator" style="color:rgb(212, 212, 212)">==</span><span class="token operator" style="color:rgb(212, 212, 212)">==</span><span class="token operator" style="color:rgb(212, 212, 212)">==</span><span class="token operator" style="color:rgb(212, 212, 212)">==</span><span class="token operator" style="color:rgb(212, 212, 212)">==</span><span class="token operator" style="color:rgb(212, 212, 212)">==</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">100</span><span class="token plain">%        </span><span class="token number" style="color:rgb(181, 206, 168)">51492</span><span class="token plain"> bytes</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">Download done.</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">DFU state</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token number" style="color:rgb(181, 206, 168)">4</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> dfuDNBUSY, status</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token number" style="color:rgb(181, 206, 168)">0</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> No error condition is present</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">Done</span><span class="token operator" style="color:rgb(212, 212, 212)">!</span></span></div></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Q0gn clean-btn">Copy</button></div></div><p>usb
dfu仅负责上传flash数据到PC端或者接收PC端数据并烧录到flash，不负责复位芯片。因此这里下载完后用户需要自己复位或重新上电。</p><p>下载后第一次启动，mcuboot就会校验<code>slot0_partition</code>和<code>slot1_partition</code>分区，然后把<code>slot0_partition</code>和<code>slot1_partition</code>分区进行交换，并启动<code>slot0_partition</code>分区，即启动下载的固件。</p><div class="codeBlockContainer_9aag"><div class="codeBlockContent_0VPv default"><pre tabindex="0" class="prism-code language-default codeBlock_pSDi thin-scrollbar" style="color:#9CDCFE;background-color:#1E1E1E"><div class="codeBlockLines_sq2l"><span class="token-line" style="color:#9CDCFE"><span class="token plain">*** Booting Zephyr OS build 3c2037394676  ***</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">I: Starting bootloader</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">I: Primary image: magic=unset, swap_type=0x1, copy_done=0x3, image_ok=0x3</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">I: Scratch: magic=unset, swap_type=0x1, copy_done=0x3, image_ok=0x3</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">I: Boot source: primary slot</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">I: Swap type: test</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">I: Bootloader chainload address offset: 0x40000</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">I: Jumping to the first image slot</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">*** Booting Zephyr OS build 3c2037394676  ***</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">Hello World! csk6001</span></span></div></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Q0gn clean-btn">Copy</button></div></div><p>此升级固件只运行一次，第二次重启时，会继续交换<code>slot0_partition</code>和<code>slot1_partition</code>分区，并启动原本的<code>slot0_partition</code>分区固件。</p><p>如果想让升级固件永久被执行，需要在签名的时候增加<code>--confirm</code>配置。</p><div class="codeBlockContainer_9aag"><div class="codeBlockContent_0VPv shell"><pre tabindex="0" class="prism-code language-shell codeBlock_pSDi thin-scrollbar" style="color:#9CDCFE;background-color:#1E1E1E"><div class="codeBlockLines_sq2l"><span class="token-line" style="color:#9CDCFE"><span class="token plain">west sign -t imgtool -- --confirm --key bootloader</span><span class="token punctuation" style="color:rgb(212, 212, 212)">\</span><span class="token plain">mcuboot</span><span class="token punctuation" style="color:rgb(212, 212, 212)">\</span><span class="token plain">root-rsa-2048.pem</span></span></div></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Q0gn clean-btn">Copy</button></div></div></div></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><div class="pagination-nav__item"></div><div class="pagination-nav__item pagination-nav__item--next"></div></nav><div class="gitalk-wrapper"><ul class="gitalk-option"><li class="like"><i class="icon like-icon"></i> <span id="like_num">有帮助  0</span></li><li class="unlike"><i class="icon unlike-icon"></i> <span id="unlike_num">没帮助 0</span></li><li>文档反馈</li></ul></div></div></div><div class="col col--3" style="padding-left:0px"><div class="tableOfContents_k96L thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#bootloader" class="table-of-contents__link">bootloader</a></li><li><a href="#mcuboot" class="table-of-contents__link">mcuboot</a><ul><li><a href="#flash-map" class="table-of-contents__link">flash map</a></li><li><a href="#生成mcuboot" class="table-of-contents__link">生成mcuboot</a></li><li><a href="#生成app固件" class="table-of-contents__link">生成App固件</a></li></ul></li><li><a href="#dfudevice-firmware-upgrade" class="table-of-contents__link">DFU(Device Firmware Upgrade)</a></li><li><a href="#device-management" class="table-of-contents__link">Device Management</a></li><li><a href="#usb-dfu" class="table-of-contents__link">USB DFU</a></li><li><a href="#mcuboot的usb-dfu的升级" class="table-of-contents__link">mcuboot的usb dfu的升级</a><ul><li><a href="#生成mcuboot-1" class="table-of-contents__link">生成mcuboot</a></li><li><a href="#生成升级固件" class="table-of-contents__link">生成升级固件</a></li><li><a href="#测试" class="table-of-contents__link">测试</a></li></ul></li></ul></div></div></div></div></main></div></div><footer class="footer"><div class="container"><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 安徽聆思智能科技有限公司皖ICP备05001217号</div></div></div></footer></div>
<script src="/docs-csk6/assets/js/runtime~main.a1ada762.js"></script>
<script src="/docs-csk6/assets/js/main.612aaa00.js"></script>
<script>!function(e,n,s,t,d){e[s]=e[s]||function(){(e[s].a=e[s].a||[]).push(arguments)},(d=n.createElement("script")).async=!0,d.src="https://cdn.jsdelivr.net/simplemde/latest/simplemde.min.js",n.body.appendChild(d)}(window,document,"simplemde")</script></body>
</html>